---
title: "EAT-Lancet Planetary Health diet demand"
author: "Marcus J Thomson"
date: "5/24/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(cowplot)
library(scales)
```

## Introduction

In this document, I find the (healthy) metabolic food energy requirement (in kcal/day) for the global population from the present to 2100 based on five shared socioeconomic pathways (SSPs). I assuming that education-level, as given in the SSP data, is a good proxy for level of activity required in a healthy diet, with the poorly educated being more likely to do manual labour and therefore requiring relatively greater dietary energy. I show that estimates based on uniformly "moderate" activity level under-estimates the necessary kcal quantity in the near term for all SSPs, and over-estimates it in the long term for SSP1, 2, and 4. For SSP3 and 5, the uniformly "moderate" assumption under-estimates over the entire time-series.

## Daily Energy Requirement (DER)

### Population

Population data from the SSP database at IIASA. Reference: [Keywan Riahi, et al. (2017). The Shared Socioeconomic Pathways and their energy, land use, and greenhouse gas emissions implications: An overview, Global Environmental Change, Volume 42, Pages 153-168, ISSN 0959-3780, DOI:110.1016/j.gloenvcha.2016.05.009](https://secure.iiasa.ac.at/web-apps/ene/SspDb/dsd?Action=htmlpage&page=10)

Set path to your Data folder
```{r}
ssp_path <- "/home/thomson/Data/SSPs/"
data_path <- "/home/thomson/Projects/iep_food/data/"
```


```{r}
ssp_base <- read.csv(file = paste0(ssp_path, 
                                   "SspDb_country_data_2013-06-12.csv"), 
                     header = TRUE, 
                     stringsAsFactors = FALSE)
```


At this stage, I am only interested in pulling the data for total female and male populations in each age bracket. Later, I include education level.

```{r, echo=FALSE}

for(i in seq(0, 100, by = 5)){
  tmp1 <- paste0("Population|Female|Aged", i, "-", i+4)
  tmp2 <- paste0("Population|Male|Aged", i, "-", i+4)
  
  #unless age bracket is 100+
  if(i==100){
    tmp1 <- "Population|Female|Aged100+"
    tmp2 <- "Population|Male|Aged100+"
  }
  
  if(i==0){ 
    female_pop <- tmp1
    male_pop   <- tmp2
  }
  if(i >0){
    female_pop <- c(female_pop, tmp1)
    male_pop   <- c(male_pop, tmp2)
  }
}

age_map <- rbind(tibble(VARIABLE = female_pop, 
                        gender = "female", 
                        min_age = seq(0, 100, by = 5), 
                        max_age = seq(4, 104, by = 5)), 
                 tibble(VARIABLE = male_pop, 
                        gender = "male", 
                        min_age = seq(0, 100, by = 5), 
                        max_age = seq(4, 104, by = 5)))

ssp_world <- ssp_base %>% 
  # filter(REGION == "USA") %>%  
  filter(VARIABLE %in% female_pop | 
         VARIABLE %in% male_pop) %>% 
  left_join(., age_map, by = "VARIABLE") %>% 
  # filter(SCENARIO == "SSP2_v9_130115") %>% 
  arrange(min_age)

ssp_world_long <- ssp_world %>% 
  dplyr::select(-VARIABLE, -UNIT) %>% 
  pivot_longer(cols = starts_with("X"), 
               names_to = "year", 
               names_prefix = "X", 
               values_to = "millions") %>% 
  mutate(year = as.numeric(year)) %>% 
  na.omit()

```

Visualize intermediate results.

```{r}

p0 <- ggplot(data = ssp_world_long %>% 
         group_by(year, SCENARIO, gender) %>% 
         summarize(pop_tot = sum(millions), .groups = "drop"), 
       aes(x = year, y = pop_tot)) + 
  geom_area(aes(fill = gender), 
            alpha = 0.7) + 
  labs(
    title = "World population by SSP", 
    subtitle = "Data: IIASA SSP database", 
    x = "Year", 
    y = "Million persons"
  ) + 
  theme_minimal() + 
  theme(
    legend.position = "top", 
    axis.text.x = element_text(angle = 90)
  ) + 
  facet_wrap(~SCENARIO, 
             nrow = 1, 
             labeller = as_labeller(
               c("SSP1_v9_130115" = "SSP1", 
                 "SSP2_v9_130115" = "SSP2",
                 "SSP3_v9_130115" = "SSP3",
                 "SSP4d_v9_130115"= "SSP4",
                 "SSP5_v9_130115" = "SSP5")))

# output_path <- "/home/thomson/Projects/iep_food/IEP_food_demand_files/"

# if(!exists(ssp_world_long)) {
#   save(ssp_world_long, file = paste0(output_path, "ssp_world_long.Rdata"))
# }

p0
```


## Metabolic energy requirements

I use the SSP population cohorts to make a bottom-up calculation of DER, based on healthy DER from the FAO. Source: Daily energy requirements for humans from the FAO: [Joint, F.A.O. (2004). Human energy requirements. Report of a Joint FAO/WHO/UNU Expert Consultation, Rome, 17-24 October 2001.](http://www.fao.org/3/y5686e/y5686e00.htm).

If necesary, load SSP population data frame wrangled earlier.
```{r}
output_path <- "/home/thomson/Projects/iep_food/IEP_food_demand_files/"
load(file = paste0(output_path, "ssp_world_long.Rdata"))
```

Daily energy requirements (MJ/day and kcal/day) for children (1-17.9 years old) and adults (18+ yrs old) differ by age range, gender, body mass, and activity level. Data from FAO/WHO/UNU (2004) were compiled into a clean CSV `der_harmonized`. In summary:

* For adults, there are: 
  + three age ranges (i.e., 18-29.9, 30-59.9, and 60 plus years); 
  + ten different body mass groups (i.e., 45 to 90 kg in 5 kg increments); and 
  + six different activity levels (i.e., 1.45, 1.60, 1.75, 1.90, 2.05, and 2.20 times BMR). 
* For children, there are: 
  + seventeen age ranges (i.e., 1-2 to 17-18 by yearly increments); 
  + three activity level groups (i.e., "light", "moderate", and "heavy"); and 
  + thirty-four body mass groups (i.e., 17 for females from 10.8 to 56.7 kg, and 17 for males from 11.5 to 67.8 kg).
  
Source: [FAO/WHO/UNU. (2004). Human Energy Requirements: Report of a Joint FAO/WHO/UNU Expert Consultation: Rome, 17-24 October 2001. Food & Agriculture Org.](https://www.fao.org/3/y5686e/y5686e00.htm)
```{r}
der_harmonized <- readr::read_csv(
  file = paste0(
    data_path,
    "Daily Energy Requirements for Humans - smoothed_harmonized_der.csv"
  ),
  col_types = cols(
    age_min = col_double(),
    age_max = col_double(),
    age_ave = col_double(),
    gender = col_character(),
    activity_level = col_character(),
    der_data = col_double(),
    der_interp = col_double()
  )
)
```

```{r}
# 
# der_child <- readr::read_csv(
#   paste0(data_path,
#          "FAO_Human_Daily_Energy_Children.csv"),
#   col_types = cols(
#     Age_range = col_character(),
#     Age_min = col_double(),
#     Age_max = col_double(),
#     Gender = col_character(),
#     Body_mass_kg = col_double(),
#     Activity_level = col_character(),
#     Daily_energy_req_megajoule_per_day = col_double(),
#     Daily_energy_req_kilocal_per_day = col_double()
#   )
# )
# 
# der_adult <- readr::read_csv(
#   paste0(data_path,
#          "FAO_Human_Daily_Energy_Adults.csv"),
#   col_types = cols(
#     Age_range = col_character(),
#     Age_min = col_double(),
#     Age_max = col_double(),
#     Gender = col_character(),
#     Body_mass_kg = col_double(),
#     Activity_level = col_character(),
#     Daily_energy_req_megajoule_per_day = col_double(),
#     Daily_energy_req_kilocal_per_day = col_double()
#   )
# )
```

<!-- Before joining to the SSP data, the DER data will need to be aggregated: the `der_child` data set will be expanded to generate rows for each distinct age, gender, and activity level group; and the expanded `der_child` and `der_adult` data sets will need to be harmonized. -->

<!-- ```{r} -->
<!-- av_der_child <- der_child %>%  -->
<!--   tidyr::drop_na() %>%  -->
<!--   dplyr::select( -->
<!--     Age_min,  -->
<!--     Age_max,  -->
<!--     Gender,  -->
<!--     Body_mass_kg,  -->
<!--     Activity_level,  -->
<!--     Daily_energy_req_kilocal_per_day) %>%  -->
<!--   dplyr::group_by( -->
<!--     Age_min,  -->
<!--     Age_max,  -->
<!--     Gender,  -->
<!--     Activity_level) %>%  -->
<!--   dplyr::summarise( -->
<!--     av_body_mass = mean(Body_mass_kg,  -->
<!--                         na.rm = TRUE),  -->
<!--     av_kcalPerDay = mean(Daily_energy_req_kilocal_per_day,  -->
<!--                          na.rm = TRUE),  -->
<!--     .groups = "drop") %>%  -->
<!--   dplyr::ungroup() %>%  -->
<!--   dplyr::mutate(Activity_level = ifelse(Activity_level == "heavy",  -->
<!--                                         "high_moderate",  -->
<!--                                         Activity_level)) -->

<!-- head(av_der_child) -->

<!-- ``` -->

<!-- Aggregate `der_adult` into three activity level categories, with 1.45 and 1.60 times BMR coded as "light", 1.75 and 1.90 times as "moderate", and 2.05 times as "high-moderate" (2.20 times for "heavy" will be excluded because it is a recommendation for elite athletes); and average DER by age, gender and activity level groups. -->

<!-- ```{r} -->
<!-- av_der_adult <- der_adult %>% -->
<!--   dplyr::select( -->
<!--     Age_min, -->
<!--     Age_max, -->
<!--     Gender, -->
<!--     Body_mass_kg, -->
<!--     Activity_level, -->
<!--     Daily_energy_req_kilocal_per_day -->
<!--   ) %>% -->
<!--   dplyr::group_by(Age_min, -->
<!--                   Age_max, -->
<!--                   Gender, -->
<!--                   Activity_level) %>% -->
<!--   dplyr::summarise( -->
<!--     av_body_mass = mean(Body_mass_kg, -->
<!--                         na.rm = TRUE), -->
<!--     av_kcalPerDay = mean(Daily_energy_req_kilocal_per_day, -->
<!--                          na.rm = TRUE), -->
<!--     .groups = "drop" -->
<!--   ) %>% -->
<!--   dplyr::ungroup() %>% -->
<!--   dplyr::mutate(Activity_level = ifelse( -->
<!--     Activity_level %in% c("1.45 × BMR", "1.60 × BMR"), -->
<!--     "light", -->
<!--     ifelse( -->
<!--       Activity_level %in% c("1.75 × BMR", "1.90 × BMR"), -->
<!--       "moderate", -->
<!--       ifelse( -->
<!--         Activity_level == "2.05 × BMR", -->
<!--         "high_moderate", -->
<!--         ifelse(Activity_level == "2.20 × BMR", -->
<!--                "heavy", -->
<!--                NA) -->
<!--       ) -->
<!--     ) -->
<!--   )) %>% -->
<!--   dplyr::group_by(Age_min, -->
<!--                   Age_max, -->
<!--                   Gender, -->
<!--                   Activity_level) %>%  -->
<!--   dplyr::summarise(av_body_mass = mean(av_body_mass),  -->
<!--                    av_kcalPerDay = mean(av_kcalPerDay),  -->
<!--                    .groups = "drop") -->

<!-- head(av_der_adult) -->

<!-- ``` -->

<!-- Bind adult and child DER data frames, and add age-bracket midpoints. -->
<!-- ```{r} -->

<!-- av_der1 <- av_der_child %>%  -->
<!--   dplyr::bind_rows(av_der_adult) %>%  -->
<!--   dplyr::mutate(Age_max = ifelse(Age_max == 999,  -->
<!--                                  99,  -->
<!--                                  Age_max)) %>%  -->
<!--   dplyr::mutate(Age_ave = 0.5*(Age_min + Age_max)) %>%  -->
<!--   dplyr::group_by(Age_ave, Gender, Activity_level) %>%  -->
<!--   dplyr::summarise(av_body_mass = mean(av_body_mass,  -->
<!--                                        na.rm = TRUE),  -->
<!--                    av_kcalPerDay = mean(av_kcalPerDay,  -->
<!--                                         na.rm = TRUE),  -->
<!--                    .groups = "drop") -->

<!-- head(av_der1) -->

<!-- ``` -->

<!-- Make a data frame with a row for each distinct year, gender, activity level group, then bin these into Age_min and Age_max columns as are used in the `av_der_child` and `av_der_adult` data sets.  -->

<!-- ```{r} -->

<!-- expanded_ages <- rbind( -->
<!--   data.frame( -->
<!--     min_age = seq(1, 103, by = 1), -->
<!--     max_age = seq(2, 104, by = 1), -->
<!--     Gender = rep("female", 618), -->
<!--     Activity_level = "light" -->
<!--   ), -->
<!--   data.frame( -->
<!--     min_age = seq(1, 103, by = 1), -->
<!--     max_age = seq(2, 104, by = 1), -->
<!--     Gender = rep("female", 618), -->
<!--     Activity_level = "moderate" -->
<!--   ), -->
<!--   data.frame( -->
<!--     min_age = seq(1, 103, by = 1), -->
<!--     max_age = seq(2, 104, by = 1), -->
<!--     Gender = rep("female", 618), -->
<!--     Activity_level = "high_moderate" -->
<!--   ), -->
<!--   data.frame( -->
<!--     min_age = seq(1, 103, by = 1), -->
<!--     max_age = seq(2, 104, by = 1), -->
<!--     Gender = rep("female", 618), -->
<!--     Activity_level = "heavy" -->
<!--   ), -->
<!--   data.frame( -->
<!--     min_age = seq(1, 103, by = 1), -->
<!--     max_age = seq(2, 104, by = 1), -->
<!--     Gender = rep("male", 618), -->
<!--     Activity_level = "light" -->
<!--   ), -->
<!--   data.frame( -->
<!--     min_age = seq(1, 103, by = 1), -->
<!--     max_age = seq(2, 104, by = 1), -->
<!--     Gender = rep("male", 618), -->
<!--     Activity_level = "moderate" -->
<!--   ), -->
<!--   data.frame( -->
<!--     min_age = seq(1, 103, by = 1), -->
<!--     max_age = seq(2, 104, by = 1), -->
<!--     Gender = rep("male", 618), -->
<!--     Activity_level = "high_moderate" -->
<!--   ), -->
<!--   data.frame( -->
<!--     min_age = seq(1, 103, by = 1), -->
<!--     max_age = seq(2, 104, by = 1), -->
<!--     Gender = rep("male", 618), -->
<!--     Activity_level = "heavy" -->
<!--   ) -->
<!-- ) %>% -->
<!--   mutate( -->
<!--     Age_min = ifelse( -->
<!--       min_age %in% c(1:17), -->
<!--       min_age, -->
<!--       ifelse(min_age %in% c(18:29), -->
<!--              18, -->
<!--              ifelse( -->
<!--                min_age %in% c(30:59), -->
<!--                30, -->
<!--                ifelse(min_age >= 60, -->
<!--                       60, -->
<!--                       NA) -->
<!--              )) -->
<!--     ), -->
<!--     Age_max = if_else( -->
<!--       max_age %in% c(2:18), -->
<!--       max_age, -->
<!--       ifelse(max_age %in% c(19:30), -->
<!--              30, -->
<!--              ifelse( -->
<!--                max_age %in% c(31:60), -->
<!--                60, -->
<!--                ifelse(max_age >= 61, -->
<!--                       999, -->
<!--                       NA) -->
<!--              )) -->
<!--     ) -->
<!--   ) -->

<!-- expanded_ages$Gender <- as.character(expanded_ages$Gender) -->
<!-- expanded_ages$Activity_level <- -->
<!--   as.character(expanded_ages$Activity_level) -->

<!-- head(expanded_ages) -->

<!-- ``` -->

<!-- Join the expanded child and adult data sets. -->

<!-- ```{r} -->

<!-- av_der <- av_der_child %>%  -->
<!--   dplyr::full_join( -->
<!--     av_der_adult,  -->
<!--     by = c("Age_min", "Age_max", "Gender", "Activity_level", "av_body_mass", "av_kcalPerDay")) %>%  -->
<!--   dplyr::arrange(Age_min) -->

<!-- av_der -->

<!-- ``` -->

<!-- The harmonized DER data set also contains an 'age' column, the midpoint of each age range value. NB: Children under the age of 5 years are classified as having "moderate" activity levels exclusive of "light" or "heavy" activity levels. -->

<!-- ```{r} -->

<!-- der <- av_der %>%  -->
<!--   dplyr::full_join( -->
<!--     expanded_ages,  -->
<!--     by = c("Age_min", "Age_max", "Gender", "Activity_level")) %>%  -->
<!--   dplyr::group_by(min_age, max_age, Gender, Activity_level) %>%  -->
<!--   dplyr::summarise( -->
<!--     av_kcalPerDay = mean(av_kcalPerDay,  -->
<!--                          na.rm = TRUE),  -->
<!--     av_body_mass = mean(av_body_mass,  -->
<!--                         na.rm = TRUE),  -->
<!--     .groups = "drop") %>%  -->
<!--   dplyr::ungroup() %>%  -->
<!--   dplyr::mutate(age = 0.5*(min_age + max_age)) -->

<!-- head(der) -->

<!-- ``` -->




Plot the data.

```{r}

p1 <- ggplot(data = der_harmonized, 
             aes(x = age_ave, y = der_interp)) + 
  geom_point(aes(colour = activity_level, 
                shape = gender)) + 
  geom_smooth(aes(colour = activity_level,
                linetype = gender),
              method = "loess",
              span = .1) +
  scale_color_manual(values = c("light" = "darkgreen", 
                                "moderate" = "darkblue", 
                                "high_moderate" = "darkred")) + 
  scale_shape_manual(values = c("male" = 2, "female" = 3)) + 
  scale_linetype_manual(values = c("male" = "dashed", "female" = "solid")) + 
  labs(
    x = "Age (yrs)", 
    y = "kcal/cap/day", 
    colour = "Activity \nLevel"
  ) + 
  theme_minimal()

p1

```

<!-- ```{r} -->

<!-- p1 <- ggplot(data = der %>%  -->
<!--                filter(Activity_level != "heavy"), aes(x = age, y = av_kcalPerDay)) +  -->
<!--   geom_point(aes(colour = Activity_level,  -->
<!--                 shape = Gender)) +  -->
<!--   geom_smooth(aes(colour = Activity_level, -->
<!--                 linetype = Gender), -->
<!--               method = "loess", -->
<!--               span = .1) + -->
<!--   scale_color_manual(values = c("light" = "darkgreen",  -->
<!--                                 "moderate" = "darkblue",  -->
<!--                                 "high_moderate" = "darkred")) +  -->
<!--   scale_shape_manual(values = c("male" = 2, "female" = 3)) +  -->
<!--   scale_linetype_manual(values = c("male" = "dashed", "female" = "solid")) +  -->
<!--   labs( -->
<!--     x = "Age (yrs)",  -->
<!--     y = "kcal/cap/day",  -->
<!--     colour = "Activity \nLevel" -->
<!--   ) +  -->
<!--   theme_minimal() -->

<!-- p1 -->

<!-- ``` -->


Every child (1-2 years) has moderate energy requirements; other ages are linearly interpolated between DER for 1.5 yrs and 5.5 yrs; infants (0-1 years) are dependent on their mothers.



There is a discontinuity in the DER between ages 18 and 19, probably because of the age-bracket averaging (18-30 years) for in the `der_adult` data set. Therefore, I use the values from the LOESS models (lines on the plot) as a "smoothed" version of the DER values from the harmonized data set.

```{r}
# 
# fit_data <- ggplot_build(p1)$data[[2]]
# 
# extracted_fit_data <- fit_data %>% 
#   dplyr::mutate(gender = ifelse(linetype == "solid", 
#                          "female", 
#                          "male"), 
#          activity_level = ifelse(colour == "red", 
#                                  "high_moderate", 
#                                  ifelse(colour == "blue", 
#                                         "moderate", 
#                                         "light"))) %>% 
#   dplyr::rename("age" = x, "kcal_perDay" = y) %>% 
#   dplyr::select(gender, activity_level, age, kcal_perDay)
# 
# # head(extracted_fit_data)
# 
# ggplot(extracted_fit_data, aes(x = age, y = kcal_perDay)) + 
#   geom_line(aes(colour = activity_level, linetype = gender))

```

Bin the ages in the 'age' column by whole numbers and interpolate any empty DER values.

```{r}

tmp <- rbind(data.frame(gender = "female", 
                  activity_level = "light", 
                  age = seq(1:104)), 
             data.frame(gender = "female", 
                  activity_level = "moderate", 
                  age = seq(1:104)), 
             data.frame(gender = "female", 
                  activity_level = "high_moderate", 
                  age = seq(1:104)), 
             data.frame(gender = "male", 
                  activity_level = "light", 
                  age = seq(1:104)), 
             data.frame(gender = "male", 
                  activity_level = "moderate", 
                  age = seq(1:104)), 
             data.frame(gender = "male", 
                  activity_level = "high_moderate", 
                  age = seq(1:104)))

tmp$gender <- as.character(tmp$gender)
tmp$activity_level <- as.character(tmp$activity_level)

# clean_fit_data <- extracted_fit_data %>% 
#   dplyr::mutate(age = round(age)) %>% 
#   dplyr::full_join(tmp, 
#                    by = c("gender", "activity_level", "age")) %>% 
#   dplyr::arrange(age)

clean_fit_data <- der_harmonized %>%
  dplyr::mutate(age = round(age_ave)) %>%
  dplyr::full_join(tmp, by = c("gender", "activity_level", "age")) %>%
  dplyr::select(-der_data) %>%
  tidyr::drop_na() %>%
  dplyr::arrange(age)

head(clean_fit_data)

```

<!-- Children under 2 years of age are presumed to be (1) dependent on their mothers' milk; and (2) set light and heavy DER values to the moderate values from the data. -->

<!-- ```{r} -->

<!-- interp_fit_data <- clean_fit_data %>% -->
<!--   group_by(gender, activity_level) %>% -->
<!--   arrange(age) %>% -->
<!--   filter(age > 1) %>%  -->
<!--   mutate(kcal_perDay = ifelse( -->
<!--     age == 2, -->
<!--     ifelse(gender == "female", 883.0239, 967.4315), -->
<!--     kcal_perDay -->
<!--   )) %>%  -->
<!--   mutate(kcal_interp = zoo::na.approx(kcal_perDay, maxgap = 5, rule = 3)) %>%  -->
<!--   ungroup() -->

<!-- head(interp_fit_data) -->

<!-- ``` -->


Now bin DER by the same age brackets as the population data.

```{r}
fit_data_final <- clean_fit_data %>% 
  dplyr::select(-age_min, -age_max, -age_ave) %>% 
  dplyr::group_by(gender, activity_level) %>%
  dplyr::mutate(min_age = ifelse(age < 5,
                                 0,
                                 ifelse(
                                   age >= 5 & age < 10,
                                   5,
                                   ifelse(age >= 10 & age < 15,
                                          10,
                                          ifelse(
                                            age >= 15 & age < 20,
                                            15,
                                            ifelse(age >= 20 & age < 25,
                                                   20,
                                                   ifelse(
                                                     age >= 25 & age < 30,
                                                     25,
                                                     ifelse(age >= 30 & age < 35,
                                                            30,
                                                            ifelse(
                                                              age >= 35 & age < 40,
                                                              35,
                                                              ifelse(age >= 40 & age < 45,
                                                                     40,
                                                                     ifelse(
                                                                       age >= 45 & age < 50,
                                                                       45,
                                                                       ifelse(age >= 50 & age < 55,
                                                                              50,
                                                                              ifelse(
                                                                                age >= 55 & age < 60,
                                                                                55,
                                                                                ifelse(age >= 60 & age < 65,
                                                                                       60,
                                                                                       ifelse(
                                                                                         age >= 65 & age < 70,
                                                                                         65,
                                                                                         ifelse(age >= 70 & age < 75,
                                                                                                70,
                                                                                                ifelse(
                                                                                                  age >= 75 & age < 80,
                                                                                                  75,
                                                                                                  ifelse(age >= 80 & age < 85,
                                                                                                         80,
                                                                                                         ifelse(
                                                                                                           age >= 85 & age < 90,
                                                                                                           85,
                                                                                                           ifelse(age >= 90 & age < 95,
                                                                                                                  90,
                                                                                                                  ifelse(age >= 95 &
                                                                                                                           age < 100,
                                                                                                                         95,
                                                                                                                         100))
                                                                                                         ))
                                                                                                ))
                                                                                       ))
                                                                              ))
                                                                     ))
                                                            ))
                                                   ))
                                          ))
                                 )),
                max_age = ifelse(age < 5,
                                 4,
                                 ifelse(
                                   age >= 5 & age < 10,
                                   9,
                                   ifelse(age >= 10 & age < 15,
                                          14,
                                          ifelse(
                                            age >= 15 & age < 20,
                                            19,
                                            ifelse(age >= 20 & age < 25,
                                                   24,
                                                   ifelse(
                                                     age >= 25 & age < 30,
                                                     29,
                                                     ifelse(age >= 30 & age < 35,
                                                            34,
                                                            ifelse(
                                                              age >= 35 & age < 40,
                                                              39,
                                                              ifelse(age >= 40 & age < 45,
                                                                     44,
                                                                     ifelse(
                                                                       age >= 45 & age < 50,
                                                                       49,
                                                                       ifelse(age >= 50 & age < 55,
                                                                              54,
                                                                              ifelse(
                                                                                age >= 55 & age < 60,
                                                                                59,
                                                                                ifelse(age >= 60 & age < 65,
                                                                                       64,
                                                                                       ifelse(
                                                                                         age >= 65 & age < 70,
                                                                                         69,
                                                                                         ifelse(age >= 70 & age < 75,
                                                                                                74,
                                                                                                ifelse(
                                                                                                  age >= 75 & age < 80,
                                                                                                  79,
                                                                                                  ifelse(age >= 80 & age < 85,
                                                                                                         84,
                                                                                                         ifelse(
                                                                                                           age >= 85 & age < 90,
                                                                                                           89,
                                                                                                           ifelse(age >= 90 &
                                                                                                                    age < 95,
                                                                                                                  94,
                                                                                                                  ifelse(age >= 95 &
                                                                                                                           age < 100,
                                                                                                                         99,
                                                                                                                         104))
                                                                                                         ))
                                                                                                ))
                                                                                       ))
                                                                              ))
                                                                     ))
                                                            ))
                                                   ))
                                          ))
                                 ))) %>%
  ungroup() %>%
  dplyr::group_by(gender, activity_level, min_age, max_age) %>%
  dplyr::summarise(kcal_mean = mean(der_interp),
                   .groups = "drop")

head(fit_data_final)
```

Join the mean-DER and metabolic requirements data frames.

```{r}

ssp_kcal <- ssp_world_long %>% 
  dplyr::full_join(fit_data_final, 
            by = c("gender", "min_age", "max_age")) %>% 
  dplyr::mutate(million_kcal_perDay = millions*kcal_mean)

head(ssp_kcal)

```

### Considering disaggregated education and activity levels

The above analysis simplified food demand in two ways: it aggregated populations globally, and it assumed a moderate activity level the daily (healthy) caloric requirement. The SSPs give more detailed assumptions on national education levels by gender and age cohort, and the FAO healthy diet data give detailed information about metabolic energy requirements by age and gender that we aggregated into the three activity levels.

The SSPs contain four education levels (i.e., "no education", "primary education", "secondary education", and "tertiary education"). I assume that individuals with primary level and below will tend to be employed in manual physical labor, secondary level will be employed in trades, and tertiary level will be white collar; hence, I map these onto "high-moderate", "moderate", and "light" activity levels, respectively.

I made several vectors of character strings:

```{r}

for(i in seq(0, 100, by = 5)){
  tmp1 <- paste0("Population|Female|Aged", i, "-", i+4, "|No Education")
  tmp2 <- paste0("Population|Male|Aged", i, "-", i+4, "|No Education")
  
  tmp3 <- paste0("Population|Female|Aged", i, "-", i+4, "|Primary Education")
  tmp4 <- paste0("Population|Male|Aged", i, "-", i+4, "|Primary Education")
  
  tmp5 <- paste0("Population|Female|Aged", i, "-", i+4, "|Secondary Education")
  tmp6 <- paste0("Population|Male|Aged", i, "-", i+4, "|Secondary Education")
  
  tmp7 <- paste0("Population|Female|Aged", i, "-", i+4, "|Tertiary Education")
  tmp8 <- paste0("Population|Male|Aged", i, "-", i+4, "|Tertiary Education")
  
  #unless age bracket is 100+
  if(i==100){
    tmp1 <- "Population|Female|Aged100+|No Education"
    tmp2 <- "Population|Male|Aged100+|No Education"
    
    tmp3 <- "Population|Female|Aged100+|Primary Education"
    tmp4 <- "Population|Male|Aged100+|Primary Education"
    
    tmp5 <- "Population|Female|Aged100+|Secondary Education"
    tmp6 <- "Population|Male|Aged100+|Secondary Education"
    
    tmp7 <- "Population|Female|Aged100+|Tertiary Education"
    tmp8 <- "Population|Male|Aged100+|Tertiary Education"
  }
  
  if(i==0){ 
    female_pop_noEd <- tmp1
    male_pop_noEd   <- tmp2
    
    female_pop_primEd <- tmp3
    male_pop_primEd   <- tmp4
    
    female_pop_secondEd <- tmp5
    male_pop_secondEd   <- tmp6
    
    female_pop_tertiEd <- tmp7
    male_pop_tertiEd   <- tmp8
  }
  if(i >0){
    female_pop_noEd <- c(female_pop_noEd, tmp1)
    male_pop_noEd   <- c(male_pop_noEd, tmp2)
    
    female_pop_primEd <- c(female_pop_primEd, tmp3)
    male_pop_primEd   <- c(male_pop_primEd, tmp4)
    
    female_pop_secondEd <- c(female_pop_secondEd, tmp5)
    male_pop_secondEd   <- c(male_pop_secondEd, tmp6)
    
    female_pop_tertiEd <- c(female_pop_tertiEd, tmp7)
    male_pop_tertiEd   <- c(male_pop_tertiEd, tmp8)
  }
}

```

I turn these into a data frame (`age_edu_map`) that maps the 'VARIABLE' column from the SSP data to disaggregated 'gender', 'education_level', 'min_age' and 'max_age' columns, and adds an 'activity_level' column.

```{r}

age_edu_map <- rbind(
  tibble(
    VARIABLE = female_pop_noEd,
    gender = "female",
    education_level = "none",
    min_age = seq(0, 100, by = 5),
    max_age = seq(4, 104, by = 5)
  ),
  tibble(
    VARIABLE = male_pop_noEd,
    gender = "male",
    education_level = "none",
    min_age = seq(0, 100, by = 5),
    max_age = seq(4, 104, by = 5)
  ),
  tibble(
    VARIABLE = female_pop_primEd,
    gender = "female",
    education_level = "primary",
    min_age = seq(0, 100, by = 5),
    max_age = seq(4, 104, by = 5)
  ),
  tibble(
    VARIABLE = male_pop_primEd,
    gender = "male",
    education_level = "primary",
    min_age = seq(0, 100, by = 5),
    max_age = seq(4, 104, by = 5)
  ),
  tibble(
    VARIABLE = female_pop_secondEd,
    gender = "female",
    education_level = "secondary",
    min_age = seq(0, 100, by = 5),
    max_age = seq(4, 104, by = 5)
  ),
  tibble(
    VARIABLE = male_pop_secondEd,
    gender = "male",
    education_level = "secondary",
    min_age = seq(0, 100, by = 5),
    max_age = seq(4, 104, by = 5)
  ),
  tibble(
    VARIABLE = female_pop_tertiEd,
    gender = "female",
    education_level = "tertiary",
    min_age = seq(0, 100, by = 5),
    max_age = seq(4, 104, by = 5)
  ),
  tibble(
    VARIABLE = male_pop_tertiEd,
    gender = "male",
    education_level = "tertiary",
    min_age = seq(0, 100, by = 5),
    max_age = seq(4, 104, by = 5)
  )
)

age_edu_map <- age_edu_map %>%
  dplyr::mutate(activity_level = ifelse(
    max_age < 11,
    "moderate",
    ifelse(
      education_level == "none",
      "high_moderate",
      ifelse(
        education_level %in% c("primary", "secondary"),
        "moderate",
        "light"
      )
    )
  ))


```

Rows rows in `ssp_base` that do not have education information are filtered, and joined with the `age_edu_map` data frame to produce `ssp_edu`.

```{r}

ssp_edu <- ssp_base %>%
  filter(VARIABLE %in% age_edu_map$VARIABLE) %>%
  full_join(age_edu_map, 
            by = "VARIABLE") %>%
  arrange(min_age)

```

Reshape the `ssp_edu` data frame into a long version, `ssp_edu_long`.

```{r}

ssp_edu_long <- ssp_edu %>% 
  dplyr::select(-MODEL, -VARIABLE, -UNIT) %>%
  tidyr::pivot_longer(cols = starts_with("X"),
               names_to = "year",
               names_prefix = "X",
               values_to = "millions") %>%
  dplyr::mutate(year = as.numeric(year)) %>%
  tidyr::drop_na()

head(ssp_edu_long)

```
Merge the `ssp_edu_long` df with `fit_data_final`.
```{r}
ssp1_kcal_edu <- ssp_edu_long %>%
  dplyr::filter(SCENARIO == "SSP1_v9_130115") %>%
  dplyr::full_join(fit_data_final,
                   by = c("gender", "min_age", "max_age", "activity_level")) %>%
  drop_na()

ssp2_kcal_edu <- ssp_edu_long %>%
  dplyr::filter(SCENARIO == "SSP2_v9_130115") %>%
  dplyr::full_join(fit_data_final,
                   by = c("gender", "min_age", "max_age", "activity_level"))  %>%
  drop_na()

ssp3_kcal_edu <- ssp_edu_long %>%
  dplyr::filter(SCENARIO == "SSP3_v9_130115") %>%
  dplyr::full_join(fit_data_final,
                   by = c("gender", "min_age", "max_age", "activity_level")) %>%
  drop_na()

ssp4_kcal_edu <- ssp_edu_long %>%
  dplyr::filter(SCENARIO == "SSP4d_v9_130115") %>%
  dplyr::full_join(fit_data_final,
                   by = c("gender", "min_age", "max_age", "activity_level")) %>%
  drop_na()

ssp5_kcal_edu <- ssp_edu_long %>%
  dplyr::filter(SCENARIO == "SSP5_v9_130115") %>%
  dplyr::full_join(fit_data_final,
                   by = c("gender", "min_age", "max_age", "activity_level")) %>%
  drop_na()

```

```{r}
kcal_edu <- ssp1_kcal_edu %>% 
  bind_rows(ssp2_kcal_edu) %>% 
  bind_rows(ssp3_kcal_edu) %>% 
  bind_rows(ssp4_kcal_edu) %>% 
  bind_rows(ssp5_kcal_edu)

head(kcal_edu)
```

### Metabolic energy demand constrained by SSPs and healthy diets

Given the above constraints, `ssp2_kcal_edu` contains the mean metabolic energy demand by gender and activity level.

```{r}
ssp2_kcal_edu <- ssp_edu_long %>%
  dplyr::full_join(fit_data_final,
                   by = c("gender", "min_age", "max_age", "activity_level")) %>% 
  tidyr::drop_na()

head(ssp2_kcal_edu)
```

### Food security indicators

Next, compare the bottom-up calculation of DER demand, based on the SSPs, and that determined by the FAO. Suite of food security indicators from [FAOSTAT](http://fenixservices.fao.org/faostat/static/bulkdownloads/Food_Security_Data_E_All_Data_(Normalized).zip).

Trim the df to pull dietary energy supply (kcal/cap/day), average fat supply (g/cap/day), average protein supply (g/cap/day), and average supply of protein of animal origin (g/cap/day), average dietary energy requirement (kcal/cap/day), and minimum dietary energy requirement (kcal/cap/day).

```{r}

fao_food_security_data <-
  read_csv(
    file = paste0(data_path, "Food_Security_cleaned.csv"),
    col_types = cols(
      Area_Code = col_double(),
      Area = col_character(),
      Item_Code = col_double(),
      Item = col_character(),
      Element_Code = col_double(),
      Element = col_character(),
      Year_Code = col_double(),
      min_year = col_double(),
      max_year = col_double(),
      eval_year = col_double(),
      Unit = col_character(),
      Value = col_double(),
      Flag = col_character()
    )
  )
fao_food_security_data <- fao_food_security_data %>%
  dplyr::rename(countryname = Area,
                fao_countrycode = Area_Code)
dietary_energy_supply <- fao_food_security_data %>%
  filter(Item_Code == 22000)

# ave_fat_supplyfao_food_security_data %>%
#   filter(Item_Code == 21061)
#
# ave_prot_supply <- fao_food_security_data %>%
#   filter(Item_Code == 21013)
#
# ave_prot_supply_animal_sources <- fao_food_security_data %>%
#   filter(Item_Code == 21014)
#
# undernourishment_percent <- fao_food_security_data %>%
#   filter(Item_Code == 210041)
#
# undernourishment_quantity <- fao_food_security_data %>%
#   filter(Item_Code == 210011)

av_der_faostat <- fao_food_security_data %>%
  filter(Item_Code == 21057)

mder_faostat <- fao_food_security_data %>%
  filter(Item_Code == 21056)

```

Load some geographic mapping data, along with a CSV file used to harmonize geographic subregions.
```{r}
if(!exists("loc_map")) {
  loc_map <- readr::read_csv(
    paste0(
      "~/Projects/IEP_2/Model/R_files/Data_files/", "location_code_map_data.csv"
    ), 
    col_types = cols(
      Location   = col_character(), 
      LocID      = col_number(), 
      ISO3_Code  = col_character(), 
      SubRegID   = col_number(), 
      SubRegName = col_character(), 
      Area.Code  = col_number(), 
      Area       = col_character())
  ) %>% 
    dplyr::select(-X1) %>% 
    drop_na()
}

loc_map_reduced <- loc_map %>% 
  dplyr::select(ISO3_Code, Area, Area.Code, LocID, SubRegID, SubRegName) %>% 
  dplyr::rename(iso_alpha3      = ISO3_Code, 
                countryname     = Area, 
                fao_countrycode = Area.Code, 
                un_countrycode  = LocID, 
                subregioncode   = SubRegID, 
                subregionname   = SubRegName) 


```


Compare the food security indicators, `der_fao`, from FAO with those that I've calculated, `der_ssp`.
```{r}

der_fao <- av_der_faostat %>%
  dplyr::full_join(loc_map_reduced,
                   by = c("fao_countrycode", "countryname")) %>%
  dplyr::filter(eval_year %in% c(2010, 2015, 2020)) %>%
  dplyr::rename(year = eval_year,
                DER_FAO = Value,
                REGION = iso_alpha3) %>%
  dplyr::select(
    -Flag,
    -Item,
    -Item_Code,
    -fao_countrycode,
    -Year_Code,
    -min_year,
    -max_year,
    -Element_Code,
    -Element,
    -un_countrycode,
    -subregioncode
  )

head(der_fao)

```

Find comparable averages (weighted by cohort populations) from the data I've calculated.
```{r}

der_ssp <- ssp2_kcal_edu %>%
  dplyr::group_by(SCENARIO, REGION, year) %>%
  dplyr::summarise(total_pop = sum(millions),
                   .groups = "drop") %>%
  dplyr::ungroup() %>%
  dplyr::full_join(ssp2_kcal_edu,
                   by = c("SCENARIO", "REGION", "year")) %>%
  dplyr::mutate(weighting = (millions / total_pop),
                wtd_mean = kcal_mean * weighting) %>%
  dplyr::group_by(SCENARIO, REGION, year) %>%
  dplyr::summarise(der_ave = sum(wtd_mean),
                   .groups = "drop") %>%
  dplyr::filter(year %in% c(2010, 2015, 2020)) %>%
  tidyr::pivot_wider(names_from = SCENARIO, values_from = der_ave) %>%
  dplyr::rename(
    der_ssp1 = SSP1_v9_130115,
    der_ssp2 = SSP2_v9_130115,
    der_ssp3 = SSP3_v9_130115,
    der_ssp4 = SSP4d_v9_130115,
    der_ssp5 = SSP5_v9_130115
  )

head(der_ssp)

```

Based on healthy diet considerations, for all age group and sex cohorts, the following surpluses (negative surpluses are deficits) of the daily energy requirements (kcal/cap/day) are given by country:
```{r}
der_surpluses <- der_fao %>%
  dplyr::full_join(der_ssp, by = c("year", "REGION")) %>% 
  dplyr::mutate(DER_FAO - across(der_ssp1:der_ssp5)) %>%
  tidyr::drop_na() %>% 
  dplyr::rename(SSP1 = der_ssp1, 
                SSP2 = der_ssp2,
                SSP3 = der_ssp3,
                SSP4 = der_ssp4,
                SSP5 = der_ssp5) %>% 
  tidyr::pivot_longer(., cols = SSP1:SSP5, names_to = "scenario", values_to = "der_surplus")

head(der_surpluses)

```

```{r}
regions_map <- read_csv(
  file = paste0(data_path, "regions_map.csv"),
  col_types = cols(
    iso_alpha3 = col_character(),
    countryname = col_character(),
    fao_countrycode = col_double(),
    un_countrycode = col_double(),
    subregioncode = col_double(),
    subregionname = col_character(),
    region = col_character()
  )
)
regions_map <- regions_map %>%
  dplyr::rename(REGION = iso_alpha3) %>%
  dplyr::select(REGION, countryname, region) %>%
  dplyr::mutate(region = ifelse(
    region == "Astralia and New Zealand",
    "Australia and New Zealand",
    region
  )) # oops!

```


```{r}

ssp2_pop_regions <- ssp2_kcal_edu %>%
  dplyr::group_by(SCENARIO, REGION, year) %>%
  dplyr::summarise(pop_millions = sum(millions),
                   .groups = "drop") %>%
  dplyr::ungroup() %>%
  dplyr::filter(year %in% c(2010, 2015, 2020)) %>%
  dplyr::left_join(regions_map, by = "REGION") %>%
  dplyr::mutate(scenario = ifelse(
    SCENARIO == "SSP1_v9_130115",
    "SSP1",
    ifelse(
      SCENARIO == "SSP2_v9_130115",
      "SSP2",
      ifelse(
        SCENARIO == "SSP3_v9_130115",
        "SSP3",
        ifelse(SCENARIO == "SSP4d_v9_130115", "SSP4",
               ifelse(SCENARIO == "SSP5_v9_130115", "SSP5", 
                      SCENARIO)
      )
    )
  )))

head(ssp2_pop_regions)

```


```{r}

der_surpluses_regions <- der_surpluses %>%
  dplyr::left_join(ssp2_pop_regions, by = c("countryname", "year", "REGION", "scenario")) %>%
  dplyr::select(-subregionname) %>% 
  tidyr::drop_na()

head(der_surpluses_regions)

```

Now plot these.
```{r}
der_surpluses_regions <- der_surpluses_regions %>% 
  dplyr::mutate(region_f = region)

der_surpluses_regions$region_f <- factor(der_surpluses_regions$region_f, levels = c("South Asia", "Africa", "Oceania", "Southeast Asia", "South America", "Central Asia and Russia", "Latin America and Caribbean", "MENA", "East Asia", "Europe", "Australia and New Zealand", "North America"))
```


```{r}

p2a <- ggplot(
  data = der_surpluses_regions %>%
    dplyr::filter(year == 2020 &
                    SCENARIO == "SSP2_v9_130115"),
  aes(x = der_surplus)
) +
  geom_vline(xintercept = 0, alpha = 0.8) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_histogram() +
  facet_wrap( ~ region_f) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    ),
    # panel.background = element_rect(fill = "lightgrey"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.grid.major.x = element_line(colour = "darkgrey", size = 0.5),
    panel.grid.minor.x = element_line(colour = "darkgrey", size = 0.25),
    strip.text = element_text(size = 8), 
    axis.title.y = element_text(size = 9)
  ) + 
  scale_y_continuous(labels = c(0,2,4,6,8), breaks = c(0,2,4,6,8)) + 
  labs(title = "Average Daily Energy Requirement deficit by region",
       subtitle = "Year 2020 deficit between FAO DER and a healthy diet DER (SSP2)",
       x = "kcal/cap/day", 
       y = "number of countries in the region")

p2a

```

According to the FAO numbers, only countries in North America, Europe, Australia and New Zealand, and one or two representatives in Latin America and the Caribbean, South-East Asia, and Central Asia are acquiring sufficient daily calories to be healthful.

```{r}

n_df <- der_surpluses_regions %>%
  dplyr::filter(year == 2020, scenario == "SSP1") %>%
  dplyr::group_by(region) %>%
  summarise(n = n(),
            .groups = "drop")

p2b <- ggplot(data = der_surpluses_regions,
              # %>%
              #   dplyr::filter(year == 2020),
              aes(x = scenario,
                  y = der_surplus)) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_boxplot() +
  theme_bw() +
  facet_wrap(~ region_f) +
  theme(
    axis.title.y = element_blank(), 
    axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    ),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.text = element_text(size = 8)
  ) +
  labs(title = "Average Daily Energy Requirement deficit by region and SSP",
       subtitle = "Year 2020 deficit between FAO DER and a healthy diet DER", 
       y = "kcal/cap/day") + 
  coord_flip()

p2b

knitr::kable(n_df, caption = "Number of countries in each region")

```

If FAO DER does not change between now and 2050, the deficit will look like:
```{r}
der_fao_2020 <- der_fao %>% 
  dplyr::filter(year == 2020) %>% 
  tidyr::drop_na() 

der_fao_2050 <- der_fao_2020 %>% 
  dplyr::mutate(year = 2050)

der_fao_2020_2050 <- der_fao_2020 %>% 
  dplyr::bind_rows(der_fao_2050)

```

```{r}
der_ssp_2050 <- ssp2_kcal_edu %>%
  dplyr::group_by(SCENARIO, REGION, year) %>%
  dplyr::summarise(total_pop = sum(millions),
                   .groups = "drop") %>%
  dplyr::ungroup() %>%
  dplyr::full_join(ssp2_kcal_edu,
                   by = c("SCENARIO", "REGION", "year")) %>%
  dplyr::mutate(weighting = (millions / total_pop),
                wtd_mean = kcal_mean * weighting) %>%
  dplyr::group_by(SCENARIO, REGION, year) %>%
  dplyr::summarise(der_ave = sum(wtd_mean),
                   .groups = "drop") %>%
  dplyr::filter(year %in% c(2020, 2050)) %>%
  tidyr::pivot_wider(names_from = SCENARIO, values_from = der_ave) %>%
  dplyr::rename(
    der_ssp1 = SSP1_v9_130115,
    der_ssp2 = SSP2_v9_130115,
    der_ssp3 = SSP3_v9_130115,
    der_ssp4 = SSP4d_v9_130115,
    der_ssp5 = SSP5_v9_130115
  ) %>% 
  dplyr::left_join(regions_map, by = "REGION")


head(der_ssp_2050)
```


```{r}
der_surpluses_2050 <- der_ssp_2050 %>% 
  dplyr::select(-countryname) %>%
  dplyr::left_join(der_fao_2020_2050, by = c("REGION", "year")) %>%
  tidyr::drop_na() %>%
  dplyr::mutate(DER_FAO - across(der_ssp1:der_ssp5)) %>%
  tidyr::drop_na() %>%
  dplyr::rename(
    SSP1 = der_ssp1,
    SSP2 = der_ssp2,
    SSP3 = der_ssp3,
    SSP4 = der_ssp4,
    SSP5 = der_ssp5
  ) %>%
  tidyr::pivot_longer(.,
                      cols = SSP1:SSP5,
                      names_to = "scenario",
                      values_to = "der_surplus")

```

Find a rough order for region DER difference.
```{r}
regions_in_order <- der_surpluses_2050 %>% 
  dplyr::filter(scenario == "SSP3", year == 2050) %>% 
  dplyr::group_by(year, region, scenario) %>% 
  dplyr::summarise(der_surplus = mean(der_surplus, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::arrange(der_surplus) %>% 
  dplyr::pull(region)
```


Factorize regions to order them in the plot.
```{r}
der_surpluses_2050 <- der_surpluses_2050 %>% 
  dplyr::mutate(region_f = region)

der_surpluses_2050$region_f <- factor(der_surpluses_2050$region_f, levels = regions_in_order)

# der_surpluses_2050$region_f <- factor(der_surpluses_2050$region_f, levels = c("Africa", "South Asia", "Southeast Asia", "Oceania", "South America", "Latin America and Caribbean", "MENA", "Central Asia and Russia", "East Asia", "Europe", "Australia and New Zealand", "North America"))
```


```{r}
tmp <- der_surpluses_2050 %>% 
  group_by(region_f, year, scenario) %>% 
  summarise(der_surplus = mean(der_surplus), 
            .groups = "drop") %>% 
  arrange(der_surplus) %>% 
  mutate(region_code = ifelse(
    region_f == "Africa", "AFRI", 
    ifelse(
      region_f == "South Asia", 
      "SOAS", 
      ifelse(
        region_f == "Southeast Asia", 
        "SEAS", 
        ifelse(
          region_f == "Oceania", 
          "OCEA", 
          ifelse(
            region_f == "South America", 
            "SOAM", 
            ifelse(
              region_f == "Latin America and Caribbean", 
              "LAMC", 
              ifelse(
                region_f == "Central Asia and Russia", 
                "CASR", 
                ifelse(
                  region_f == "East Asia", 
                  "EAAS", 
                  ifelse(
                    region_f == "Europe", 
                    "EURO", 
                    ifelse(
                      region_f == "Australia and New Zealand", 
                      "AUNZ", 
                      ifelse(
                        region_f == "North America", 
                        "NOAM", 
                        ifelse(
                          region_f == "MENA", 
                          "MENA", 
                          region_f
                        )
                      )
                    )
                  )
                )
              )
            )
        ))
    ))))

tmp
```
Find min and max DER values and elongate the df for plotting.
```{r}
tmp1 <- tmp %>% 
  dplyr::select(-region_f) %>% 
  group_by(year, region_code) %>% 
  mutate(y_min = min(der_surplus), 
        y_max = max(der_surplus)) %>% 
  dplyr::select(-der_surplus) %>% 
  pivot_longer(.,cols = y_min:y_max, values_to = "der_surplus") %>% 
  dplyr::select(-name, -scenario) %>% 
  arrange(year, der_surplus)

```

For plot annotation.
```{r}
annotation <- data.frame(
   year = c(2020, 2022, 2024, 2023, 2025, 2024, 2025, 2022, 2027, 2028, 2025, 2040),
   der_surplus = c(-400, -350, -220, -220, -190, -180, -100, -150, -80, 20, 60, 180),
   region_code = c("AFRI", "SOAS", "OCEA", "SEAS", "SOAM", "LAMC", "MENA", "CASR", "EAAS", "EURO", "AUNZ", "NOAM")
)
```


<!-- ```{r} -->
<!-- # library(directlabels) -->
<!-- der_change_plot <- ggplot(tmp1,  -->
<!--        aes(x = year,  -->
<!--            y = der_surplus,  -->
<!--            group = region_code)) +  -->
<!--   geom_hline(yintercept = 0, alpha = 0.6, size = 0.5) +  -->
<!--   geom_polygon(aes(fill = region_code), alpha = 0.4) +  -->
<!--   # geom_line(aes(color = region_code), alpha = 0.5) +  -->
<!--   theme_minimal() +  -->
<!--   # geom_dl(aes(label = region_code, color = region_code), method = list(dl.trans(x = x - 2), "first.points", cex = 0.8)) +  -->
<!--   # geom_dl(aes(label = region_code, color = region_code), method = list(dl.trans(x = x + 0), "last.points", cex = 0.8)) +  -->
<!--   geom_text(data = annotation, aes(x=year, y=der_surplus, label=region_code, color = region_code, size = 2), show.legend = FALSE) + -->
<!--   theme( -->
<!--     legend.title = element_blank(),  -->
<!--     legend.position = "right",  -->
<!--     axis.title.x = element_blank() -->
<!--   ) +  -->
<!--   labs(title = "Average DER surplus change from 2020 to 2050", -->
<!--        subtitle = "Range of surpluses between a healthy DER and FAO DER (2020), by SSP",  -->
<!--        y = "kcal/cap/day")  -->

<!-- der_change_plot -->

<!-- ``` -->

```{r}
der_deficits <- der_surpluses_regions %>% 
  dplyr::filter(year == 2020) %>% 
  dplyr::select(REGION, year, scenario, der_surplus, region_f) %>%
  dplyr::bind_rows(der_surpluses_2050 %>% 
  dplyr::select(REGION, year, scenario, der_surplus, region_f))

der_deficits <- der_deficits %>% 
  dplyr::mutate(year_f = year) 

der_deficits$year_f <- factor(der_deficits$year_f, levels = c("2020", "2050"))

der_deficits$region_f <- factor(der_deficits$region_f, levels = c("Africa", "South Asia", "Oceania", "Southeast Asia", "South America", "Latin America and Caribbean", "Central Asia and Russia", "MENA", "East Asia", "Europe", "Australia and New Zealand", "North America"))
```

```{r}

p2d <- ggplot(data = der_deficits, 
       aes(x = scenario, 
           y = der_surplus, 
           fill = year_f)) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_boxplot(size = 0.25) +
  theme_bw() +
  facet_wrap(~ region_f) +
  theme(
    legend.position = "top", 
    legend.title = element_blank(), 
    axis.title.x = element_blank(), 
    axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    ),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.text = element_text(size = 8), 
    strip.background =element_rect(fill="white")
  ) +
  labs(title = "Average Daily Energy Requirement deficit by region and SSP",
       subtitle = "Difference between FAO DER (2020) and a healthy diet DER", 
       y = "kcal/cap/day")
# + 
#   coord_flip()

p2e <- ggplot(data = der_deficits, 
       aes(x = scenario, 
           y = der_surplus, 
           fill = year_f)) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_boxplot(size = 0.25) + 
  annotate("text", x="SSP1", y=450, label="World") + 
  theme_bw() + 
  theme(
    legend.position = "none", 
    legend.title = element_blank(), 
    axis.title.x = element_blank(), 
    axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    ),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.text = element_text(size = 8)
  ) +
  labs(y = "kcal/cap/day") 

p2d
# p2e

title <- cowplot::get_title(p2d)

# cowplot::plot_grid(p2d, p2e, rel_widths = c(2,1))
```


```{r}
der_surpluses_2050 <- der_surpluses_2050 %>% 
  dplyr::mutate(region_f = region) 

der_surpluses_2050$region_f <- factor(der_surpluses_2050$region_f, levels = c("Africa", "South Asia", "Oceania", "Southeast Asia", "South America", "Latin America and Caribbean", "Central Asia and Russia", "MENA", "East Asia", "Europe", "Australia and New Zealand", "North America"))
```


```{r}


p2c <- ggplot(data = der_surpluses_2050 %>% 
                dplyr::filter(year == 2050),
              # %>%
              #   dplyr::filter(year == 2020),
              aes(x = scenario,
                  y = der_surplus)) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_boxplot() +
  theme_bw() +
  facet_wrap(~ region_f) +
  theme(
    axis.title.y = element_blank(), 
    axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    ),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.text = element_text(size = 8)
  ) +
  labs(title = "Average Daily Energy Requirement deficit by region and SSP",
       subtitle = "Year 2050 deficit between FAO DER (2020) and a healthy diet DER", 
       y = "kcal/cap/day") + 
  coord_flip()

p2c

```



## Land use

Given a diet of sufficient calories, how much land is necessary? This will depend on how much meat/animal products are consumed. I calculate land use for diets: 
1. the [EAT-Lancet Planetary Health Diet (EL-PHD) by the EAT-Lancet Commission](https://eatforum.org/eat-lancet-commission/the-planetary-health-diet-and-you/); 
2. the [Healthy US-Style Dietary Pattern (US-SDP) by the USDA](https://www.dietaryguidelines.gov/sites/default/files/2021-03/Dietary_Guidelines_for_Americans-2020-2025.pdf);
3. the ["Chinese Food Pagoda" by the Chinese Nutrition Society (CNS-CFP)](http://dg.cnsoc.org/upload/images/source/20160519163856103.jpg), citation: [Chinese Nutrition Society. (2000). Dietary Guidelines and the Food Guide Pagoda. Journal of the Academy of Nutrition and Dietetics, 100(8): 886-887.](https://doi.org/10.1016/S0002-8223(00)00257-1)
<!-- 4. the "United States Diet" (USD), based on National Health and Nutrition Examination Survey (NHANES) data from the US Centers for Disease Control compiled by [Shan Z, Rehm CD, Rogers G, et al. 2019. Trends in Dietary Carbohydrate, Protein, and Fat Intake and Diet Quality Among US Adults, 1999-2016. JAMA. 322(12):1178–1187. doi:10.1001/jama.2019.13771.](https://jamanetwork.com/journals/jama/fullarticle/2751719?guestAccessKey=143e6dff-5b1e-48eb-948b-a8a2e386627a&utm_source=For_The_Media&utm_medium=referral&utm_campaign=ftm_links&utm_content=tfl&utm_term=092419#227562773) -->

All diet plan units were converted into grams and kcal per day for each food class/group. For the US-FDA plan, this required converting units such as cups (volume) per week and ounces (weight) per day, and calculating kcal from these values. Representative foods were found for each case (e.g., raw peaches for "fruits"). Because the US-FDA plan includes total recommended daily kcal based on age cohorts, I had a test of how well my back-calculation of diet kcal was: summing the back-calculated total kcal showed good correspondence (i.e., from a maximum percent difference of 15% above 1200 kcal/day, to a minimum of 7% below 3200 kcal/day).

These national dietary plans were organised into .csv files.
```{r}

ela_phd <-
  readr::read_csv(
    file = paste0(data_path, "National dietary plans - ELA-PHD.csv"),
    col_types = cols(
      ELA_PHD = col_character(),
      kcal_day = col_double(),
      g_day_ave = col_double(),
      g_day_min = col_double(),
      g_day_max = col_double(),
      kcal_ratio = col_double(),
      mass_ratio = col_double()
    )
  )

fda_sdp <-
  readr::read_csv(
    file = paste0(data_path, "National dietary plans - FDA-SDP.csv"),
    col_types = cols(
      kcal_requirement = col_double(),
      FDA_SDP = col_character(),
      kcal_day = col_double(),
      g_day_ave = col_double(),
      kcal_ratio = col_double(),
      mass_ratio = col_double()
    )
  )

cns_cfp <-
  readr::read_csv(
    file = paste0(data_path, "National dietary plans - CNS-CFP.csv"),
    col_types = cols(
      CNS_CFP = col_character(),
      kcal_day = col_double(),
      g_kcal = col_double(),
      g_day_ave = col_double(),
      kcal_ratio = col_double(),
      mass_ratio = col_double()
    )
  )

# cdc_usd <-
#   readr::read_csv(
#     file = paste0(data_path, "National dietary plans - CDC-USD.csv"),
#     col_types = cols(
#       CDC_USD = col_character(),
#       kcal_day = col_double(),
#       g_day_ave = col_double(),
#       kcal_ratio = col_double(),
#       mass_ratio = col_double(),
#       g_per_kcal = col_double(),
#       notes = col_character()
#     )
#   )

```

```{r}
# knitr::kable(cdc_usd[,1:5], caption = "CDC NHANES actual American diet")
# knitr::kable(ela_phd[,1:4], caption = "EAT-Lancet Planetary Health Diet Plan")
# knitr::kable(fda_sdp[c(1,16,31,46,61,76,91,106),1:4], caption = "US Food and Drug Administration Healthy Diet Plan")
# knitr::kable(cns_cfp[,1:5], caption = "Chinese Nutrition Sociey Food Guide Pagoda Plan")

```

Each national diet plan groups foods a little differently. I use `national_food_plan_map` to normalise these. (E.g., The Chinese plan combines "cereals" with "potatoes" and "whole grains" with "mixed beans". If this is not a translation error, it could indicate a different grouping concept. But to make the conversion, I treated "cereals_potatoes" as cereals and "whole_grains_mixed_beans" as legumes.)

I have included g/kcal values based on the ELA-PHD food energy conversion rates.

```{r}
national_food_plan_map <-
  readr::read_csv(
    file = paste0(
      data_path,
      "National dietary plans - national_food_plan_map.csv"
    ),
    col_types = cols(
      national_food_plan = col_character(),
      national_food_plan_group = col_character(),
      model_group = col_character(), 
      g_kcal = col_double(), 
      source = col_character()
    )
  )
```

The national diet plans mapped to the standard food group typology follow. The USA-FDA plan advises a range of recommended daily quantities (here converted into kcal) for a range of recommended daily total kcal intakes. To compare the demands of all national plans, I will take the 2400 kcal per day numbers.
```{r}

ela_phd_mapped <- ela_phd %>%
  left_join(
    national_food_plan_map %>%
      dplyr::filter(national_food_plan == "ELA_PHD") %>%
      dplyr::rename(ELA_PHD = national_food_plan_group) %>%
      dplyr::select(-national_food_plan),
    by = "ELA_PHD"
  ) %>% 
  # dplyr::filter(ELA_PHD != "total") %>% 
  dplyr::group_by(model_group) %>% 
  dplyr::summarise(kcal_day = sum(kcal_day, na.rm = TRUE), 
                   # g_day_ave = sum(g_day_ave, na.rm = TRUE), 
                   g_kcal = mean(g_kcal, na.rm = TRUE), 
                   kcal_ratio = sum(kcal_ratio, na.rm = TRUE), 
                   mass_ratio = sum(mass_ratio, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::mutate(diet_plan = "ELA-PHD") %>% 
  dplyr::mutate(model_group = ifelse(is.na(model_group), "total", model_group)) # fix to a silly little omission

fda_sdp_mapped <- fda_sdp %>%
  left_join(
    national_food_plan_map %>%
      dplyr::filter(national_food_plan == "FDA_SDP") %>%
      dplyr::rename(FDA_SDP = national_food_plan_group) %>%
      dplyr::select(-national_food_plan),
    by = "FDA_SDP"
  ) %>% 
  # dplyr::filter(FDA_SDP != "total") %>% 
  dplyr::group_by(kcal_requirement, model_group) %>% 
  dplyr::summarise(kcal_day = sum(kcal_day, na.rm = TRUE), 
                   # g_day_ave = sum(g_day_ave, na.rm = TRUE), 
                   g_kcal = mean(g_kcal, na.rm = TRUE),
                   kcal_ratio = sum(kcal_ratio, na.rm = TRUE), 
                   mass_ratio = sum(mass_ratio, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::mutate(diet_plan = "FDA-SDP") %>% 
      dplyr::filter(kcal_requirement == 2400) %>%
      dplyr::select(-kcal_requirement) %>% 
  dplyr::mutate(model_group = ifelse(is.na(model_group), "total", model_group)) # fix to a silly little omission

cns_cfp_mapped <- cns_cfp %>% 
  dplyr::rename(model_group = CNS_CFP) %>% 
  dplyr::mutate(diet_plan = "CNS-CFP") %>% 
  dplyr::select(-g_day_ave)
  # 
  # left_join(
  #   national_food_plan_map %>%
  #     dplyr::filter(national_food_plan == "CNS_CFP") %>%
  #     dplyr::rename(CNS_CFP = national_food_plan_group) %>%
  #     dplyr::select(-national_food_plan),
  #   by = "CNS_CFP"
  # ) %>% 
  # dplyr::group_by(model_group) %>% 
  # dplyr::summarise(kcal_day = sum(kcal_day, na.rm = TRUE), 
  #                  # g_day_ave = sum(g_day_ave, na.rm = TRUE), 
  #                  g_kcal = mean(g_kcal, na.rm = TRUE),
  #                  kcal_ratio = sum(kcal_ratio, na.rm = TRUE), 
  #                  mass_ratio = sum(mass_ratio, na.rm = TRUE), 
  #                  .groups = "drop") %>% 
  # dplyr::mutate(diet_plan = "CNS-CFP") %>% 
  # dplyr::mutate(model_group = ifelse(is.na(model_group), "total", model_group)) # fix to a silly little omission

# cdc_usd_mapped <- cdc_usd %>%
#   left_join(
#     national_food_plan_map %>%
#       dplyr::filter(national_food_plan == "CDC_USD") %>%
#       dplyr::rename(CDC_USD = national_food_plan_group) %>%
#       dplyr::select(-national_food_plan),
#     by = "CDC_USD"
#   ) %>% 
#   dplyr::group_by(model_group) %>% 
#   dplyr::summarise(kcal_day = sum(kcal_day, na.rm = TRUE), 
#                    # g_day_ave = sum(g_day_ave, na.rm = TRUE), 
#                    g_kcal = mean(g_kcal, na.rm = TRUE),
#                    kcal_ratio = sum(kcal_ratio, na.rm = TRUE), 
#                    mass_ratio = sum(mass_ratio, na.rm = TRUE), 
#                    .groups = "drop") %>% 
#   dplyr::mutate(diet_plan = "CDC-USD") %>% 
#   dplyr::mutate(model_group = ifelse(is.na(model_group), "total", model_group)) # fix to a silly little omission


```


```{r}

all_plans_mapped <- ela_phd_mapped %>%
  dplyr::full_join(
    fda_sdp_mapped,
    by = c(
      "model_group",
      "kcal_day",
      "g_kcal",
      "kcal_ratio",
      "mass_ratio",
      "diet_plan"
    )
  ) %>%
  dplyr::full_join(
    cns_cfp_mapped,
    by = c(
      "model_group",
      "kcal_day",
      "g_kcal",
      "kcal_ratio",
      "mass_ratio",
      "diet_plan"
    )
  ) 
# %>%
#   dplyr::full_join(
#     cdc_usd_mapped,
#     by = c(
#       "model_group",
#       "kcal_day",
#       "g_kcal",
#       "kcal_ratio",
#       "mass_ratio",
#       "diet_plan"
#     )
#   )

```

In order to make a one-to-one comparison across diet plans, I normalise daily kcal requirements to 2300 kcal/day/cap.
```{r}

plan_kcal_totals <- all_plans_mapped %>%
  dplyr::filter(model_group != "total") %>%
  dplyr::group_by(diet_plan) %>%
  dplyr::summarise(
    kcal_day_total = sum(kcal_day, na.rm = TRUE),
    kcal_ratio_total = sum(kcal_ratio, na.rm = TRUE),
    .groups = "drop"
  )

all_plans_mapped <- all_plans_mapped %>%
  dplyr::left_join(plan_kcal_totals %>%
                     dplyr::select(-kcal_ratio_total), by = "diet_plan") %>%
  dplyr::mutate(normalisation = 2300 / kcal_day_total) %>%
  dplyr::mutate(kcal_day = kcal_day * normalisation) %>%
  dplyr::select(model_group, kcal_day, kcal_ratio, diet_plan)

```


The diet plans are summarised in the table.
```{r}

# knitr::kable(all_plans_mapped[,1:4], caption = "All diet plans")
head(all_plans_mapped)
```

Wrangle to widen data frames for each diet plan.
```{r}

ela_phd_wide <- all_plans_mapped %>% 
  dplyr::filter(diet_plan == "ELA-PHD" & model_group != "total") %>% 
  dplyr::select(diet_plan, model_group, kcal_ratio) %>% 
  tidyr::pivot_wider(., names_from = "model_group", values_from = "kcal_ratio")

fda_sdp_wide <- all_plans_mapped %>% 
  dplyr::filter(diet_plan == "FDA-SDP" & model_group != "total") %>% 
  dplyr::select(diet_plan, model_group, kcal_ratio) %>% 
  tidyr::pivot_wider(., names_from = "model_group", values_from = "kcal_ratio")

cns_cpf_wide <- all_plans_mapped %>% 
  dplyr::filter(diet_plan == "CNS-CFP" & model_group != "total") %>% 
  dplyr::select(diet_plan, model_group, kcal_ratio) %>% 
  tidyr::pivot_wider(., names_from = "model_group", values_from = "kcal_ratio")

# cdc_usd_wide <- all_plans_mapped %>% 
#   dplyr::filter(diet_plan == "CDC-USD" & model_group != "total") %>% 
#   dplyr::select(diet_plan, model_group, kcal_ratio) %>% 
#   tidyr::pivot_wider(., names_from = "model_group", values_from = "kcal_ratio")

```

Test: Confirm these work.
```{r}
ela_phd_wide %>% mutate(test = sum(across(.cols = beef_lamb_pork:vegetables))) %>% pull(test)
fda_sdp_wide %>% mutate(test = sum(across(.cols = cereals:vegetables))) %>% pull(test)
cns_cpf_wide %>% mutate(test = sum(across(.cols = beef_lamb_pork:vegetables))) %>% pull(test)
# cdc_usd_wide %>% mutate(test = sum(across(.cols = beef_lamb_pork:vegetables))) %>% pull(test)
```
They're good.

Merge these with the `kcal_edu` df and then group by animal products (meat, poultry, eggs), dairy, fish and seafood, and non-animal products.

```{r}
kcal_edu_phd <- kcal_edu %>% 
  dplyr::bind_cols(ela_phd_wide) %>% 
  dplyr::mutate(across(beef_lamb_pork:vegetables, ~ .x*millions*kcal_mean)) %>% 
  dplyr::group_by(SCENARIO, REGION, diet_plan, year) %>% 
  dplyr::summarise(across(beef_lamb_pork:vegetables, ~ sum(.x, na.rm = TRUE)), 
                   .groups = "drop") %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(animal_products = beef_lamb_pork + chicken_poultry + eggs + dairy, 
                plant_products = cereals + fruits + legumes + oils + roots_tubers + sugarcrops + treenuts + vegetables) %>% 
  dplyr::select(SCENARIO, REGION, diet_plan, year, animal_products, fish_seafood, plant_products)

kcal_edu_fda <- kcal_edu %>% 
  dplyr::bind_cols(fda_sdp_wide) %>% 
  dplyr::mutate(across(cereals:vegetables, ~ .x*millions*kcal_mean)) %>% 
  dplyr::group_by(SCENARIO, REGION, diet_plan, year) %>% 
  dplyr::summarise(across(cereals:vegetables, ~ sum(.x, na.rm = TRUE)), 
                   .groups = "drop") %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(animal_products = meat_poultry + dairy, 
                plant_products = cereals + fruits + oils + roots_tubers + sugarcrops + treenuts + vegetables) %>% 
  dplyr::select(SCENARIO, REGION, diet_plan, year, animal_products , fish_seafood, plant_products)


kcal_edu_cpf <- kcal_edu %>% 
  dplyr::bind_cols(cns_cpf_wide) %>% 
  dplyr::mutate(across(beef_lamb_pork:vegetables, ~ .x*millions*kcal_mean)) %>% 
  dplyr::group_by(SCENARIO, REGION, diet_plan, year) %>% 
  dplyr::summarise(across(beef_lamb_pork:vegetables, ~ sum(.x, na.rm = TRUE)), 
                   .groups = "drop") %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(animal_products = beef_lamb_pork + chicken_poultry + eggs + dairy, 
                plant_products = cereals + fruits + legumes + oils + roots_tubers + vegetables + treenuts + sugarcrops) %>% 
  dplyr::select(SCENARIO, REGION, diet_plan, year, animal_products, fish_seafood, plant_products)


# There appears to have been an error in my assumptions to make the CDC_USD diet data
# kcal_edu_cdc <- kcal_edu %>% 
#   dplyr::bind_cols(cdc_usd_wide) %>% 
#   dplyr::mutate(across(beef_lamb_pork:vegetables, ~ .x*millions*kcal_mean)) %>% 
#   dplyr::group_by(SCENARIO, REGION, diet_plan, year) %>% 
#   dplyr::summarise(across(beef_lamb_pork:vegetables, ~ sum(.x, na.rm = TRUE)), 
#                    .groups = "drop") %>% 
#   dplyr::ungroup() %>% 
#   dplyr::mutate(animal_products = beef_lamb_pork + chicken_poultry + eggs + dairy, 
#                 plant_products = cereals + fruits + legumes + roots_tubers + vegetables + sugarcrops + treenuts) %>% 
#   dplyr::select(SCENARIO, REGION, diet_plan, year, animal_products, fish_seafood, plant_products)

```

Now bind these by rows.
```{r}

all_plans_df <- kcal_edu_phd %>% 
  dplyr::bind_rows(kcal_edu_fda) %>% 
  dplyr::bind_rows(kcal_edu_cpf) 

```

Georeference country locations.
```{r}
all_plans_worldmap <- all_plans_df %>% 
  dplyr::rename(iso_alpha3 = REGION) %>% 
  dplyr::full_join(loc_map_reduced %>% 
                     dplyr::select(iso_alpha3, subregionname), 
                   by = "iso_alpha3") %>% 
  tidyr::drop_na(subregionname, diet_plan)
```

```{r}
all_plans_long <- all_plans_worldmap %>% 
  dplyr::group_by(SCENARIO, diet_plan, year) %>% 
  dplyr::summarise(across(animal_products:plant_products, ~sum(.x, na.omit = TRUE)), 
                   .groups = "drop") %>% 
  tidyr::pivot_longer(., cols = c(animal_products:plant_products), names_to = "food_source", values_to = "M_kcal_per_day")
```

```{r}
cols <-
  c(
    "animal_products" = "#F17EB8",
    # "dairy" = "#DED560",
    "fish_seafood" = "#489ED3",
    "plant_products" = "#EEAF35"
  )
xlabz <- c("CHN-CFP", "ELA-PHD", "USA-FDA")
labz <-
  c("Animal Products", "Fish and Seafood", "Plant Products")
ymax <- (max(all_plans_long$M_kcal_per_day)+0.02*max(all_plans_long$M_kcal_per_day))*1e-6

p3a <- ggplot(
  all_plans_long %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP1_v9_130115"),
  aes(x = diet_plan,
      y = M_kcal_per_day * 1e-6)
) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source),
           position = "stack") +
  scale_fill_manual(
    values = cols,
    labels = labz
  ) + 
  coord_cartesian(ylim = c(0, ymax)) + 
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.title = element_blank(), 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank()
  ) +
  labs(title = "SSP1", y = "Tkcal/day") +
  facet_wrap( ~ year)

p3_legend_only <- cowplot::get_legend(p3a)

p3a <- p3a +
  theme(legend.position = "none")

p3b <- ggplot(
  all_plans_long %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP2_v9_130115"),
  aes(x = diet_plan,
      y = M_kcal_per_day * 1e-6)
) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source),
           position = "stack") +
  scale_fill_manual(
    values = cols,
    labels = labz
  ) + 
  coord_cartesian(ylim = c(0, ymax)) + 
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP2", y = "Tkcal/day") +
  facet_wrap( ~ year)

p3c <- ggplot(
  all_plans_long %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP3_v9_130115"),
  aes(x = diet_plan,
      y = M_kcal_per_day * 1e-6)
) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source),
           position = "stack") +
  scale_fill_manual(
    values = cols,
    labels = labz
  ) + 
  coord_cartesian(ylim = c(0, ymax)) + 
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
     panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP3", y = "Tkcal/day") +
  facet_wrap( ~ year)

p3d <- ggplot(
  all_plans_long %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP4d_v9_130115"),
  aes(x = diet_plan,
      y = M_kcal_per_day * 1e-6)
) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source),
           position = "stack") +
  scale_fill_manual(
    values = cols,
    labels = labz
  ) + 
  coord_cartesian(ylim = c(0, ymax)) + 
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank()
  ) +
  labs(title = "SSP4", y = "Tkcal/day") +
  facet_wrap( ~ year)

p3e <- ggplot(
  all_plans_long %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP5_v9_130115"),
  aes(x = diet_plan,
      y = M_kcal_per_day * 1e-6)
) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source),
           position = "stack") +
  scale_fill_manual(
    values = cols,
    labels = labz
  ) + 
  coord_cartesian(ylim = c(0, ymax)) + 
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP5", y = "Tkcal/day") +
  facet_wrap( ~ year)

```

```{r}

p3 <- cowplot::plot_grid(p3a, p3b, p3c, p3d, p3e, p3_legend_only)
p3

```

Now plot in terms of relative change from demand in 2020.

```{r}
totals_2020 <- all_plans_long %>% 
  dplyr::mutate(M_kcal_day_2020 = ifelse(year == 2020, M_kcal_per_day, NA)) %>% 
  dplyr::group_by(SCENARIO, diet_plan) %>% 
  dplyr::filter(year == 2020) %>% 
  dplyr::summarise(total_kcal_2020 = sum(M_kcal_per_day, na.rm = TRUE), .groups = "drop")

diff_kcal_to_2020 <- all_plans_long %>%
  dplyr::mutate(M_kcal_day_2020 = ifelse(year == 2020, M_kcal_per_day, NA)) %>%
  dplyr::group_by(SCENARIO, diet_plan, food_source) %>%
  tidyr::fill(M_kcal_day_2020, .direction = "updown") %>%
  dplyr::ungroup() %>%
  dplyr::mutate(diff_kcal_day = M_kcal_per_day - M_kcal_day_2020) %>%
  dplyr::select(-M_kcal_per_day,-M_kcal_day_2020) %>%
  dplyr::left_join(totals_2020, by = c("SCENARIO", "diet_plan")) %>% 
  dplyr::mutate(rel_diff_kcal_day = diff_kcal_day/total_kcal_2020)

```


Plot shows the relative change in daily kcal demand compared to 2020 for the different SSPs.
```{r}
library(scales)

# ymax <- (max(diff_kcal_to_2020$rel_diff_kcal_day)+0.001*max(diff_kcal_to_2020$rel_diff_kcal_day)) 
# ymin <- (min(diff_kcal_to_2020$rel_diff_kcal_day)-0.001*min(diff_kcal_to_2020$rel_diff_kcal_day)) 
ymax <- 0.5
ymin <- -0.05

p4a <- ggplot(
  diff_kcal_to_2020 %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) & 
                    # dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP1_v9_130115"),
  aes(x = diet_plan,
      y = rel_diff_kcal_day)
) + 
  geom_hline(yintercept = 0, alpha = 0.8) + 
  geom_col(aes(fill = food_source),
           position = "stack") +
  scale_fill_manual(
    values = cols,
    labels = labz
  ) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.title = element_blank(), 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 8)
  ) +
  labs(title = "SSP1", y = "Relative to 2020 demand") +
  facet_wrap( ~ year)

p4_legend_only <- cowplot::get_legend(p4a)

p4a <- p4a +
  theme(legend.position = "none")

p4b <- ggplot(
  diff_kcal_to_2020 %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) & 
                    # dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP2_v9_130115"),
  aes(x = diet_plan,
      y = rel_diff_kcal_day)
) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source),
           position = "stack") +
  scale_fill_manual(
    values = cols,
    labels = labz
  ) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) + 
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP2") +
  facet_wrap( ~ year)

p4c <- ggplot(
  diff_kcal_to_2020 %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) & 
                    # dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP3_v9_130115"),
  aes(x = diet_plan,
      y = rel_diff_kcal_day)
) + 
  geom_hline(yintercept = 0, alpha = 0.8) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  geom_col(aes(fill = food_source),
           position = "stack") +
  scale_fill_manual(
    values = cols,
    labels = labz
  ) + 
  coord_cartesian(ylim = c(ymin, ymax)) + 
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP3") +
  facet_wrap( ~ year)

p4d <- ggplot(
  diff_kcal_to_2020 %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) & 
                    # dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP4d_v9_130115"),
  aes(x = diet_plan,
      y = rel_diff_kcal_day)
) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source),
           position = "stack") +
  scale_fill_manual(
    values = cols,
    labels = labz
  ) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) + 
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 8)
  ) +
  labs(title = "SSP4", y = "Relative to 2020 demand") +
  facet_wrap( ~ year)

p4e <- ggplot(
  diff_kcal_to_2020 %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) & 
                    # dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP5_v9_130115"),
  aes(x = diet_plan,
      y = rel_diff_kcal_day)
) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source),
           position = "stack") +
  scale_fill_manual(
    values = cols,
    labels = labz
  ) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) + 
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP5") +
  facet_wrap( ~ year)

```


```{r}

p4 <- cowplot::plot_grid(p4a, p4b, p4c, p4d, p4e, p4_legend_only)
p4
```

How do these demands break down by country? Merge with `kcal_edu` as before, but this time do not aggregate food types into animal, plant and aquatic sources.
```{r}
kcal_edu_phd <- kcal_edu %>% 
  dplyr::bind_cols(ela_phd_wide) %>% 
  dplyr::mutate(across(beef_lamb_pork:vegetables, ~ .x*millions*kcal_mean)) %>% 
  dplyr::group_by(SCENARIO, REGION, diet_plan, year) %>% 
  dplyr::summarise(across(beef_lamb_pork:vegetables, ~ sum(.x, na.rm = TRUE)), 
                   .groups = "drop") %>% 
  dplyr::ungroup()

kcal_edu_fda <- kcal_edu %>% 
  dplyr::bind_cols(fda_sdp_wide) %>% 
  dplyr::mutate(across(cereals:vegetables, ~ .x*millions*kcal_mean)) %>% 
  dplyr::group_by(SCENARIO, REGION, diet_plan, year) %>% 
  dplyr::summarise(across(cereals:vegetables, ~ sum(.x, na.rm = TRUE)), 
                   .groups = "drop") %>% 
  dplyr::ungroup() 


kcal_edu_cpf <- kcal_edu %>% 
  dplyr::bind_cols(cns_cpf_wide) %>% 
  dplyr::mutate(across(beef_lamb_pork:vegetables, ~ .x*millions*kcal_mean)) %>% 
  dplyr::group_by(SCENARIO, REGION, diet_plan, year) %>% 
  dplyr::summarise(across(beef_lamb_pork:vegetables, ~ sum(.x, na.rm = TRUE)), 
                   .groups = "drop") %>% 
  dplyr::ungroup() 


# kcal_edu_cdc <- kcal_edu %>% 
#   dplyr::bind_cols(cdc_usd_wide) %>% 
#   dplyr::mutate(across(beef_lamb_pork:vegetables, ~ .x*millions*kcal_mean)) %>% 
#   dplyr::group_by(SCENARIO, REGION, diet_plan, year) %>% 
#   dplyr::summarise(across(beef_lamb_pork:vegetables, ~ sum(.x, na.rm = TRUE)), 
#                    .groups = "drop") %>% 
#   dplyr::ungroup() 

```

all_plans_mapped

Now bind these by rows.
```{r}

all_plans_df <- kcal_edu_phd %>% 
  dplyr::bind_rows(kcal_edu_fda) %>% 
  dplyr::bind_rows(kcal_edu_cpf) %>% 
  # dplyr::bind_rows(kcal_edu_cdc) %>% 
  dplyr::rename(iso_alpha3 = REGION) %>% 
  dplyr::left_join(loc_map_reduced %>% 
                     dplyr::select(iso_alpha3, subregionname), 
                   by = "iso_alpha3")

all_plans_df1 <- kcal_edu_phd %>% 
  dplyr::full_join(kcal_edu_fda) %>% 
  dplyr::full_join(kcal_edu_cpf) %>% 
  # dplyr::full_join(kcal_edu_cdc) %>% 
  dplyr::rename(iso_alpha3 = REGION) %>% 
  dplyr::left_join(loc_map_reduced %>% 
                     dplyr::select(iso_alpha3, subregionname), 
                   by = "iso_alpha3")

```


### Crop demand

What crop production is required to satisfy each dietary guideline, by country?

```{r}
output_path <-
  "/home/thomson/Projects/iep_food/IEP_food_demand_files/"
# readr::write_csv(EATlancet_diet_map,
#                  file = paste0(output_path, "EATlancet_diet_map", ".csv"))
```

Estimate average food mass to kcal densities given by the EAT-Lancet diet numbers.
```{r}

density_diet_map <- national_food_plan_map %>% 
  dplyr::select(model_group, g_kcal) %>% 
  dplyr::distinct()

# density_diet_map <-
#   readr::read_csv(
#     file = paste0(output_path, "EATlancet_diet_map", ".csv"),
#     col_types = cols(
#       EATlancet_group = col_character(),
#       kcal_day = col_double(),
#       g_day_ave = col_double(),
#       g_day_min = col_double(),
#       g_day_max = col_double(),
#       kcal_ratio = col_double(),
#       mass_ratio = col_double()
#     )
#   )
# g_kcal_density <- density_diet_map %>%
#   dplyr::mutate(g_kcal = g_day_ave / kcal_day) %>%
#   dplyr::select(EATlancet_group, g_kcal) %>% 
#   dplyr::rename(model_group = EATlancet_group)
```


Filter out animal and fish products for crops only.
```{r}

food_weight <- all_plans_df %>%
  dplyr::select(-beef_lamb_pork,
                -chicken_poultry,
                -dairy,
                -eggs,
                -fish_seafood,
                -meat_poultry) %>%
  tidyr::pivot_longer(cols = cereals:vegetables,
                      names_to = "model_group",
                      values_to = "Mkcal_day") %>%
  dplyr::left_join(density_diet_map, by = "model_group") %>% 
  dplyr::mutate(tonnes_day_food = Mkcal_day*g_kcal)

head(food_weight)
```

```{r}
# food_weight %>% filter(iso_alpha3 == "ABW" & diet_plan == "CNS-CFP")
```


Consider crop weight at harvest is greater than food weight, following processing. I use value chain loss, based on data found in Alexander et al. (2017).

Source: [Alexander, P., Brown, C., Arneth, A., Finnigan, J., Moran, D. and Rounsevell, M.D., 2017. Losses, inefficiencies and waste in the global food system. Agricultural systems, 153, pp.190-200.](https://doi.org/10.1016/j.agsy.2017.01.014)
```{r}
value_chain_loss <-
  readr::read_csv(
    file = "~/Data/IEP_Model/data_iep_model/Alexander_etal_2017_food_waste - summary.csv",
    col_types = cols(.default = col_double(),
                     iep_subregions = col_character())
  )
```

```{r}
vcl_long <- value_chain_loss %>%
  pivot_longer(cols = cereal:treenut, values_to = "value_loss")
```

Standardise groupings of food sources.
```{r}
vcl_prod_mapper <- data.frame(
  name = c(
    "cereal",
    "fish_meat",
    "fruit",
    "vegetable",
    "bovine_dairy",
    "bovine_meat",
    "aves_meat",
    "aves_dairy",
    "oilcrop",
    "pulse",
    "rootstubers",
    "sugarcrop",
    "treenut"
  ),
  model_group = c(
    "cereals",
    "fish_seafood",
    "fruits",
    "vegetables",
    "dairy",
    "beef_lamb_pork",
    "meat_poultry",
    "eggs",
    "oils",
    "legumes",
    "roots_tubers",
    "sugarcrops",
    "treenuts"
  )
)

```

```{r}
vcl <- vcl_long %>% 
  dplyr::right_join(vcl_prod_mapper, by = "name") %>% 
  dplyr::select(-name)
```

The quantity (tonnes per day) of crops (before being processed for consumption) is estimated as the quotient of the `food_weight` and `vcl`, processing loss and waste through the value chain.
```{r}
crop_weight <- food_weight %>% 
  dplyr::rename(iep_subregions = subregionname) %>% 
  dplyr::left_join(vcl, by = c("model_group", "iep_subregions")) %>% 
  dplyr::mutate(tonnes_day_crop = tonnes_day_food/value_loss) %>% 
  dplyr::select(-Mkcal_day, -g_kcal, -tonnes_day_food)

head(crop_weight)
```


### Livestock feed demand

Next consider feed crop demand from livestock, based on feed conversion ratios (FCRs). I will analyse these data by `model_group` assumming the following (global average) proportions of livestock production by type:

```{r}
animal_protein_matrix <- readr::read_csv(
  paste0(
    data_path,
    "National dietary plans - animal_protein_mashup_matrix.csv"
  ),
  col_types = cols(
    model_group = col_character(),
    subregion = col_character(),
    bovine_meat = col_double(),
    bovine_dairy = col_double(),
    poultry_meat = col_double(),
    poultry_eggs = col_double(),
    sus_meat = col_double(),
    caprine_meat = col_double(),
    caprine_dairy = col_double(),
    fish = col_double(),
    other_seafood = col_double(),
    freshwater_fish = col_double(),
    source = col_character()
  )
) %>% 
  dplyr::select(-subregion, -source)
```


```{r}
live_food_weight <- all_plans_df %>%
  dplyr::select(SCENARIO, iso_alpha3, subregionname, diet_plan, year, beef_lamb_pork,
                chicken_poultry,
                dairy,
                eggs,
                fish_seafood,
                meat_poultry) %>%
  tidyr::pivot_longer(cols = beef_lamb_pork:meat_poultry,
                      names_to = "model_group",
                      values_to = "Mkcal_day") %>%
  dplyr::left_join(density_diet_map, by = "model_group") %>% 
  dplyr::mutate(tonnes_day_food = Mkcal_day*g_kcal)

head(live_food_weight)
```

Merge with `animal_protein_matrix` to find the food tonnes per day of animal products.
```{r}
model_group_live_food_weight <- live_food_weight %>%
  dplyr::left_join(animal_protein_matrix, by = "model_group") %>%
  dplyr::mutate(across(.cols = bovine_meat:freshwater_fish) * tonnes_day_food) %>%
  dplyr::select(-model_group,-Mkcal_day,-g_kcal,-tonnes_day_food) %>%
  tidyr::drop_na() %>%
  tidyr::pivot_longer(
    .,
    cols = bovine_meat:freshwater_fish,
    values_to = "tonnes_day",
    names_to = "model_group"
  )


```

Now use carcass weight FCR to determine how much dry matter each livestock class would consume.

Feed conversion ratio. Source: [Livestock conversion efficiencies are given as reported in Alexander et al. (2016). Alexander, P., Brown, C., Arneth, A., Finnigan, J., & Rounsevell, M. D. (2016). Human appropriation of land for food: the role of diet. Global Environmental Change, 41, 88-98.]("http://www.sciencedirect.com/science/article/pii/S0959378016302370?via%3Dihub#bib0330")

```{r}
# fcr_map <-
#   data.frame(
#     model_group = c(
#       "bovine_meat",
#       "bovine_dairy",
#       "poultry_meat",
#       "poultry_eggs",
#       "sus_meat",
#       "caprine_meat",
#       "caprine_dairy",
#       "fish",
#       "other_seafood",
#       "freshwater_fish"
#     ),
#     fcr = c(8, 8, 1.9, 1.9, 3.9, 5, 5, 1.3, 0, 1.3)
#   )

fcr_map <-
  data.frame(
    model_group = c(
      "bovine_meat",
      "bovine_dairy",
      "poultry_meat",
      "poultry_eggs",
      "sus_meat",
      "caprine_meat",
      "caprine_dairy",
      "fish",
      "other_seafood",
      "freshwater_fish"
    ),
    fcr = c(25, 0.7, 3.3, 2.3, 3.9, 15, 0.7, 1.3, 0, 1.3)
  )

```

<!-- Convert animal products into parent livestock type, here termed "product_yield". For meat products, this is equivalent to "dressing percentage"/"carcass yield"; for dairy, this is estimated.  -->

<!-- Sources: (1) pigs [Boler, DD. 2014. In Encyclopedia of Meat Sciences (Second Edition), p.363-368]("https://doi.org/10.1016/B978-0-12-384731-7.00079-9"); (2) poultry [Maurer, AJ. 2003. In Encyclopedia of Food Sciences and Nutrition, p.4686-4689]("https://doi.org/10.1016/B0-12-227055-X/00953-6"); (3) sheep [Berg, EP, McFadin Walker, EL. 2004. In Encyclopedia of Meat Sciences, p.1291-1295]("https://doi.org/10.1016/B0-12-464970-X/00108-2"); (4) cattle [Price, MA. 2004. In Encyclopedia of Meat Sciences, p.1277-1284]("https://doi.org/10.1016/B0-12-464970-X/00107-0") -->
<!-- ```{r} -->

<!-- model_group = c("bovine_meat", -->
<!--       "bovine_dairy", -->
<!--       "poultry_meat", -->
<!--       "poultry_eggs", -->
<!--       "sus_meat", -->
<!--       "caprine_meat", -->
<!--       "caprine_dairy", -->
<!--       "fish", -->
<!--       "other_seafood", -->
<!--       "freshwater_fish") -->
<!-- product_yield = c(0.63, -->
<!--       "bovine_dairy", -->
<!--       0.76, -->
<!--       "poultry_eggs", -->
<!--       "sus_meat", -->
<!--       0.5, -->
<!--       "caprine_dairy", -->
<!--       0.89, -->
<!--       "other_seafood", -->
<!--       0.89) -->

<!-- ``` -->


```{r}
live_feed_weight <- model_group_live_food_weight %>% 
  dplyr::left_join(fcr_map, by = "model_group") %>% 
  dplyr::mutate(tonnes_day = tonnes_day*fcr) %>% 
  dplyr::select(-fcr)

head(live_feed_weight)
```



## Feed mixtures

What mixture of crops is used for feed? This varies by country. I use food and feed balance data from FAOSTAT to estimate average feed ingredient mixtures for each geographic sub-region, which I then use to inform national-level feed mixture estimates.

```{r}
if(!exists("food_balance_data")){
  food_balance_data <- read.csv(file = "~/Projects/iep_food/data/FAO/FoodBalanceSheetsHistoric_E_All_Data_(Normalized).csv", 
                                header = TRUE, 
                                stringsAsFactors = FALSE) %>% 
    dplyr::filter(Year.Code >= 2000)
}

if(!exists("combined_item_group_mapper")){
  source(file = "~/Projects/IEP_2/Model/R_files/Data_files/FAO_item_group_mapper.R") #combined_item_group_mapper
}

food_balance_data_defs <- food_balance_data %>% 
  full_join(combined_item_group_mapper, 
            by = c("Item.Code", "Item"))
```


```{r}

feed_regions <- food_balance_data_defs %>% 
  dplyr::filter(Element.Code == 5521 & !is.na(model_group)) %>% 
  dplyr::group_by(Area.Code, Area, Year, model_group) %>% 
  dplyr::summarise(feed_tonnes = sum(Value, na.rm = TRUE)*1e3, 
                   .groups = "drop")

food_regions <- food_balance_data_defs %>% 
  dplyr::filter(Element.Code == 5142 & !is.na(model_group)) %>% 
  dplyr::group_by(Area.Code, Area, Year, model_group) %>% 
  dplyr::summarise(food_tonnes = sum(Value, na.rm = TRUE)*1e3, 
                   .groups = "drop")

seed_regions <- food_balance_data_defs %>% 
  dplyr::filter(Element.Code == 5527 & !is.na(model_group)) %>% 
  dplyr::group_by(Area.Code, Area, Year, model_group) %>% 
  dplyr::summarise(seed_tonnes = sum(Value, na.rm = TRUE)*1e3, 
                   .groups = "drop")

proc_regions <- food_balance_data_defs %>% 
  dplyr::filter(Element.Code == 5131 & !is.na(model_group)) %>% 
  dplyr::group_by(Area.Code, Area, Year, model_group) %>% 
  dplyr::summarise(proc_tonnes = sum(Value, na.rm = TRUE)*1e3, 
                   .groups = "drop")

othe_regions <- food_balance_data_defs %>% 
  dplyr::filter(Element.Code == 5154 & !is.na(model_group)) %>% 
  dplyr::group_by(Area.Code, Area, Year, model_group) %>% 
  dplyr::summarise(othe_tonnes = sum(Value, na.rm = TRUE)*1e3, 
                   .groups = "drop")

loss_regions <- food_balance_data_defs %>% 
  dplyr::filter(Element.Code == 5123 & !is.na(model_group)) %>% 
  dplyr::group_by(Area.Code, Area, Year, model_group) %>% 
  dplyr::summarise(loss_tonnes = sum(Value, na.rm = TRUE)*1e3, 
                   .groups = "drop")

products_countries <- food_regions %>% 
  dplyr::full_join(feed_regions, 
                   by = c("Area.Code", "Area", "Year", "model_group")) %>% 
  dplyr::full_join(seed_regions, 
                   by = c("Area.Code", "Area", "Year", "model_group")) %>% 
  dplyr::full_join(loss_regions, 
                   by = c("Area.Code", "Area", "Year", "model_group")) %>% 
  dplyr::full_join(proc_regions, 
                   by = c("Area.Code", "Area", "Year", "model_group")) %>% 
  dplyr::full_join(othe_regions, 
                   by = c("Area.Code", "Area", "Year", "model_group")) %>% 
  dplyr::mutate_each(funs(replace(., which(is.na(.)), 0))) %>% 
  dplyr::mutate(total = rowSums(across(food_tonnes:othe_tonnes)))

```

According to FAO, quantities of agricultural products used for food, feed, seed, other uses, in processing, or lost are as follows:

```{r}

products_regions <- products_countries %>% 
  dplyr::rename(fao_countrycode = Area.Code) %>% 
  dplyr::full_join(loc_map_reduced %>% 
                     dplyr::select(iso_alpha3, fao_countrycode, subregionname), 
                   by = "fao_countrycode") %>% 
  dplyr::group_by(subregionname, Year, model_group) %>% 
  dplyr::summarise(
    food_tonnes = sum(food_tonnes, na.rm = TRUE), 
    feed_tonnes = sum(feed_tonnes, na.rm = TRUE), 
    seed_tonnes = sum(seed_tonnes, na.rm = TRUE), 
    loss_tonnes = sum(loss_tonnes, na.rm = TRUE), 
    proc_tonnes = sum(proc_tonnes, na.rm = TRUE), 
    othe_tonnes = sum(othe_tonnes, na.rm = TRUE), 
    total = sum(total, na.rm = TRUE), 
    .groups = "drop"
    )

head(products_regions)

```



```{r}

prod_regions <- food_balance_data_defs %>% 
  dplyr::filter(Element.Code == 5511 & !is.na(model_group)) %>% 
  dplyr::group_by(Area.Code, Area, Year, model_group) %>% 
  dplyr::summarise(prod_tonnes = sum(Value, na.rm = TRUE)*1e3, 
                   .groups = "drop")

imports_regions <- food_balance_data_defs %>% 
  dplyr::filter(Element.Code == 5611 & !is.na(model_group)) %>% 
  dplyr::group_by(Area.Code, Area, Year, model_group) %>% 
  dplyr::summarise(import_tonnes = sum(Value, na.rm = TRUE)*1e3, 
                   .groups = "drop")

exports_regions <- food_balance_data_defs %>% 
  dplyr::filter(Element.Code == 5911 & !is.na(model_group)) %>% 
  dplyr::group_by(Area.Code, Area, Year, model_group) %>% 
  dplyr::summarise(export_tonnes = -sum(Value, na.rm = TRUE)*1e3, 
                   .groups = "drop")

stockvar_regions <- food_balance_data_defs %>% 
  dplyr::filter(Element.Code == 5072 & !is.na(model_group)) %>% 
  dplyr::group_by(Area.Code, Area, Year, model_group) %>% 
  dplyr::summarise(stockvar_tonnes = sum(Value, na.rm = TRUE)*1e3, 
                   .groups = "drop")

```

```{r}

stocks_countries <- prod_regions %>% 
  dplyr::full_join(imports_regions, 
                   by = c("Area.Code", "Area", "Year", "model_group")) %>% 
  dplyr::full_join(exports_regions, 
                   by = c("Area.Code", "Area", "Year", "model_group")) %>% 
  dplyr::full_join(stockvar_regions, 
                   by = c("Area.Code", "Area", "Year", "model_group")) %>% 
  dplyr::mutate_each(funs(replace(., which(is.na(.)), 0))) %>%
  dplyr::mutate(total = rowSums(across(prod_tonnes:stockvar_tonnes))) %>% 
  dplyr::full_join(loc_map_reduced, 
                   by = c("Area.Code" = "fao_countrycode")) %>% 
  dplyr::select(subregionname, countryname, iso_alpha3, Year, model_group, prod_tonnes:total)

head(stocks_countries)
```

```{r}

stocks_regions <- stocks_countries %>% 
  dplyr::group_by(subregionname, Year, model_group) %>% 
  dplyr::summarise(
    prod_tonnes = sum(prod_tonnes, na.rm = TRUE), 
    import_tonnes = sum(import_tonnes, na.rm = TRUE), 
    export_tonnes = sum(export_tonnes, na.rm = TRUE), 
    stockvar_tonnes = sum(stockvar_tonnes, na.rm = TRUE), 
    total = sum(total, na.rm = TRUE), 
    .groups = "drop"
  )

head(stocks_regions)

```

I want to test the quality of the data. I join the data frame `products_regions` containing food, feed, seed, etc. data (summed to 'total_products') with the data frame `stocks_regions` containing production, import/export, etc. data (summed to 'total_stocks'). I expect that the totals should be equivalent.

```{r}

test <- dplyr::full_join(products_regions %>% 
                   dplyr::rename(total_products = total), 
                 stocks_regions %>% 
                   dplyr::rename(total_stocks = total), 
                 by = c("subregionname", "Year", "model_group")) %>% 
  dplyr::mutate(diff = total_products - total_stocks)

head(test)

ggplot(test, 
       aes(x = diff*1e-3)) + 
  geom_histogram(bins = 1000) + 
  coord_cartesian(xlim = c(-10, 250)) + 
  labs(
    x = "1000 tonnes", 
    y = "counts"
  )

```

The totals are nearly equivalent. I will take 'total_products' as domestic usage and use these to determine livestock feed mixtures. I will assume for the moment that all livestock/fish feed mixtures are the same, but unique to regions.

Determine livestock/fish feed mixtures by region. NB: I also standardise the model_groups here.

```{r}

feed_regimes_regions <- products_regions %>%
  dplyr::select(subregionname, Year, model_group, feed_tonnes) %>%
  dplyr::group_by(subregionname, Year) %>%
  dplyr::mutate(
    feed_sum = sum(feed_tonnes, na.rm = TRUE),
    feed_ratio = ifelse(feed_sum != 0,
                        feed_tonnes / feed_sum,
                        0)
  ) %>%
  dplyr::filter(feed_ratio > 0) %>%
  ungroup() %>%
  dplyr::mutate(model_group = ifelse(
    model_group %in% c("fish_meat", "fish_other", "aquaticmarine_product"),
    "fish",
    ifelse(
      model_group == "aves_dairy",
      "eggs",
      ifelse(
        model_group %in% c("citrus", "fruit"),
        "fruits",
        ifelse(
          model_group == "oilcrop",
          "oils",
          ifelse(
            model_group == "pulse",
            "legumes",
            ifelse(
              model_group == "vegetable",
              "vegetables",
              ifelse(
                model_group == "sugarcrop",
                "sugarcrops",
                ifelse(model_group == "rootstubers", "roots_tubers",
                       model_group)
              )
            )
          )
        )
      )
    )
  )) %>%
  dplyr::group_by(subregionname, Year, model_group) %>%
  dplyr::summarise(
    feed_tonnes = sum(feed_tonnes, na.rm = TRUE),
    feed_ratio = sum(feed_ratio, na.rm = TRUE),
    .groups = "drop"
  )


head(feed_regimes_regions)

```

```{r}

test <- ggplot(feed_regimes_regions %>% 
         filter(subregionname == "Eastern Europe"), 
       aes(x = Year, 
           y = feed_ratio)) + 
  geom_line(aes(colour = model_group)) + 
  theme_bw() + 
  labs(
    title = "Ingredients of livestock and fish feeds",  
    subtitle = "Eastern Europe", 
    x = "year", 
    y = "proportion of total feed by weight", 
    caption = "Data: FAOSTAT"
  )

test
```

For every tonne of feed dry matter going to livestock (of any type), I assume (for the moment) that half comes from pasture and half from feed. The pasture_silage and feed mixture regime is in the following proportions:

```{r}

feed_regime <- feed_regimes_regions %>% 
  dplyr::group_by(subregionname, model_group) %>% 
  dplyr::summarise(feed_ratio_ave = mean(feed_ratio, na.rm = TRUE)) %>% 
  dplyr::mutate(norm = sum(feed_ratio_ave, na.rm = TRUE), 
                feed_ratio_ave = feed_ratio_ave/norm) %>% 
  dplyr::select(-norm) %>% 
  dplyr::ungroup() %>% 
  tidyr::pivot_wider(., 
                     names_from = model_group, 
                     values_from = feed_ratio_ave, 
                     values_fill = 0) %>% 
  dplyr::mutate(pasture_silage = 1) %>% 
  dplyr::mutate(across(bovine_dairy:pasture_silage)*0.5)

# head(feed_regime)

```

The FAO data does not include sufficient information for Micronesia, therefore, we pass the proportions from Melanesia to Micronesia.
```{r}

test <- feed_regime %>% 
  dplyr::filter(subregionname == "Micronesia") 

if(dim(test)[1] == 0) {
  feed_regime_micronesia <- feed_regime %>% 
  dplyr::filter(subregionname == "Melanesia") %>% 
  dplyr::mutate(subregionname = "Micronesia")
  
  feed_regime <- feed_regime %>% 
    dplyr::bind_rows(feed_regime_micronesia)
  
}

```

The ratios of major animal feed ingredients by region are given in `feed_regime`. This is merged with `live_feed_weight` to get an estimate of the feed demand (by mass) by ingredient for each country.
```{r}
feed_ingredient_demand <- live_feed_weight %>% 
  dplyr::left_join(feed_regime, by = "subregionname") %>% 
  dplyr::mutate(across(bovine_dairy:caprine_meat)*tonnes_day) %>% 
  dplyr::select(-tonnes_day)

head(feed_ingredient_demand)
```

Now summarise to find the total demand of feed ingredients by scenario, diet, and country.
```{r}
feed_ingredient_demand_summary <- feed_ingredient_demand %>%
  dplyr::group_by(SCENARIO, iso_alpha3, subregionname, diet_plan, year) %>%
  dplyr::summarise(
    bovine_dairy = sum(bovine_dairy, na.rm = TRUE),
    bovine_meat = sum(bovine_meat, na.rm = TRUE),
    cereal = sum(cereal, na.rm = TRUE),
    fish = sum(fish, na.rm = TRUE),
    legumes = sum(legumes, na.rm = TRUE),
    oils = sum(oils, na.rm = TRUE),
    roots_tubers = sum(roots_tubers, na.rm = TRUE),
    sugarcrops = sum(sugarcrops, na.rm = TRUE),
    fruits = sum(fruits, na.rm = TRUE),
    sus_meat = sum(sus_meat, na.rm = TRUE),
    vegetables = sum(vegetables, na.rm = TRUE),
    eggs = sum(eggs, na.rm = TRUE),
    stimulants = sum(stimulants, na.rm = TRUE),
    caprine_meat = sum(caprine_meat, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  tidyr::pivot_longer(
    .,
    cols = bovine_dairy:caprine_meat,
    names_to = "model_group",
    values_to = "tonnes_day"
  )

head(feed_ingredient_demand_summary)
```

What is the total world feed demand by scenario and diet?
```{r}
test <- feed_ingredient_demand_summary %>%
  dplyr::group_by(SCENARIO, diet_plan, year) %>%
  dplyr::summarise(tonnes_day = sum(tonnes_day, na.rm = TRUE),
                   .groups = "drop") %>%
  dplyr::mutate(tonnes_year = tonnes_day * 365)

test_2020 <- test %>%
  dplyr::filter(year == 2020) %>%
  dplyr::mutate(tonnes_year_2020 = tonnes_year)

test <- test %>%
  dplyr::filter(year >= 2020) %>%
  dplyr::left_join(test_2020,
                   by = c("SCENARIO", "diet_plan", "year", "tonnes_day", "tonnes_year")) %>%
  dplyr::group_by(SCENARIO, diet_plan) %>%
  tidyr::fill(tonnes_year_2020) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(SCENARIO, diet_plan, year) %>% 
  dplyr::summarise(surplus = (tonnes_year - tonnes_year_2020), 
                   .groups = "drop")

head(test)
```

What is the global demand of crops for food and feed? 
```{r}
global_crop_demand_for_feed <- feed_ingredient_demand_summary %>% 
  dplyr::filter(!model_group %in% c("bovine_dairy", "bovine_meat", "fish", "sus_meat", "caprine_meat", "eggs")) %>% 
  dplyr::group_by(SCENARIO, diet_plan, year) %>% 
  dplyr::summarise(tonnes_day = sum(tonnes_day, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::mutate(crop_class = "feed")

global_crop_demand_for_food <- food_weight %>% 
  dplyr::group_by(SCENARIO, diet_plan, year) %>% 
  dplyr::summarise(tonnes_day = sum(tonnes_day_food, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::mutate(crop_class = "food")

global_crop_demand_food_feed <- global_crop_demand_for_feed %>% 
  dplyr::bind_rows(global_crop_demand_for_food) %>% 
  dplyr::mutate(tonnes_yr = tonnes_day*365)

diff <- global_crop_demand_food_feed %>% 
  dplyr::mutate(tonnes_yr_2020 = ifelse(year == 2020, 
                tonnes_yr, 
                NA)) %>% 
  dplyr::group_by(SCENARIO, diet_plan, crop_class) %>% 
  tidyr::fill(tonnes_yr_2020) %>% 
  dplyr::filter(year %in% c(2025, 2050, 2075)) %>% 
  dplyr::mutate(diff = tonnes_yr - tonnes_yr_2020)

global_crop_demand_food_feed_diff <- global_crop_demand_food_feed %>% 
  left_join(diff)

```


```{r}
# library(scales)

global_crop_demand_food_feed_diff <- global_crop_demand_food_feed_diff %>% 
  dplyr::mutate(diet_plan_f = diet_plan)

global_crop_demand_food_feed_diff$diet_plan_f <- factor(global_crop_demand_food_feed_diff$diet_plan_f, levels = c("ELA-PHD", "CNS-CFP", "FDA-SDP"))


```

```{r}
cols <- data.frame(
  food = "#EEAF35", 
  feed = "#F17EB8"
)
labz <- c("food", "feed")

# ymax <- (max(global_crop_demand_food_feed_diff$diff) + 0.05 * max(global_crop_demand_food_feed_diff$diff)) * 1e-9
# ymin <- 0

ymax <- 1 
ymin <- -0.1 


p5a <- ggplot(
  global_crop_demand_food_feed_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP1_v9_130115"),
  aes(x = diet_plan_f,
      y = diff/tonnes_yr_2020)
) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8) + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  #  scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.title = element_blank(), 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP1", y = "Relative to 2020 demand") +
  facet_wrap( ~ year)

p5_legend_only <- cowplot::get_legend(p5a)

p5a <- p5a +
  theme(legend.position = "none")

p5b <- ggplot(
  global_crop_demand_food_feed_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP2_v9_130115"),
   aes(x = diet_plan_f,
      y = diff/tonnes_yr_2020)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8) + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  # scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP2") +
  facet_wrap( ~ year)

p5c <- ggplot(
  global_crop_demand_food_feed_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP3_v9_130115"),
  aes(x = diet_plan_f,
      y = diff/tonnes_yr_2020)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8) + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  # scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP3") +
  facet_wrap( ~ year)

p5d <- ggplot(
  global_crop_demand_food_feed_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP4d_v9_130115"),
  aes(x = diet_plan_f,
      y = diff/tonnes_yr_2020)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8) + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  # scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP4", y = "Relative to 2020 demand") +
  facet_wrap( ~ year)

p5e <- ggplot(
  global_crop_demand_food_feed_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP5_v9_130115"),
  aes(x = diet_plan_f,
      y = diff/tonnes_yr_2020)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8) + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  # scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP5") +
  facet_wrap( ~ year)
```

```{r}

p5 <- cowplot::plot_grid(p5a, p5b, p5c, p5d, p5e, p5_legend_only)
p5
```




## Estimate the quantity of livestock

Countries' animal product yields are highly variable, e.g., cattle raised for dairy versus beef. Here I make assumptions based on global average values, but the next iteration will be improved by using real data, where it exists.

I define a tropical livestock unit (TLU) as equivalent to 250 kg (liveweight). The following table is used for reference, and contains sources for the numbers used. Terms should be translated as: "poultry_eggs" are layers; "poultry_meat" and "chicken_poultry" are broilers; "bovine_dairy" are dairy cows; "bovine_meat" are cattle for meat; "caprine_dairy" are doe sheep/goats; "caprine_meat" are sheep/goats; "sus_meat" are pigs/hogs for meat; "beef_lamb_pork" are an amalgam of meat cattle lamb and pigs, set to 0.75 TLU.

```{r}
live_tlu_per_animal <- data.frame(
  model_group = c(
    "poultry_eggs",
    "eggs",
    "poultry_meat",
    "chicken_poultry",
    "bovine_dairy",
    "dairy",
    "bovine_meat",
    "caprine_dairy",
    "caprine_meat",
    "sus_meat",
    "beef_lamb_pork"
  ),
  tlu_head = c(1e-2,  1e-2,  1e-2,  1e-2, 1, 1, 1, 0.09, 0.09, 0.2, 0.75),
  source = c(
    "Jahnke et al 1988. Numbers from FAOSTAT (2000)",
    "Jahnke et al 1988. Numbers from FAOSTAT (2000)",
    "Jahnke et al 1988. Numbers from FAOSTAT (2000)",
    "Jahnke et al 1988. Numbers from FAOSTAT (2000)",
    "Kassam et al 1991, FAO & IIASA",
    "Kassam et al 1991, FAO & IIASA",
    "Kassam et al 1991, FAO & IIASA",
    "Kassam et al 1991, FAO & IIASA",
    "Kassam et al 1991, FAO & IIASA",
    "Jahnke et al 1988. Numbers from FAOSTAT (2000)",
    "Inferred"
  )
)
```


Convert animal products into parent livestock ratio by mass, here termed "live_to_proc_weight_ratio". For meat products, this is equivalent to "dressing percentage"/"carcass yield"; i.e., 1 bovine head produces 0.63 head (by mass) of bovine_meat, etc.

To calculate a similar factor for dairy products, the following assumptions were made: 
* Eggs. Chicken (layers) lay about 250 eggs per year; at 50 g per egg on average, that goes to about 12.5 kg of eggs per layer per year. I assume that the average layer mass is 2.5 kg; so the 'proc_to_live_weight_ratio' is 5.
* Dairy from cattle. Cattle in the US produced about 18000 lb of milk per cow in 2000, or 8.2 tonnes per cow. I assume that dairy products with lower water content are on average 0.25 times the mass of milk, or 2.05 tonnes per cow. Based on the TLU definition of 250 kg per TLU, this is 8.2 TLU; so for each cow (1 TLU) in this analysis, the 'proc_to_live_weight_ratio' of dairy products is 8.2.
* Dairy from camels. A (dromedary) camel produces about 1800 kg of milk per cow, or 1.8 tonnes. Using the method I did for cattle, and an assumed product water content of 0.25 times the mass of the camel milk, this goes to 0.45 tonnes per cow, or an equivalent mass to 1.8 TLU. Camelids (1.13 TLU) will therefore have a 'proc_to_live_weight_ratio' of 1.6.
* Dairy from caprines. A dairy goat will produce about 860 kg of milk per doe per year, or 0.86 tonnes. For an average water content of 0.25, its dairy products will be 0.215 tonnes per doe, or 0.86 TLU. For caprine TLU of 0.09, the 'proc_to_live_weight_ratio' is 9.6.

To map onto the various diets' model_groups, I take averages. I.e., beef_lamb_pork is ave(bovine_meat, caprine_meat, sus_meat), dairy is ave(bovine_dairy, caprine_dairy), and fish_seafood is ave( fish, other_seafood, freshwater_fish); meat_poultry refers to a mixture of poultry and other livestock meats.

Sources: (1) pigs, [Boler, DD. 2014. In Encyclopedia of Meat Sciences (Second Edition), p.363-368](https://doi.org/10.1016/B978-0-12-384731-7.00079-9); (2) poultry, [Maurer, AJ. 2003. In Encyclopedia of Food Sciences and Nutrition, p.4686-4689](https://doi.org/10.1016/B0-12-227055-X/00953-6); (3) sheep, [Berg, EP, McFadin Walker, EL. 2004. In Encyclopedia of Meat Sciences, p.1291-1295](https://www.sciencedirect.com/topics/agricultural-and-biological-sciences/dressing-percentage); (4) cattle, [Price, MA. 2004. In Encyclopedia of Meat Sciences, p.1277-1284](https://doi.org/10.1016/B0-12-464970-X/00107-0); (5) camels, Chapter VI in [Yagil, R., 1982. Camels and camel milk. FAO.](http://www.fao.org/3/x6528e/X6528E06.htm#:~:text=The%20brisket%2C%20ribs%20and%20loin,et%20al.%2C%201972).) E.g., "The dressing percentage of the carcass varies between 52 percent and 77 percent"; (6) [Schweihofer, J.P., 2011. Carcass dressing percentage and cooler shrink. Michigan State University Extension.](https://www.canr.msu.edu/news/carcass_dressing_percentage_and_cooler_shrink).

The processed weight to live weight for each of these animals is as follows:
```{r}

animal_prod_yield <- data.frame(
  model_group = c(
    "bovine_meat",
    "bovine_dairy",
    "poultry_meat",
    "meat_poultry", 
    "chicken_poultry", 
    "poultry_eggs", 
    "eggs", 
    "sus_meat",
    "caprine_meat",
    "caprine_dairy",
    "fish",
    "other_seafood",
    "freshwater_fish",
    "beef_lamb_pork",
    "fish_seafood", 
    "dairy"
  ),
  proc_to_live_weight_ratio = c(0.63, 8.2, 0.76, 0.72, 0.76, 5.0, 5.0, 0.72, 0.74, 9.6, 0.89, 0.6, 0.6, 0.7, 0.7, 8.9)
)

animal_prod_yield
```


<!-- Original crop weight prior to food/feed processing. This uses an assumed total value chain loss of 32%, or 68% of the crop's harvest weight is maintained through the end of processing. -->
<!-- ```{r} -->
<!-- proc_per_crop <- data.frame( -->
<!--   model_group = c("cereal", "pulse", "rootstubers", "fibercrop", "oilcrop", "citrus", "fruit", "vegetable", "sugarcrop", "treenut"),  -->
<!--   food_group = c("cereal", "pulse", "rootstubers", "fibercrop", "oilcrop", "citrus", "fruit", "vegetable", "sugarcrop", "treenut"),  -->
<!--   proc_to_harvest_weight_ratio = 0.68 -->
<!-- ) -->

<!-- head(proc_per_crop) -->

<!-- ``` -->

Now calculate the live animal weights, based on animal products consumed as food by humans.
```{r}
live_weight_food <- live_food_weight %>%
  dplyr::left_join(animal_prod_yield, Joining, by = "model_group") %>%
  dplyr::mutate(live_tonnes_day_for_food = ifelse(
    !is.na(tonnes_day_food),
    tonnes_day_food / proc_to_live_weight_ratio,
    0
  )) %>% 
  dplyr::select(-Mkcal_day, -g_kcal, -tonnes_day_food, -proc_to_live_weight_ratio)

# live_weight_food
```



Based on animal products in for feed consumed by other animals.
```{r}
live_weight_feed <- feed_ingredient_demand_summary %>%
  dplyr::left_join(animal_prod_yield, Joining, by = "model_group") %>%
  dplyr::mutate(live_tonnes_day_for_feed = tonnes_day / proc_to_live_weight_ratio) %>% 
  dplyr::select(-tonnes_day, -proc_to_live_weight_ratio)

# live_weight_feed
```

Merge these data (and aggregate over equivalent model_groups) to find the total live weight of livestock. (This data frame is labelled `live_weight_tmp` because waste in the value chain has not yet been evaluated. Basically, it produces animal product quantities immediately after processing, not at point-of-sale.)
```{r}
live_weight_tmp <- live_weight_food %>%
  dplyr::full_join(
    live_weight_feed,
    by = c(
      "SCENARIO",
      "iso_alpha3",
      "subregionname",
      "diet_plan",
      "year",
      "model_group"
    )
  ) %>% 
  dplyr::filter(!model_group %in% c("cereal", "fruits", "legumes", "sugarcrops", "vegetables", "roots_tubers", "treenuts", "oils", "stimulants")) %>%
  dplyr::mutate(
    live_tonnes_day_for_food = ifelse(
      !is.na(live_tonnes_day_for_food),
      live_tonnes_day_for_food,
      0
    ),
    live_tonnes_day_for_feed = ifelse(
      !is.na(live_tonnes_day_for_feed),
      live_tonnes_day_for_feed,
      0
    )
  ) %>%
  dplyr::mutate(live_tonnes_day_total = live_tonnes_day_for_food + live_tonnes_day_for_feed) %>%
  dplyr::mutate(model_group_agg = ifelse(
    model_group %in% c(
      "beef_lamb_pork",
      "sus_meat",
      "caprine_meat",
      "bovine_meat",
      "meat_poultry"
    ),
    "beef_lamb_pork",
    ifelse(
      model_group %in% c("fish", "fish_seafood"),
      "fish_seafood",
      ifelse(
        model_group %in% c("dairy", "bovine_dairy"),
        "dairy", 
        model_group
      )
    )
  )) %>% 
  dplyr::group_by(SCENARIO, iso_alpha3, subregionname, diet_plan, year, model_group_agg) %>% 
  dplyr::summarise(live_tonnes_day_total_tmp = sum(live_tonnes_day_total, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::rename(model_group = model_group_agg)

head(live_weight_tmp)
  
```

I need to add VCL rows for poultry.
```{r}
tmp <- vcl %>% 
  dplyr::filter(model_group == "meat_poultry") %>% 
  dplyr::mutate(model_group = "chicken_poultry")

vcl_1 <- vcl %>% 
  dplyr::bind_rows(tmp)
```



Now include value chain losses. This is the estimate of total live weight of livestock. 
```{r}
live_weight <- live_weight_tmp %>%
  dplyr::left_join(vcl_1 %>% 
                     dplyr::rename(subregionname = iep_subregions) %>% 
                     dplyr::filter(
    model_group %in% c(
      "fish_seafood",
      "dairy",
      "beef_lamb_pork",
      "meat_poultry", 
      "chicken_poultry", 
      "eggs"
    )
  ),
  by = c("subregionname", "model_group")) %>%
  dplyr::mutate(live_tonnes_day_total = live_tonnes_day_total_tmp / (1 -
                                                                       value_loss)) %>% 
  dplyr::select(-live_tonnes_day_total_tmp)

head(live_weight)

```

Fish and other seafood are reported in tonnes.
```{r}
live_weight_fish_seafood <- live_weight %>% 
  dplyr::filter(model_group == "fish_seafood")

head(live_weight_fish_seafood)

```

Global catch
```{r}

annual_live_fish_catch <- live_weight_fish_seafood %>% 
  dplyr::group_by(SCENARIO, diet_plan, year) %>% 
  dplyr::summarise(catch_Mt = 1e-6*365*sum(live_tonnes_day_total, na.rm = TRUE), 
                   .groups = "drop")

ggplot(annual_live_fish_catch, 
       aes(x = year, 
           y = catch_Mt)) + 
  geom_line(aes(colour = diet_plan)) + 
  theme_minimal() + 
  theme(
    legend.title = element_blank(), 
    legend.position = "top"
  ) + 
  labs(
    x = "year", 
    y = "Mt/yr"
  ) + 
  facet_wrap(~SCENARIO, labeller = labeller(SSP1_v9_130115 = "SSP1", "SSP2" = "SSP2_v9_130115", "SSP3" = "SSP3_v9_130115", "SSP4" = "SSP4d_v9_130115", "SSP5" = "SSP5_v9_130115"))

```


The daily demand for human consumption of livestock and livestock products on a per country basis is given below.
```{r}
livestock_quantity <- live_weight %>%
  dplyr::filter(model_group != "fish_seafood") %>%
  dplyr::left_join(live_tlu_per_animal %>%
                     dplyr::select(-source), by = "model_group") %>%
  dplyr::mutate(head_animals = live_tonnes_day_total/tlu_head) %>% 
  dplyr::select(-value_loss, -live_tonnes_day_total, -tlu_head)

head(livestock_quantity)

```

We now have numbers for (1) crop tonnes, (2) livestock quantity, and (3) fish catch tonnage based on human food (and animal feed) demand.

#### Livestock pasture demand

Based on the livestock numbers, now calculate pasture area demand. Half of animals' feed demands came from feed with crop and animal product ingredients. Half will come from grazing on pasture and silage from waste and hay.

The result is the estimated head count of herd/flock sizes for each region. NB: The back-conversion of 'beef_lamb_pork' to 'bovine_meat' instead of caprine or sus, or any other meats, coerced all livestock to be represented as cattle. This was a conscious choice, as cattle will demand a maximum of land and water resources, but could be revisited in future.

```{r}

forage_area_density <- data.frame(
  model_group = c("beef_lamb_pork", "chicken_poultry", "eggs", "dairy"), 
  forage_area_ha = c(2.5, 0.01, 0.01, 2.5)
)

```

First, convert livestock quantity to the number per year, then merge with `forage_area` to find pasture demand. I include another term, `pasture_quality` that can be changed by region.
```{r}
pasture_demand <- livestock_quantity %>% 
  dplyr::mutate(head_animals = head_animals*365) %>% 
  dplyr::left_join(forage_area_density, 
                   by = "model_group") %>% 
  dplyr::mutate(pasture_quality = 1) %>% 
  dplyr::mutate(forage_area_kha = head_animals*pasture_quality*forage_area_ha*1e-3) %>% 
  dplyr::select(SCENARIO, iso_alpha3, subregionname, diet_plan, year, model_group, pasture_quality, forage_area_kha)

head(pasture_demand)

```



<!-- Assuming that one cow requires approximately 2 ha of pasture (including fallow land for animals with feed-subsidized diets), one sheep/goat requires 0.4 ha, one pig 0.2 ha, and one chicken 0.01 ha, I estimate the livestock pasture demand to be as follows: -->

<!-- ```{r} -->

<!-- pasture_demand <- eatlancetdiet_summary_3 %>%  -->
<!--   dplyr::mutate(pasture_ha = ifelse( -->
<!--     food_group %in% c("bovine_dairy", "bovine_meat"),  -->
<!--     head_av*2,  -->
<!--     ifelse( -->
<!--       food_group %in% c("caprine_dairy", "caprine_meat"),  -->
<!--       head_av*0.4,  -->
<!--       ifelse( -->
<!--         food_group == "sus_meat",  -->
<!--         head_av*0.2,  -->
<!--         ifelse( -->
<!--           food_group %in% c("aves_dairy", "aves_meat"),  -->
<!--           head_av*0.01,  -->
<!--           0))))) -->

<!-- pasture_demand_summary <- pasture_demand %>%  -->
<!--   dplyr::group_by(SCENARIO, year, subregionname) %>%  -->
<!--   dplyr::summarise(pasture_ha = sum(pasture_ha, na.rm = TRUE),  -->
<!--                    .groups = "drop") -->

<!-- head(pasture_demand_summary) -->

<!-- ``` -->

#### Cropland demand
Cropland supply
What is the present land-use area of these subregions?
```{r}

# url <- "http://fenixservices.fao.org/faostat/static/bulkdownloads/Inputs_LandUse_E_All_Data_(Normalized).zip"
# download.file(url, destfile = "~/Data/IEP_Model/data_iep_model/Inputs_LandUse_E_All_Data_(Normalized).zip")

fao_landuse <-
  readr::read_csv(
    file = "~/Data/IEP_Model/data_iep_model/Inputs_LandUse_E_All_Data_(Normalized).csv",
    col_types = cols(
      `Area Code` = col_double(),
      Area = col_character(),
      `Item Code` = col_double(),
      Item = col_character(),
      `Element Code` = col_double(),
      Element = col_character(),
      `Year Code` = col_double(),
      Year = col_double(),
      Unit = col_character(),
      Value = col_double(),
      Flag = col_character()
    )
  )

```

6610 "Land used for cultivation of crops and animal husbandry. The total of areas under 'Cropland' and 'Permanent meadows and pastures.'"
6611 "Agriculture area actually irrigated"
6641 "Area of Coastal waters used for marine aquaculture facilities including supporting facilities. Aquaculture facilities include enclosures and pens (water areas confined by net, mesh and other barriers allowing uncontrolled water interchange), cages (open or covered enclosed structure constructed with net, mesh or any porous materials allowing natural water interchange), barrages (semi-permanent or seasonal enclosures formed by impervious man-made barriers and appropriate natural features) and rafts, ropes and stakes (raft, long lines or stakes used to culture shellfish and seaweeds). This category includes: Oyster beds and other types of shellfish (mussels, clams, abalones and scallops); Bodies of water used for seaweed production; Bodies of water used for fish rearing"
6694 "Agricultural land actually irrigated that is Cropland."
6646 "Forest land"
6767 "Inland water areas that are used for aquaculture facilities including supporting facilities. Aquaculture facilities include enclosures and pens (water areas confined by net, mesh and other barriers allowing uncontrolled water interchange), cages (open or covered enclosed structure constructed with net, mesh or any porous materials allowing natural water interchange), barrages (semi-permanent or seasonal enclosures formed by impervious man-made barriers and appropriate natural features) and rafts, ropes and stakes (raft, long lines or stakes used to culture shellfish and seaweeds)."
6771 "Area of inland waters that is used for catching aquatic animals or gathering aquatic plants in the wild."
6601 "Country area excluding area under inland waters and coastal waters."
6655 "Land under perm. meadows and pastures"
6620 "Cropland"
6633 "temporary pastures"

From FAO the relevant land use data is as follows:

```{r}
land_use_data <- fao_landuse %>%
  dplyr::filter(
    `Year Code` >= 2000 &
      `Element Code` == 5110 &
      `Item Code` %in% c(6601, 6620, 6646, 6655, 6670, 6694)
  ) %>%
  dplyr::select(-`Item Code`,-`Element Code`,-Element,-`Year Code`,-Flag) %>%
  tidyr::pivot_wider(
    .,
    names_from = Item,
    values_from = Value,
    values_fill = 0
  ) %>%
  dplyr::rename(
    landarea = `Land area`,
    cropland = Cropland,
    cropland_irr = `Cropland area actually irrigated`,
    pasture = `Land under perm. meadows and pastures`,
    forest = `Forest land`,
    otherland = `Other land`
  ) %>%
  dplyr::mutate(cropland_rfd = cropland - cropland_irr)

head(land_use_data)

```

Add regional information.
```{r}
land_use_regions <- land_use_data %>%
  dplyr::rename(fao_countrycode = `Area Code`) %>%
  dplyr::left_join(loc_map_reduced,
            by = "fao_countrycode") %>% 
  dplyr::select(iso_alpha3, subregionname, Year, Unit, landarea, cropland, pasture, forest, otherland, cropland_irr, cropland_rfd) %>% 
  dplyr::rename(year = Year)

head(land_use_regions)

```

These data represent FAOSTAT data for land-use from 2000 to 2018, so let's label this explicitly.
```{r}
land_use_2000to2018 <- land_use_regions
```

I will just use 2018 land-use values, the most up-to-date from FAO, for 2021 values.
```{r}

irrigated_cropland_2021 <- land_use_regions %>% 
  filter(year == 2018) %>% 
  dplyr::select(iso_alpha3, subregionname, year, cropland_irr, cropland_rfd) %>% 
  dplyr::mutate(ratio_irr = ifelse((cropland_irr + cropland_rfd) != 0, cropland_irr/(cropland_irr + cropland_rfd), 0), 
                ratio_rfd = 1 - ratio_irr)

irrigated_cropland_2021_long <- irrigated_cropland_2021 %>% 
  dplyr::select(-year, -cropland_irr, -cropland_rfd) %>% 
  dplyr::rename(irrigated = ratio_irr, 
                rainfed = ratio_rfd) %>% 
  tidyr::pivot_longer(., cols = irrigated:rainfed, names_to = "management", values_to = "ratio")

landuse_2021 <- land_use_regions %>% 
  filter(year == 2018) %>% 
  dplyr::select(iso_alpha3, subregionname, year, cropland, pasture, forest, otherland)

landuse_2021_long <- landuse_2021 %>% 
  tidyr::pivot_longer(., 
                      cols = cropland:otherland, 
                      names_to = "land_use", 
                      values_to = "kha")

landareas <-
  landuse_2021_long %>% group_by(iso_alpha3, subregionname, year) %>% summarise(total_area = sum(kha, na.rm = TRUE), .groups = "drop")

head(landuse_2021_long)

```


##### Yield gap

We also need to consider how the yield gap will have closed by 2050. The yield in 2050 will determine how much cropland is required to produce the necessary food/feed crops.

Load yield gap data based on the [Global Yield Gap Atlas](https://www.yieldgap.org). To produce these data, we used the available country-level data sets from GYGA to determine sub-regional averages for cereal, pulse, oilcrop, fibercrop, sugarcrop, treenut, citrus, fruit, rootstubers, and vegetable crop groups; and where data were incomplete, made inferences based on regions with similar climates and levels fo development. The complete list of inferences is found in the ReadMe accompanying the .csv file.
```{r, echo=FALSE}

yield_gaps <-
  readr::read_csv(
    file = "~/Data/IEP_Model/data_iep_model/GYGA_yield_gaps - summary.csv",
    col_types = cols(
      iep_subregions = col_character(),
      management = col_character(),
      model_group = col_character(),
      YA = col_double(),
      YW = col_double(),
      `YW-YA` = col_double(),
      YP = col_double(),
      `YP-YA` = col_double(),
      WPP = col_double(),
      WPA = col_double(),
      CROP = col_character(),
      TOTAL_AREA_HA = col_double(),
      AREA_SELECTED_CLIMATEZONES_HA = col_double(),
      CROPPING_INTENSITY = col_double(),
      YW_CV_TEMPORAL = col_double(),
      YP_CV_TEMPORAL = col_double(),
      YA_CV_TEMPORAL = col_double(),
      notes = col_character()
    )
  ) %>%
  dplyr::select(iep_subregions,
                management,
                model_group,
                YA,
                YP,
                `YP-YA`,
                CROPPING_INTENSITY) %>%
  dplyr::mutate(model_group = ifelse(
    model_group == "cereal",
    "cereals",
    ifelse(
      model_group == "fruit",
      "fruits",
      ifelse(
        model_group == "pulse",
        "legumes",
        ifelse(
          model_group == "oilcrop",
          "oils",
          ifelse(
            model_group == "treenut",
            "treenuts",
            ifelse(
              model_group == "vegetable",
              "vegetables",
              ifelse(
                model_group == "rootstubers",
                "roots_tubers",
                ifelse(model_group == "sugarcrop",
                       "sugarcrops",
                       model_group)
              )
            )
          )
        )
      )
    )
  ))

head(yield_gaps)

```

##### Loss due to post-harvest waste

Return to value chain loss, based on data found in Alexander et al. (2017).

Source: [Alexander, P., Brown, C., Arneth, A., Finnigan, J., Moran, D. and Rounsevell, M.D., 2017. Losses, inefficiencies and waste in the global food system. Agricultural systems, 153, pp.190-200.](https://doi.org/10.1016/j.agsy.2017.01.014)

```{r}

vcl_crops <- vcl_1 %>%
  dplyr::filter(
    model_group %in% c(
      "cereals",
      "fruits",
      "vegetables",
      "oils",
      "oils",
      "treenuts",
      "roots_tubers",
      "sugarcrops", 
      "legumes"
    )
  )

```

Merge value chain and yield gap data frames.
```{r}

value_chain_loss_yield_gap <- vcl_crops %>% 
  dplyr::full_join(yield_gaps, 
                   by = c("iep_subregions", "model_group")) %>% 
  dplyr::rename(subregionname = iep_subregions) %>% 
  dplyr::filter(!model_group %in% c("citrus", "fibercrop"))

head(value_chain_loss_yield_gap)

```


Calculate land-use on an annual basis.
```{r}
annual_food_crop_weight <- crop_weight %>% 
  dplyr::mutate(tonnes_yr_food_crop = tonnes_day_crop*365)

annual_feed_crop_weight <- feed_ingredient_demand_summary %>% 
  dplyr::filter(model_group %in% c("cereal", "legumes", "oils", "roots_tubers", "sugarcrops", "fruits")) %>% 
  dplyr::mutate(tonnes_yr_feed_crop = tonnes_day*365)
```


Set ratios of irrigated to rainfed cropland. By default, this is set to 2021 levels.
```{r}
irr_rfd_cropland_ratios <- irrigated_cropland_2021_long
```


Cropland for food production.

```{r}

cropland_food_1 <- annual_food_crop_weight %>%
  dplyr::select(-iep_subregions) %>%
  dplyr::left_join(irr_rfd_cropland_ratios,
                   by = c("iso_alpha3")) %>%
  dplyr::left_join(
    value_chain_loss_yield_gap,
    by = c("model_group", "value_loss", "management", "subregionname")
  ) %>% 
  tidyr::drop_na(value_loss) %>% 
  dplyr::mutate(
    cropland_area_kha_YA = (1e-3)*tonnes_yr_food_crop * ratio / (CROPPING_INTENSITY * (1 - value_loss) * YA),
    cropland_area_kha_YP = (1e-3)*tonnes_yr_food_crop * ratio / (CROPPING_INTENSITY * (1 - value_loss) * YP)
  ) 

```


TODO Roots and tubers here are coming up with huge numbers for the CNS-CFP diet. This is because the CFP diet codes food groups differently, and cereals are being grouped with potatoes.
```{r}

cropland_food <- cropland_food_1 %>%
  dplyr::group_by(SCENARIO,
                  iso_alpha3,
                  subregionname,
                  diet_plan,
                  year,
                  model_group) %>%
  dplyr::summarise(
    cropland_area_kha_YA = sum(cropland_area_kha_YA, na.rm = TRUE),
    cropland_area_kha_YP = sum(cropland_area_kha_YP, na.rm = TRUE),
    .groups = "drop"
  ) %>% 
  dplyr::mutate(
    cropland_area_kha_YP = ifelse(cropland_area_kha_YP == 0, 
                                  cropland_area_kha_YA, 
                                  cropland_area_kha_YP)
  ) %>%
  left_join(landareas %>%
              dplyr::select(-year),
            by = c("iso_alpha3", "subregionname")) %>% 
  dplyr::rename(total_area_kha = total_area)

head(cropland_food)

```

Cropland for animal feed production.
```{r}

cropland_feed_1 <- annual_feed_crop_weight %>%
  dplyr::left_join(irr_rfd_cropland_ratios,
                   by = c("iso_alpha3", "subregionname")) %>%
  dplyr::full_join(value_chain_loss_yield_gap,
                   by = c("model_group", "subregionname", "management")) %>% 
  tidyr::drop_na(value_loss) %>%
  dplyr::mutate(
    cropland_area_kha_YA = (1e-3)*tonnes_yr_feed_crop * ratio / (CROPPING_INTENSITY *
                                                            (1 - value_loss) * YA),
    cropland_area_kha_YP = (1e-3)*tonnes_yr_feed_crop * ratio / (CROPPING_INTENSITY *
                                                            (1 - value_loss) * YP)
  ) 

```


```{r}

cropland_feed <- cropland_feed_1 %>%
  dplyr::group_by(SCENARIO,
                  iso_alpha3,
                  subregionname,
                  diet_plan,
                  year,
                  model_group) %>%
  dplyr::summarise(
    cropland_area_kha_YA = sum(cropland_area_kha_YA, na.rm = TRUE),
    cropland_area_kha_YP = sum(cropland_area_kha_YP, na.rm = TRUE),
    .groups = "drop"
  ) %>% 
  dplyr::mutate(
    cropland_area_kha_YP = ifelse(cropland_area_kha_YP == 0, 
                                  cropland_area_kha_YA, 
                                  cropland_area_kha_YP)
  ) %>% 
  left_join(landareas %>%
              dplyr::select(-year),
            by = c("iso_alpha3", "subregionname")) %>% 
  dplyr::rename(total_area_kha = total_area)

head(cropland_feed)

```

Pasture demand
```{r}

pasture_demand_total <- pasture_demand %>%
  dplyr::group_by(SCENARIO, iso_alpha3, subregionname, diet_plan, year) %>%
  dplyr::summarise(forage_area_kha = sum(forage_area_kha, na.rm = TRUE),
                   .groups = "drop") %>%
  left_join(landareas %>%
              dplyr::select(-year),
            by = c("iso_alpha3", "subregionname")) %>% 
  dplyr::rename(total_area_kha = total_area)

head(pasture_demand_total)

```


<!-- TODO It looks like cereal cropland area demand is too great for Southern Asia -->

<!-- TODO Find yields divided by YA and YP. -->

<!-- Multiply by yield potential (YP), not present average yield (YA). -->
<!-- Production = cropping_intensity.YP.cropland_area.(1-value_loss); cropland_area = production/(cropping_intensity.YP.(1-value_loss)) -->
<!-- ```{r} -->

<!-- cropland_area_demand <- eatlancetdiet_summary_2 %>%  -->
<!--   dplyr::full_join(value_chain_loss_yield_gap %>%  -->
<!--                      dplyr::rename(subregionname = iep_subregions,  -->
<!--                                    food_group = model_group),  -->
<!--                    by = c("subregionname", "food_group")) %>%  -->
<!--   dplyr::filter(food_group %in% c("cereal", "citrus", "fibercrop", "fruit", "oilcrop", "pulse", "rootstubers", "sugarcrop", "treenut", "vegetable")) %>%  -->
<!--   tidyr::drop_na() -->

<!-- head(cropland_area_demand) -->

<!-- ``` -->

<!-- Let's also assume that the proportion of irrigated to rain-fed cropland remains roughly constant through 2050. How does this effect cropland demand in 2050? -->
<!-- ```{r} -->
<!-- irrigated_cropland_rel <- land_use_2000to2021 %>%  -->
<!--   dplyr::filter(Year == 2021) %>%  -->
<!--   dplyr::mutate(irrigated = abs(cropland_irr)/cropland,  -->
<!--                 rainfed = abs(cropland_rfd)/cropland) %>%  -->
<!--   dplyr::select(Year, subregionname, irrigated, rainfed) %>%  -->
<!--   tidyr::pivot_longer(., cols = irrigated:rainfed, names_to = "management", values_to = "ratio") -->

<!-- head(irrigated_cropland_rel) -->
<!-- ``` -->

<!-- Merge these data frames (into `cropland_area_demand_2050_1`), then summarize over subregions (into `cropland_area_demand_2050_2`). The data frame `cropland_area_demand_2050_1` is separated from the summary data frame for the sake of transparency. -->
<!-- ```{r} -->

<!-- cropland_area_demand_2050_1 <- cropland_area_demand %>%  -->
<!--   dplyr::full_join(irrigated_cropland_rel %>%  -->
<!--                      dplyr::select(-Year),  -->
<!--                    by = c("subregionname", "management")) %>%  -->
<!--   dplyr::mutate( -->
<!--     cropland_area_YA = crop_live_weight*ratio/(CROPPING_INTENSITY*(1-value_chain_loss)*YA),  -->
<!--     cropland_area_YP = crop_live_weight*ratio/(CROPPING_INTENSITY*(1-value_chain_loss)*YP) -->
<!--   ) -->

<!-- cropland_area_demand_2050_2 <- cropland_area_demand_2050_1 %>%  -->
<!--   dplyr::group_by(SCENARIO, year, subregionname, food_group) %>%  -->
<!--   dplyr::summarise(cropland_area_YA = sum(cropland_area_YA, na.rm = TRUE),  -->
<!--                    cropland_area_YP = sum(cropland_area_YP, na.rm = TRUE),  -->
<!--                    ratio_check = sum(ratio, na.rm = TRUE),  -->
<!--                    .groups = "drop") %>% #just inserted to check that it is evaluating properly -- it is -->
<!--   dplyr::group_by(SCENARIO, year, subregionname) %>%  -->
<!--   dplyr::summarise(cropland_area_YA = sum(cropland_area_YA, na.rm = TRUE),  -->
<!--                    cropland_area_YP = sum(cropland_area_YP, na.rm = TRUE),  -->
<!--                    .groups = "drop") -->

<!-- head(cropland_area_demand_2050_1) -->
<!-- head(cropland_area_demand_2050_2) -->

<!-- ``` -->

<!-- ```{r} -->

<!-- cropland_2000to2021 <- land_use_2000to2021 %>%  -->
<!--   dplyr::select(Year, subregionname, landarea, cropland) %>%  -->
<!--   dplyr::rename(year = Year) -->

<!-- cropland_2050 <- cropland_area_demand_2050_2 %>%  -->
<!--   dplyr::mutate(cropland_area_YA = cropland_area_YA*1e-3,  -->
<!--                 cropland_area_YP = cropland_area_YP*1e-3) -->

<!-- head(cropland_2000to2021) -->
<!-- head(cropland_2050) -->

<!-- ``` -->

Find yield gap closure points based on quartiles between YA and YP by 2050. That is, the following data frame imagines what the cropland area would be if the yield gaps (by subregion) were closed by 0% (equivalent to present yield average), 25%, 50%, 75%, and 100% (equivalent to potential yield) by 2050.
```{r}

cropland_food_YG <- cropland_food %>% 
   dplyr::mutate(
    quartile_value = 0.25*(cropland_area_kha_YP - cropland_area_kha_YA), 
    cropland_area_0thQuYG = cropland_area_kha_YA + quartile_value*0, 
    cropland_area_1stQuYG = cropland_area_kha_YA + quartile_value*1, 
    cropland_area_2ndQuYG = cropland_area_kha_YA + quartile_value*2, 
    cropland_area_3rdQuYG = cropland_area_kha_YA + quartile_value*3, 
    cropland_area_4thQuYG = cropland_area_kha_YP
    ) %>% 
  dplyr::mutate(purpose = "food")

cropland_feed_YG <- cropland_feed %>% 
   dplyr::mutate(
    quartile_value = 0.25*(cropland_area_kha_YP - cropland_area_kha_YA), 
    cropland_area_0thQuYG = cropland_area_kha_YA + quartile_value*0, 
    cropland_area_1stQuYG = cropland_area_kha_YA + quartile_value*1, 
    cropland_area_2ndQuYG = cropland_area_kha_YA + quartile_value*2, 
    cropland_area_3rdQuYG = cropland_area_kha_YA + quartile_value*3, 
    cropland_area_4thQuYG = cropland_area_kha_YP
    ) %>% 
  dplyr::mutate(purpose = "feed") %>% 
  dplyr::filter(iso_alpha3 != "MAC")

```

Define `cultivable_land` as land that is potentially available for crops, including present cropland, pasture and forest.
```{r}
cultivable_land <- landuse_2021_long %>% 
  dplyr::select(-year) %>% 
  dplyr::filter(land_use %in% c("cropland", "pasture", "forest")) %>% 
  dplyr::group_by(iso_alpha3, subregionname) %>% 
  dplyr::summarise(cultivable_land_kha = sum(kha), 
                   .groups = "drop") %>% 
  tidyr::drop_na() 
```

Summarise: this df includes total cropland areas under the quartiles of yield gap closure, and their ratios to cultivable land, as defined above.
```{r}

cropland_food_YG_summary <- cropland_food_YG %>% 
  dplyr::bind_rows(cropland_feed_YG) %>% 
  dplyr::group_by(SCENARIO, iso_alpha3, subregionname, diet_plan, year, total_area_kha) %>% 
  dplyr::summarise(kha_Qu0YG = sum(cropland_area_0thQuYG), 
                   kha_Qu1YG = sum(cropland_area_1stQuYG), 
                   kha_Qu2YG = sum(cropland_area_2ndQuYG), 
                   kha_Qu3YG = sum(cropland_area_3rdQuYG), 
                   kha_Qu4YG = sum(cropland_area_4thQuYG), 
                   .groups = "drop") %>% 
  dplyr::left_join(cultivable_land, by = c("iso_alpha3", "subregionname")) %>% 
  dplyr::mutate(kha_Qu0YG = kha_Qu0YG/cultivable_land_kha, 
                kha_Qu1YG = kha_Qu1YG/cultivable_land_kha,
                kha_Qu2YG = kha_Qu2YG/cultivable_land_kha,
                kha_Qu3YG = kha_Qu3YG/cultivable_land_kha,
                kha_Qu4YG = kha_Qu4YG/cultivable_land_kha) %>% 
  dplyr::filter(!iso_alpha3 %in% c("MAC"))
  

```

Before mapping geographically, let's see what total global land demand looks like. Change in land demand from 2020.
```{r}
cropland_food_YG_world <- cropland_food_YG_summary %>% 
  tidyr::drop_na() %>% 
  dplyr::group_by(SCENARIO, diet_plan, year) %>%
  dplyr::summarise(
    total_area_kha = sum(total_area_kha),
    kha_Qu0YG = sum(kha_Qu0YG, na.rm = TRUE),
    kha_Qu1YG = sum(kha_Qu1YG),
    kha_Qu2YG = sum(kha_Qu2YG),
    kha_Qu3YG = sum(kha_Qu3YG),
    kha_Qu4YG = sum(kha_Qu4YG),
    cultivable_land_kha = sum(cultivable_land_kha),
    .groups = "drop"
  )
```

Difference from cropland area today (presuming similar cropland levels to FAO 2018 data):
```{r}
total_global_cropland_2020 <- landuse_2021_long %>% 
  dplyr::filter(land_use == "cropland") %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarise(kha = sum(kha, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::mutate(year = 2020) %>% 
  dplyr::pull(kha)
```


```{r}
cropland_food_YG_world_ratios <- cropland_food_YG_world %>% 
  dplyr::filter(year >= 2020) %>% 
  dplyr::mutate(FAO_global_cropland = total_global_cropland_2020) %>% 
  dplyr::mutate(across(kha_Qu0YG:kha_Qu4YG)/FAO_global_cropland) %>% 
  dplyr::select(-total_area_kha, -cultivable_land_kha, -FAO_global_cropland) %>% 
  dplyr::rename("0%" = "kha_Qu0YG", "25%" = "kha_Qu1YG", "50%" = "kha_Qu2YG", "75%" = "kha_Qu3YG", "100%" = "kha_Qu4YG") %>% 
  tidyr::pivot_longer(., cols = "0%":"100%", names_to = "YG_quartile_closed_by", values_to = "ratio_of_present_global_cropland")
```

```{r}

cropland_food_YG_world_ratios <- cropland_food_YG_world_ratios %>% 
  dplyr::mutate(diet_plan_f = diet_plan)
cropland_food_YG_world_ratios$diet_plan_f <- factor(cropland_food_YG_world_ratios$diet_plan_f, levels = c("ELA-PHD", "CNS-CFP", "FDA-SDP"))


cropland_food_YG_world_ratios <- cropland_food_YG_world_ratios %>% 
  dplyr::mutate(YG_quartile_closed_by_f = YG_quartile_closed_by)
cropland_food_YG_world_ratios$YG_quartile_closed_by_f <- factor(cropland_food_YG_world_ratios$YG_quartile_closed_by_f, levels = c("0%", "25%", "50%", "75%", "100%"))


```


```{r}
ymax <- 0.001 
ymin <- 0


p6a <- ggplot(
  cropland_food_YG_world_ratios %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP1_v9_130115"),
  aes(x = diet_plan_f,
      y = ratio_of_present_global_cropland)
) +
  geom_col(aes(fill = YG_quartile_closed_by_f), position = "dodge", alpha = 0.8, colour = "black", size = 0.1) + 
   scale_fill_brewer(palette=3, 
                    labels = c("0% YG", "25% YG", "50% YG", "75% YG", "100% YG"), 
                    name = "Proportion of global \nyield gap closed") + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP1") +
  facet_wrap( ~ year)

p6_legend_only <- cowplot::get_legend(p6a)

p6a <- p6a +
  theme(legend.position = "none")

p6b <-  ggplot(
  cropland_food_YG_world_ratios %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP2_v9_130115"),
  aes(x = diet_plan_f,
      y = ratio_of_present_global_cropland)
) +
  geom_col(aes(fill = YG_quartile_closed_by_f), position = "dodge", alpha = 0.8, colour = "black", size = 0.1) + 
   scale_fill_brewer(palette=3, 
                    labels = c("0% YG", "25% YG", "50% YG", "75% YG", "100% YG"), 
                    name = "Proportion of yield gap closed") + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    legend.position = "none", 
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.title = element_blank(), 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP2") +
  facet_wrap( ~ year)
 

p6c <-  ggplot(
  cropland_food_YG_world_ratios %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP3_v9_130115"),
  aes(x = diet_plan_f,
      y = ratio_of_present_global_cropland)
) +
  geom_col(aes(fill = YG_quartile_closed_by_f), position = "dodge", alpha = 0.8, colour = "black", size = 0.1) + 
   scale_fill_brewer(palette=3, 
                    labels = c("0% YG", "25% YG", "50% YG", "75% YG", "100% YG"), 
                    name = "Proportion of yield gap closed") + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    legend.position = "none", 
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.title = element_blank(), 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP3") +
  facet_wrap( ~ year)
 
p6d <- ggplot(
  cropland_food_YG_world_ratios %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP4d_v9_130115"),
  aes(x = diet_plan_f,
      y = ratio_of_present_global_cropland)
) +
  geom_col(aes(fill = YG_quartile_closed_by_f), position = "dodge", alpha = 0.8, colour = "black", size = 0.1) + 
   scale_fill_brewer(palette=3, 
                    labels = c("0% YG", "25% YG", "50% YG", "75% YG", "100% YG"), 
                    name = "Proportion of yield gap closed") + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    legend.position = "none", 
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.title = element_blank(), 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP4") +
  facet_wrap( ~ year)
 
p6e <-  ggplot(
  cropland_food_YG_world_ratios %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP5_v9_130115"),
  aes(x = diet_plan_f,
      y = ratio_of_present_global_cropland)
) +
  geom_col(aes(fill = YG_quartile_closed_by_f), position = "dodge", alpha = 0.8, colour = "black", size = 0.1) + 
   scale_fill_brewer(palette=3, 
                    labels = c("0% YG", "25% YG", "50% YG", "75% YG", "100% YG"), 
                    name = "Proportion of yield gap closed") + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    legend.position = "none", 
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.title = element_blank(), 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP5") +
  facet_wrap( ~ year)
 
```

```{r}

p6 <- cowplot::plot_grid(p6a, p6b, p6c, p6d, p6e, p6_legend_only)
p6
```



```{r}
library(sf)
library(ggspatial)
library(rnaturalearth)
library(rnaturalearthdata)
```


```{r}
world <- ne_countries(scale = "medium", returnclass = "sf")

cropland_change_map <- world %>% 
  dplyr::full_join(loc_map_reduced %>% 
                     dplyr::rename(iso_a3 = iso_alpha3), 
                   by = "iso_a3") %>% 
  dplyr::full_join(cropland_food_YG_summary %>% 
                     dplyr::rename(iso_a3 = iso_alpha3)) %>% 
  dplyr::select(-formal_fr, -note_adm0, -note_brk, -name_sort, -name_alt, -pop_est, -gdp_md_est, -pop_year, -lastcensus, -gdp_year, -economy, -income_grp, -wikipedia, -fips_10, -iso_a2, -iso_n3, -un_a3, -wb_a2, -wb_a3, -woe_id, -adm0_a3_is, -adm0_a3_us, -adm0_a3_un, -adm0_a3_wb, -continent, -region_un, -subregion, -region_wb, -name_len, -long_len, -abbrev_len, -tiny, -homepart, -fao_countrycode, -un_countrycode, -subregioncode)

```



# 
# Summarise these data into several time-series, based on different yield gap closures.
# ```{r}
# 
# cropland_2000to2050_2021YG <- cropland_2000to2021 %>% 
#   dplyr::full_join(cropland_2050_yieldgaps %>% 
#                      dplyr::select(SCENARIO, year, subregionname, cropland_area_0thQuartYG) %>% 
#                      dplyr::rename(cropland = cropland_area_0thQuartYG), 
#                    by = c("year", "subregionname", "cropland")) %>% 
#   dplyr::group_by(subregionname) %>% 
#   tidyr::fill(landarea) %>% 
#   dplyr::ungroup() %>% 
#   dplyr::mutate(yield_gap = "equal to 2021 YA in 2050")
# 
# cropland_2000to2050_1stQuartYG <- cropland_2000to2021 %>% 
#   dplyr::full_join(cropland_2050_yieldgaps %>% 
#                      dplyr::select(SCENARIO, year, subregionname, cropland_area_1stQuartYG) %>% 
#                      dplyr::rename(cropland = cropland_area_1stQuartYG), 
#                    by = c("year", "subregionname", "cropland")) %>% 
#   dplyr::group_by(subregionname) %>% 
#   tidyr::fill(landarea) %>% 
#   dplyr::ungroup() %>% 
#   dplyr::mutate(yield_gap = "YA plus first quartile in 2050")
# 
# cropland_2000to2050_2ndQuartYG <- cropland_2000to2021 %>% 
#   dplyr::full_join(cropland_2050_yieldgaps %>% 
#                      dplyr::select(SCENARIO, year, subregionname, cropland_area_2ndQuartYG) %>% 
#                      dplyr::rename(cropland = cropland_area_2ndQuartYG), 
#                    by = c("year", "subregionname", "cropland")) %>% 
#   dplyr::group_by(subregionname) %>% 
#   tidyr::fill(landarea) %>% 
#   dplyr::ungroup() %>% 
#   dplyr::mutate(yield_gap = "average of YA and YP in 2050")
# 
# cropland_2000to2050_3rdQuartYG <- cropland_2000to2021 %>% 
#   dplyr::full_join(cropland_2050_yieldgaps %>% 
#                      dplyr::select(SCENARIO, year, subregionname, cropland_area_3rdQuartYG) %>% 
#                      dplyr::rename(cropland = cropland_area_3rdQuartYG), 
#                    by = c("year", "subregionname", "cropland")) %>% 
#   dplyr::group_by(subregionname) %>% 
#   tidyr::fill(landarea) %>% 
#   dplyr::ungroup() %>% 
#   dplyr::mutate(yield_gap = "YA plus third quartile in 2050")
# 
# cropland_2000to2050_YP <- cropland_2000to2021 %>% 
#   dplyr::full_join(cropland_2050_yieldgaps %>% 
#                      dplyr::select(SCENARIO, year, subregionname, cropland_area_4thQuartYG) %>% 
#                      dplyr::rename(cropland = cropland_area_4thQuartYG), 
#                    by = c("year", "subregionname", "cropland")) %>% 
#   dplyr::group_by(subregionname) %>% 
#   tidyr::fill(landarea) %>% 
#   dplyr::ungroup() %>% 
#   dplyr::mutate(yield_gap = "maximum yield potential in 2050")
# 
# cropland_2000to2050_2021YG
# cropland_2000to2050_1stQuartYG
# cropland_2000to2050_2ndQuartYG
# cropland_2000to2050_3rdQuartYG
# cropland_2000to2050_YP
# 
# ```
# 
# What does the world look like with a yield gap closed?
# ```{r}
# 
# # no change in yield gap
# cropland_2021_1 <- cropland_2000to2050_2021YG %>% 
#   dplyr::filter(year == 2021) %>% 
#   dplyr::mutate(kha_2021 = cropland) %>% 
#   dplyr::select(SCENARIO, subregionname, landarea, kha_2021) %>% 
#   tidyr::pivot_wider()
# 
# # no change in yield gap
# cropland_2050_0Q <- cropland_2000to2050_2021YG %>% 
#   dplyr::filter(year == 2050) %>% 
#   dplyr::mutate(kha_2050_Qu0YG = cropland) %>% 
#   dplyr::select(SCENARIO, subregionname, landarea, kha_2050_Qu0YG) %>% 
#   tidyr::pivot_wider()
# 
# # first quartile improved yield gap
# cropland_2050_1Q <- cropland_2000to2050_1stQuartYG %>% 
#   dplyr::filter(year == 2050) %>% 
#   dplyr::mutate(kha_2050_Qu1YG = cropland) %>% 
#   dplyr::select(SCENARIO, subregionname, landarea, kha_2050_Qu1YG) %>% 
#   tidyr::pivot_wider()
# 
# # second quartile improved yield gap
# cropland_2050_2Q <- cropland_2000to2050_2ndQuartYG %>%
#   dplyr::filter(year == 2050) %>%
#   dplyr::mutate(kha_2050_Qu2YG = cropland) %>%
#   dplyr::select(SCENARIO, subregionname, landarea, kha_2050_Qu2YG) %>%
#   tidyr::pivot_wider()
# 
# # third quartile improved yield gap
# cropland_2050_3Q <- cropland_2000to2050_3rdQuartYG %>% 
#   dplyr::filter(year == 2050) %>% 
#   dplyr::mutate(kha_2050_Qu3YG = cropland) %>% 
#   dplyr::select(SCENARIO, subregionname, landarea, kha_2050_Qu3YG) %>% 
#   tidyr::pivot_wider()
# 
# # closed yield gap to full potential yield by 2050
# cropland_2050_4Q <- cropland_2000to2050_YP %>% 
#   dplyr::filter(year == 2050) %>% 
#   dplyr::mutate(kha_2050_Qu4YG = cropland) %>% 
#   dplyr::select(SCENARIO, subregionname, landarea, kha_2050_Qu4YG) %>% 
#   tidyr::pivot_wider()
# 
# cropland_2021and2050_wide <- cropland_2021_1  %>%
#   dplyr::full_join(cropland_2050_0Q,
#                    by = c("SCENARIO", "subregionname", "landarea")) %>%
#   dplyr::full_join(cropland_2050_1Q,
#                    by = c("SCENARIO", "subregionname", "landarea")) %>%
#   dplyr::full_join(cropland_2050_2Q,
#                    by = c("SCENARIO", "subregionname", "landarea")) %>%
#   dplyr::full_join(cropland_2050_3Q,
#                    by = c("SCENARIO", "subregionname", "landarea")) %>%
#   dplyr::full_join(cropland_2050_4Q,
#                    by = c("SCENARIO", "subregionname", "landarea")) %>%
#   dplyr::group_by(subregionname) %>%
#   tidyr::fill(kha_2021) %>%
#   tidyr::drop_na(SCENARIO)
# 
# head(cropland_2021and2050_wide)
# 
# ```
# 
# Map the difference.
# 
# ```{r}
# library(sf)
# library(ggspatial)
# library(rnaturalearth)
# library(rnaturalearthdata)
# ```
# 
# 
# 
# ```{r}
# world <- ne_countries(scale = "medium", returnclass = "sf")
# 
# cropland_change_map <- world %>% 
#   dplyr::full_join(loc_map_reduced %>% 
#                      dplyr::rename(iso_a3 = iso_alpha3), 
#                    by = "iso_a3") %>% 
#   dplyr::full_join(cropland_2021and2050_wide, 
#                    by = "subregionname")
# 
# ```
# 
# ```{r, quiet=TRUE}
# library(scales)
# ```
# 
```{r}
dat <- cropland_change_map %>% 
         dplyr::filter(year == 2050)

p6a <- ggplot(data = dat) + 
  geom_sf(color = "black", fill = NA, lwd = 0.1) + 
  geom_sf(data = dat %>% filter(diet_plan == "ELA-PHD" & kha_Qu4YG < 1 & SCENARIO == "SSP1_v9_130115"), aes(fill = kha_Qu4YG), alpha = 0.8, lwd = 0.1) + 
  # coord_sf(crs = 54030) +
  cowplot::theme_minimal() + 
  scale_fill_gradient(low = muted("blue"), high = muted("firebrick"), labels = scales::label_percent(accuracy = 1), limits= c(0,1)) + 
  theme(
    axis.text = element_blank(), 
     legend.title = element_blank(), 
   legend.text = element_text(size = 8)
  ) + 
  labs(
    subtitle = "Potential net exporters in 2050"
    # , 
    # subtitle = "SSP2 with yield gap 100% closed"
  )

p6_legend_only <- cowplot::get_legend(p6a)

p6a <- p6a +
  theme(legend.position = "none")

p6b <- ggplot(data = dat) + 
  geom_sf(color = "black", fill = NA, lwd = 0.1) + 
  geom_sf(data = dat %>% filter(diet_plan == "ELA-PHD" & kha_Qu4YG >= 1 & SCENARIO == "SSP1_v9_130115"), aes(fill = factor(kha_Qu4YG)), alpha = 0.7, lwd = 0.1) + 
  # coord_sf(crs = 54030) +
  cowplot::theme_minimal() + 
  scale_fill_grey(end = 0) + 
  theme(
    axis.text = element_blank(), 
    legend.title = element_blank(), 
    legend.text = element_text(size = 8), 
    legend.position = "none"
  ) + 
  labs(
    subtitle = "Obligatory net importers in 2050"
    # , 
    # subtitle = "SSP2 with yield gap 100% closed"
  )

p6c <- ggplot(data = dat) + 
  geom_sf(color = "black", fill = NA, lwd = 0.1) + 
  geom_sf(data = dat %>% filter(diet_plan == "FDA-SDP" & kha_Qu1YG < 1 & SCENARIO == "SSP3_v9_130115"), aes(fill = kha_Qu1YG), alpha = 0.8, lwd = 0.1) + 
  # coord_sf(crs = 54030) +
  cowplot::theme_minimal() + 
  scale_fill_gradient(low = muted("blue"), high = muted("firebrick"), labels = scales::label_percent(accuracy = 1), limits= c(0,1)) + 
  theme(
    axis.text = element_blank(), 
    legend.title = element_blank(), 
    legend.text = element_text(size = 8), 
    legend.position = "none"
  ) + 
  labs(
    subtitle = "Potential net exporters in 2050"
    # , 
    # subtitle = "SSP3 with yield gap 25% closed"
  )

p6d <- ggplot(data = dat) + 
  geom_sf(color = "black", fill = NA, lwd = 0.1) + 
  geom_sf(data = dat %>% filter(diet_plan == "FDA-SDP" & kha_Qu1YG >= 1 & SCENARIO == "SSP3_v9_130115"), aes(fill = factor(kha_Qu1YG)), alpha = 0.7, lwd = 0.1) + 
  # coord_sf(crs = 54030) +
  cowplot::theme_minimal() + 
  scale_fill_grey(end = 0) + 
  theme(
    axis.text = element_blank(), 
    legend.title = element_blank(), 
    legend.text = element_text(size = 8), 
    legend.position = "none"
  ) + 
  labs(
    subtitle = "Obligatory net importers in 2050"
    # , 
    # subtitle = "SSP3 with yield gap 25% closed"
  )

```

```{r}

box1 <- cowplot::plot_grid(p6a, p6b, nrow = 2) + 
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1))

box2 <- cowplot::plot_grid(p6c, p6d, nrow = 2) + 
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1))


plot_grid(plot_grid(box1, box2, ncol = 2), p6_legend_only, rel_widths = c(1,0.2))

# plot_grid(box1, box2, labels = c('SSP1 & ELA-PHD with yield gap 100% closed', 'SSP3 & FDA-SDP with yield gap 25% closed'), label_size = 8, ncol = 2)

```



```{r}

p_cropland_change_0 <- ggplot(data = cropland_change_map %>% 
         dplyr::filter(!is.na(subregionname) & subregion != "Antarctica" & subregionname != "South Asia")) + 
  geom_sf(aes(fill = (kha_2050_Qu0YG/kha_2021)), lwd = 0) + 
  theme_minimal() + 
  theme(
    panel.background = element_rect(fill = muted("blue", l = 90, c = 50)), 
    legend.title = element_blank()
  ) + 
  coord_sf(datum = NA) + 
  # coord_sf(crs = "+proj=laea +lat_0=0 +lon_0=0 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs") + 
  labs(
    title = "Relative cropland expansion, 2021 to 2050", 
    subtitle = "With average yield (YA) values unchanged", 
    fill = "ratio"
  ) + 
  scale_fill_gradient2(low = "lightgrey", mid = muted("red"), high = muted("purple"), midpoint = 7.5) + 
  facet_wrap(~SCENARIO, 
             ncol = 2)

p_cropland_relative_0 <- ggplot(data = cropland_change_map %>% 
         dplyr::filter(!is.na(subregionname) & subregionname != "South Asia" & subregion != "Antarctica")) + 
  geom_sf(aes(fill = (kha_2050_Qu0YG/landarea)), lwd = 0) + 
  theme_minimal() + 
  theme(
    panel.background = element_rect(fill = muted("blue", l = 90, c = 50)), 
    legend.title = element_blank()
  ) + 
  coord_sf(datum = NA) + 
  # coord_sf(crs = "+proj=laea +lat_0=0 +lon_0=0 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs") + 
  labs(
    title = "Cropland demand in 2050 relative to total area", 
    subtitle = "With average yield (YA) values unchanged", 
    fill = "ratio"
  ) + 
  scale_fill_gradient2(low = "lightgrey", mid = muted("red"), high = muted("purple"), midpoint = 1) + 
  facet_wrap(~SCENARIO, 
             ncol = 2)

p_cropland_change_0
p_cropland_relative_0

```

```{r}

p_cropland_change_2 <- ggplot(data = cropland_change_map %>% 
         dplyr::filter(!is.na(subregionname) & subregion != "Antarctica" & subregionname != "South Asia")) + 
  geom_sf(aes(fill = (kha_2050_Qu2YG/kha_2021)), lwd = 0) + 
  theme_minimal() + 
  theme(
    panel.background = element_rect(fill = muted("blue", l = 90, c = 50)), 
    legend.title = element_blank()
  ) + 
  coord_sf(datum = NA) + 
  # coord_sf(crs = "+proj=laea +lat_0=0 +lon_0=0 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs") + 
  labs(
    title = "Relative cropland expansion, 2021 to 2050", 
    subtitle = "With average yield (YA) values closed by 50%", 
    fill = "ratio"
  ) + 
  scale_fill_gradient2(low = "lightgrey", mid = muted("red"), high = muted("purple"), midpoint = 5) + 
  facet_wrap(~SCENARIO, 
             ncol = 2)

p_cropland_relative_2 <- ggplot(data = cropland_change_map %>% 
         dplyr::filter(!is.na(subregionname) & subregionname != "South Asia" & subregion != "Antarctica")) + 
  geom_sf(aes(fill = (kha_2050_Qu2YG/landarea)), lwd = 0) + 
  theme_minimal() + 
  theme(
    panel.background = element_rect(fill = muted("blue", l = 90, c = 50)), 
    legend.title = element_blank()
  ) + 
  coord_sf(datum = NA) + 
  # coord_sf(crs = "+proj=laea +lat_0=0 +lon_0=0 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs") + 
  labs(
    title = "Cropland demand in 2050 relative to total area", 
    subtitle = "With average yield (YA) values closed by 50%", 
    fill = "ratio"
  ) + 
  scale_fill_gradient2(low = "lightgrey", mid = muted("red"), high = muted("purple"), midpoint = 1) + 
  facet_wrap(~SCENARIO, 
             ncol = 2)

p_cropland_change_2
p_cropland_relative_2

```
```{r}

p_cropland_change_3 <- ggplot(data = cropland_change_map %>% 
         dplyr::filter(!is.na(subregionname) & subregion != "Antarctica")) + 
  geom_sf(aes(fill = (kha_2050_Qu3YG/kha_2021)), lwd = 0) + 
  theme_minimal() + 
  theme(
    panel.background = element_rect(fill = muted("blue", l = 90, c = 50)), 
    legend.title = element_blank()
  ) + 
  coord_sf(datum = NA) + 
  # coord_sf(crs = "+proj=laea +lat_0=0 +lon_0=0 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs") + 
  labs(
    title = "Relative cropland expansion, 2021 to 2050", 
    subtitle = "With average yield (YA) values closed by 75%", 
    fill = "ratio"
  ) + 
  scale_fill_gradient2(low = "lightgrey", mid = muted("red"), high = muted("purple"), midpoint = 3) + 
  facet_wrap(~SCENARIO, 
             ncol = 2)

p_cropland_relative_3 <- ggplot(data = cropland_change_map %>% 
         dplyr::filter(!is.na(subregionname) & subregion != "Antarctica")) + 
  geom_sf(aes(fill = (kha_2050_Qu3YG/landarea)), lwd = 0) + 
  theme_minimal() + 
  theme(
    panel.background = element_rect(fill = muted("blue", l = 90, c = 50)), 
    legend.title = element_blank()
  ) + 
  coord_sf(datum = NA) + 
  # coord_sf(crs = "+proj=laea +lat_0=0 +lon_0=0 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs") + 
  labs(
    title = "Cropland demand in 2050 relative to total area", 
    subtitle = "With average yield (YA) values closed by 75%", 
    fill = "ratio"
  ) + 
  scale_fill_gradient2(low = "lightgrey", mid = muted("red"), high = muted("purple"), midpoint = 1) + 
  facet_wrap(~SCENARIO, 
             ncol = 2)

p_cropland_change_3
p_cropland_relative_3

```


Now, similarly for pasture, calculate the change ratios for pasture demand between 2021 and 2050, and the demand in 2050 compared to total land area for the region.
```{r}

pasture_2021_2050 <- land_use_2000to2021 %>% 
  dplyr::select(Year, subregionname, landarea, pasture) %>% 
  dplyr::rename(year = Year) %>% 
  dplyr::filter(year == 2021) %>% 
  dplyr::mutate(
    landarea_ha = landarea*1e3, 
    pasture_ha = pasture*1e3
  ) %>% 
  dplyr::select(year, subregionname, landarea_ha, pasture_ha) %>% 
  dplyr::full_join(pasture_demand_summary, 
                   by = c("year", "subregionname", "pasture_ha")) %>% 
  dplyr::group_by(subregionname) %>% 
  tidyr::fill(landarea_ha) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    ratio = pasture_ha/landarea_ha
  )

head(pasture_2021_2050)

```


```{r}

pasture_2021_2050_wide <- pasture_2021_2050 %>% 
  dplyr::filter(year == 2021) %>% 
  dplyr::rename(pasture_2021_ha = pasture_ha) %>% 
  dplyr::select(-year, -ratio, -SCENARIO) %>% 
  dplyr::full_join(pasture_2021_2050 %>% 
                     dplyr::filter(year == 2050) %>% 
                     dplyr::rename(pasture_2050_ha = pasture_ha) %>% 
                     dplyr::select(-year, -landarea_ha, -ratio), 
                   by = "subregionname")

head(pasture_2021_2050_wide)

```

```{r}

pasture_change_map <- world %>% 
  dplyr::full_join(loc_map_reduced %>% 
                     dplyr::rename(iso_a3 = iso_alpha3), 
                   by = "iso_a3") %>% 
  dplyr::full_join(pasture_2021_2050_wide, 
                   by = "subregionname")

```


```{r}

p_pasture_change <- ggplot(data = pasture_change_map %>% 
         dplyr::filter(!is.na(subregionname) & subregion != "Antarctica")) + 
  geom_sf(aes(fill = (pasture_2050_ha/pasture_2021_ha)), lwd = 0) + 
  theme_minimal() + 
  theme(
    panel.background = element_rect(fill = muted("blue", l = 90, c = 50)), 
    legend.title = element_blank()
  ) + 
  coord_sf(datum = NA) + 
  # coord_sf(crs = "+proj=laea +lat_0=0 +lon_0=0 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs") + 
  labs(
    title = "Relative pasture expansion, 2021 to 2050", 
    fill = "ratio"
  ) + 
  scale_fill_gradient2(low = "lightgrey", mid = muted("red"), high = muted("purple"), midpoint = 15) + 
  facet_wrap(~SCENARIO)

p_pasture_relative <- ggplot(data = pasture_change_map %>% 
         dplyr::filter(!is.na(subregionname) & subregion != "Antarctica")) + 
  geom_sf(aes(fill = (pasture_2050_ha/landarea_ha)), lwd = 0) + 
  theme_minimal() + 
  theme(
    panel.background = element_rect(fill = muted("blue", l = 90, c = 50)), 
    legend.title = element_blank()
  ) + 
  coord_sf(datum = NA) + 
  # coord_sf(crs = "+proj=laea +lat_0=0 +lon_0=0 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs") + 
  labs(
    title = "Pasture demand in 2050 relative to land area", 
    fill = "ratio"
  )+ 
  scale_fill_gradient2(low = "lightgrey", mid = muted("red"), high = muted("purple"), midpoint = 1.5) + 
  facet_wrap(~SCENARIO)

# p_pasture_change
# p_pasture_relative

```


```{r}

cowplot::plot_grid(p_cropland_change_3, p_pasture_change, p_cropland_relative_3, p_pasture_relative, ncol = 2, align = "vh")

```

```{r}

dat1 <- cropland_2021and2050_wide %>% 
  mutate(
    ratio1_0 = kha_2050_Qu0YG/kha_2021, 
    ratio1_1 = kha_2050_Qu1YG/kha_2021, 
    ratio1_2 = kha_2050_Qu2YG/kha_2021, 
    ratio1_3 = kha_2050_Qu3YG/kha_2021, 
    ratio1_4 = kha_2050_Qu4YG/kha_2021, 
    ratio2_0 = kha_2050_Qu1YG/landarea, 
    ratio2_1 = kha_2050_Qu1YG/landarea, 
    ratio2_2 = kha_2050_Qu2YG/landarea, 
    ratio2_3 = kha_2050_Qu3YG/landarea, 
    ratio2_4 = kha_2050_Qu4YG/landarea
  )

dat2 <- pasture_2021_2050_wide %>% 
  mutate(ratio1 = pasture_2050_ha/pasture_2021_ha, 
         ratio2 = pasture_2050_ha/landarea_ha)

head(dat1)
head(dat2)

```
```{r}
dat1_long <- dat1 %>% 
  dplyr::select(SCENARIO, subregionname, ratio1_0, ratio1_1, ratio1_2, ratio1_3, ratio1_4) %>% 
  tidyr::pivot_longer(., cols = ratio1_0:ratio1_4)

dat1_long

dat1a_long <- dat1 %>% 
  dplyr::select(SCENARIO, subregionname, ratio2_0, ratio2_1, ratio2_2, ratio2_3, ratio2_4) %>% 
  tidyr::pivot_longer(., cols = ratio2_0:ratio2_4)

dat1a_long
```


```{r}

p_cropland_change_1a <- ggplot(data = dat1_long %>% 
                                 dplyr::filter(SCENARIO == "SSP2_v9_130115"), 
       aes(x = reorder(subregionname, -value), 
           y = value)) + 
  geom_col(aes(fill = name), 
           position = "dodge", 
           colour = "black", 
           size = 0.2) + 
  geom_hline(yintercept = 1, alpha = 0.8) + 
  theme_minimal_vgrid() + 
  theme(
    legend.position = "top", 
    legend.title = element_text(size = 11), 
    legend.text = element_text(size = 10), 
    axis.text.x = element_text(angle = 90, size = 8, hjust = 1, vjust = 0.5), 
    axis.title.y = element_text(size = 11), 
    axis.text.y = element_text(size = 10), 
    axis.ticks.x = element_blank(), 
    panel.grid = element_line(size = 8)
  ) + 
  labs(
    subtitle = "For SSP2 demand", 
    x = "", 
    y = "Cropland area growth from 2021"
  ) + 
  scale_y_log10() + 
  scale_fill_brewer(palette=3, 
                    labels = c("0% YG", "25% YG", "50% YG", "75% YG", "100% YG"), 
                    name = "Proportion of yield gap closed")

p_cropland_change_1a

```

```{r}

p_cropland_relative_1b <- ggplot(data = dat1a_long %>% 
                                 dplyr::filter(SCENARIO == "SSP2_v9_130115"), 
       aes(x = reorder(subregionname, -value), 
           y = value)) + 
  geom_col(aes(fill = name), 
           position = "dodge", 
           colour = "black", 
           size = 0.2) + 
  geom_hline(yintercept = 1, alpha = 0.8, linetype = 2) + 
  theme_minimal_vgrid() + 
  theme(
    legend.position = "top", 
    legend.title = element_text(size = 11), 
    legend.text = element_text(size = 10), 
    axis.text.x = element_text(angle = 90, size = 8, hjust = 1, vjust = 0.5), 
    axis.title.y = element_text(size = 11), 
    axis.text.y = element_text(size = 9), 
    axis.ticks.x = element_blank(), 
    panel.grid = element_line(size = 8)
  ) + 
  labs(
    subtitle = "For SSP2 demand", 
    x = "", 
    y = "Cropland area to land area"
  ) + 
  scale_y_continuous(labels = scales::percent) + 
  scale_fill_brewer(palette=3, 
                    labels = c("0% YG", "25% YG", "50% YG", "75% YG", "100% YG"), 
                    name = "Proportion of yield gap closed")

p_cropland_relative_1b

```

```{r}

dat1_long_update <- dat1_long %>% 
  separate(name, c("ratio", "yp"), "_")

tmp <- dat1a_long %>% 
  separate(name, c("ratio", "yp"), "_")

cropland_ratios_dat <- dat1_long_update %>% 
  dplyr::bind_rows(tmp) %>% 
  dplyr::mutate(ratio = ifelse(ratio == "ratio1", 
                               "2050 cropland : 2021 cropland", 
                               "2050 cropland : land area"))
```

```{r}


breaks <- 10^(-10:10)
minor_breaks <- rep(1:9, 21)*(10^rep(-10:10, each=9))

p_cropland_ratios <- ggplot(data = cropland_ratios_dat %>% 
                                 dplyr::filter(SCENARIO == "SSP2_v9_130115"), 
       aes(x = reorder(subregionname, -value), 
           y = value)) + 
  geom_col(aes(fill = yp), 
           position = "dodge", 
           colour = "black", 
           size = 0.2) + 
  geom_hline(yintercept = 1) + 
  theme_minimal() + 
  theme(
   legend.position = "top", 
    legend.title = element_text(size = 11), 
    legend.text = element_text(size = 10), 
   axis.title.x = element_blank(), 
    axis.text.x = element_text(angle = 90, size = 8, hjust = 1, vjust = 0.5), 
    axis.title.y = element_blank(), 
    axis.text.y = element_text(size = 9), 
    axis.ticks.x = element_blank(), 
    panel.border = element_rect(colour = "black", size = 0.5, fill = NA) 
   # panel.grid.major.x = element_line(size = 4)
  ) + 
   labs(
    # title = "Pasture", 
    # subtitle = "Log ratio of pasture area demand in 2050 to 2021", 
    # y = expression(10^n)
  ) + 
  scale_fill_brewer(palette=3, 
                    labels = c("0%", "25%", "50%", "75%", "100%"), 
                    name = "Proportion of yield gap closed") + 
  scale_y_log10(breaks = breaks, minor_breaks = minor_breaks, labels = trans_format("log10", math_format(10^.x))) +
  # coord_flip() + 
  facet_wrap(~ratio, 
             nrow = 2, 
             scales = "free_y")

p_cropland_ratios
```

Cropland savings

By closing yield gaps, the following land areas can be spared for non-crop uses.
```{r}
cropland_spared <- cropland_2021and2050_wide %>%
  dplyr::mutate(
    cropland_change_max = kha_2050_Qu0YG - kha_2021,
    cropland_change_min = kha_2050_Qu4YG - kha_2021,
    cropland_spared = kha_2050_Qu0YG - kha_2050_Qu4YG
  )

head(cropland_spared)
```

```{r}
breaks <- seq(0, 2e6, by = 2.5e5)

fancy_scientific <- function(l) {
     # turn in to character string in scientific notation
     l <- format(l, scientific = TRUE)
     # quote the part before the exponent to keep all the digits
     l <- gsub("^(.*)e", "'\\1'e", l)
     # turn the 'e+' into plotmath format
     l <- gsub("e", "%*%10^", l)
     # return this as an expression
     parse(text=l)
}

ggplot(cropland_spared,
       aes(x = reorder(subregionname,-cropland_spared),
           y = cropland_spared*(1e-6))) +
  geom_col(
    aes(fill = SCENARIO),
    position = "dodge",
    colour = "black",
    size = 0.2
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10),
    axis.title.x = element_blank(),
    axis.text.x = element_text(
      angle = 90,
      size = 8,
      hjust = 1,
      vjust = 0.5
    ),
    # axis.title.y = element_blank(),
    axis.text.y = element_text(size = 9),
    axis.ticks.x = element_blank(),
    panel.border = element_rect(
      colour = "black",
      size = 0.5,
      fill = NA
    )
    # panel.grid.major.x = element_line(size = 4)
  ) + 
  labs(
    title = "Agricultural land spared by closing the yield gap, 2021 to 2050"
  ) + 
  scale_fill_brewer(
    palette = 6,
    labels = c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5"),
    name = "Scenario"
  ) +
  scale_y_continuous(
    # breaks = breaks,
    # minor_breaks = minor_breaks,
    # labels = trans_format("log10", math_format(10 ^ .x)), 
    name = expression(10^9~ha)
  )

```


```{r}
p_cropland_change_1 <- ggplot(data = dat1_long, 
       aes(x = reorder(subregionname, -value), 
           y = value)) + 
  geom_col(aes(fill = name), 
           position = "dodge", 
           colour = "black", 
           size = 0.2) + 
  geom_hline(yintercept = 1, alpha = 0.8) + 
  theme_minimal_vgrid() + 
  theme(
    legend.position = "top", 
    legend.title = element_text(size = 11), 
    legend.text = element_text(size = 10), 
    axis.text.x = element_text(angle = 90, size = 8, hjust = 1, vjust = 0.5), 
    axis.title.x = element_blank(), 
    axis.title.y = element_text(size = 11), 
    axis.text.y = element_text(size = 10), 
    axis.ticks.x = element_blank(), 
    panel.grid = element_line(size = 8)
  ) + 
  scale_y_log10() + 
  scale_fill_brewer(palette=3, 
                    labels = c("0% YG", "25% YG", "50% YG", "75% YG", "100% YG"), 
                    name = "Proportion of yield gap closed")

p_cropland_change_1
```


```{r}
cropland_abs_differences <- dat1 %>% 
  dplyr::select(subregionname, landarea, kha_2021, kha_2050_Qu0YG, kha_2050_Qu1YG, kha_2050_Qu2YG, kha_2050_Qu3YG, kha_2050_Qu4YG) %>% 
  tidyr::pivot_longer(., cols = kha_2050_Qu0YG:kha_2050_Qu4YG) %>% 
  tidyr::separate(name, c("kha_2050", "YG"), "_Qu") %>% 
  dplyr::mutate(kha_2050 = value, 
                diff_kha = kha_2050 - kha_2021) %>% 
  dplyr::select(-value)

cropland_abs_differences


cropland_abs_differences_regions <- cropland_abs_differences %>% 
  dplyr::group_by(YG) %>% 
  dplyr::summarise(landarea = sum(landarea), 
                   kha_2021 = sum(kha_2021), 
                   kha_2050 = sum(kha_2050), 
                   diff_kha = sum(diff_kha)*1e-6, 
                   .groups = "drop") %>% 
  dplyr::mutate(landarea_ratio_2050 = kha_2050/landarea) %>% 
  dplyr::select(YG, diff_kha, landarea_ratio_2050) %>% 
  tidyr::pivot_longer(., cols = diff_kha:landarea_ratio_2050) %>% 
  dplyr::mutate(unit = ifelse(name == "diff_kha", 
                              "Gha", 
                              "unitless"), 
                label = ifelse(name == "diff_kha", 
                               "2050 crop area - 2021 crop area", 
                               "Ratio to total land area"))

cropland_abs_differences_regions
```

```{r}

breaks <- 10^(-10:10)
minor_breaks <- rep(1:9, 21)*(10^rep(-10:10, each = 9))

p_cropland_abs_differences_regions <- ggplot(data = cropland_abs_differences_regions, 
       aes(x = 1, 
           y = value)) + 
  geom_col(aes(fill = YG), 
           position = "dodge", 
           colour = "black", 
           size = 0.2) + 
  theme_minimal() + 
  theme(
   legend.position = "top", 
   legend.title = element_text(size = 11), 
   legend.text = element_text(size = 10), 
   axis.text.x = element_blank(), 
   axis.text.y = element_text(size = 9), 
   axis.ticks.x = element_blank(), 
   panel.border = element_rect(colour = "black", size = 0.5, fill = NA), 
   panel.grid.major.x = element_blank(), 
   panel.grid.minor.x = element_blank()
  ) + 
   labs(
    # title = "Pasture", 
    # subtitle = "Log ratio of pasture area demand in 2050 to 2021", 
    x = "World"
  ) + 
  scale_fill_brewer(palette=3, 
                    labels = c("0% YG", "25% YG", "50% YG", "75% YG", "100% YG"), 
                    name = "Proportion of yield gap closed") + 
  facet_wrap(~label, 
             nrow = 2)
# + 
#   scale_y_log10(breaks = breaks, minor_breaks = minor_breaks, labels = trans_format("log10", math_format(10^.x)))

p_cropland_abs_differences_regions

```


```{r}
dat2_long <- dat2 %>% 
  dplyr::select(subregionname, ratio1, ratio2) %>% 
  tidyr::pivot_longer(., cols = ratio1:ratio2) %>% 
  dplyr::mutate(name = ifelse(name == "ratio1", "2050 pasture : 2021 pasture", "2050 pasture : total area"))
```

```{r}
breaks <- 10^(-10:10)
minor_breaks <- rep(1:9, 21)*(10^rep(-10:10, each=9))

p_pasture_ratios <- ggplot(data = dat2_long, 
       aes(x = reorder(subregionname, value), 
           y = value)) + 
  geom_col() + 
  geom_hline(yintercept = 1) + 
  theme_minimal() + 
  theme(
    axis.text.y = element_text(size = 9), 
    axis.title.y = element_blank(), 
    axis.text.x = element_text(angle = 90, size = 8, hjust = 1, vjust = 0.5), 
    axis.title.x = element_blank(), 
    axis.ticks.y = element_blank(), 
    panel.border = element_rect(colour = "black", size = 0.5, fill = NA) 
  ) + 
   labs(
    # title = "Pasture", 
    # subtitle = "Log ratio of pasture area demand in 2050 to 2021", 
    # y = expression(10^n)
  ) + 
  scale_y_log10(breaks = breaks, minor_breaks = minor_breaks, labels = trans_format("log10", math_format(10^.x))) + 
  # coord_flip() + 
  facet_wrap(~name, 
             nrow = 2)

p_pasture_ratios
```


```{r}

ggplot(data = dat2, 
       aes(x = reorder(subregionname, -ratio1), 
           y = (ratio1))) + 
  geom_col() + 
  geom_hline(yintercept = 1) + 
  theme(
    axis.text.y = element_text(size = 6), 
    axis.title.y = element_blank(), 
    axis.title.x = element_text(size = 10)
  ) + 
  labs(
    title = "Pasture", 
    subtitle = "Log ratio of pasture area demand in 2050 to 2021", 
    y = expression(10^n)
  ) + 
  scale_y_log10() + 
  coord_flip()

ggplot(data = dat2, 
       aes(x = reorder(subregionname, -ratio1), 
           y = (ratio2))) + 
  geom_col() + 
  geom_hline(yintercept = 1) + 
  theme(
    axis.text.y = element_text(size = 6), 
    axis.title.y = element_blank(), 
    axis.title.x = element_text(size = 10)
  ) + 
  labs(
    title = "Pasture", 
    subtitle = "Log ratio of pasture area demand in 2050 to regional land area", 
    y = expression(10^n)
  ) + 
  scale_y_log10() + 
  coord_flip()

```



# Trade to balance crop and pasture demand with land use commitments

TODO This later.




Food supply

Calculate food supply from crops not used for other things.

```{r}
crop_prod_region <- crops_production %>% 
  dplyr::filter(!is.na(element) & !is.na(crop_type) & !is.na(subregionname)) %>% 
  dplyr::group_by(subregionname, crop_type, Year) %>% 
  dplyr::summarise(production_tonnes = sum(value, na.rm = TRUE), 
                   .groups = "drop")

```

Total population and food supply numbers.
```{r}
populations <- food_balance_data_defs %>% 
  dplyr::filter(Item.Code == 2501 & Element.Code == 511) %>% #Population
  dplyr::mutate(total_pop = Value*1e3) %>% 
  dplyr::select(Area.Code, Area, Year, total_pop)

food_supply_total <- food_balance_data_defs %>% 
  dplyr::filter(Item.Code == 2901 & Element.Code == 664) %>% #Food supply (kcal/capita/day)
  dplyr::mutate(kcal_cap_day = Value) %>% 
  dplyr::select(Area.Code, Area, Year, kcal_cap_day)

protein_supply_total <- food_balance_data_defs %>% 
  dplyr::filter(Item.Code == 2901 & Element.Code == 674) %>% #Protein supply quantity (g/capita/day)
  dplyr::mutate(g_cap_day = Value) %>% 
  dplyr::select(Area.Code, Area, Year, g_cap_day)

fat_supply_total <- food_balance_data_defs %>% 
  dplyr::filter(Item.Code == 2901 & Element.Code == 684) %>% #Fat supply quantity (g/capita/day)
  dplyr::mutate(g_cap_day = Value) %>% 
  dplyr::select(Area.Code, Area, Year, g_cap_day)
```

Food supply numbers by model group.
```{r}
food_supply_modelgroup <- food_balance_data_defs %>% 
  dplyr::filter(Element.Code == 664) %>% #Food supply (kcal/capita/day)
  dplyr::group_by(Area.Code, Area, Year, model_group) %>% 
  dplyr::summarise(kcal_cap_day = sum(Value, 
                                      na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::full_join(populations, 
                   by = c("Area.Code", "Area", "Year")) %>% 
  tidyr::drop_na() %>% 
  dplyr::mutate(kcal_day = kcal_cap_day*total_pop)

protein_supply_modelgroup <- food_balance_data_defs %>% 
  dplyr::filter(Element.Code == 674) %>% #Protein supply (g/capita/day)
  dplyr::group_by(Area.Code, Area, Year, model_group) %>% 
  dplyr::summarise(g_cap_day = sum(Value, 
                                      na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::full_join(populations, 
                   by = c("Area.Code", "Area", "Year")) %>% 
  tidyr::drop_na() %>% 
  dplyr::mutate(g_day = g_cap_day*total_pop)

fat_supply_modelgroup <- food_balance_data_defs %>% 
  dplyr::filter(Element.Code == 684) %>% #Fat supply (g/capita/day)
  dplyr::group_by(Area.Code, Area, Year, model_group) %>% 
  dplyr::summarise(g_cap_day = sum(Value, 
                                      na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::full_join(populations, 
                   by = c("Area.Code", "Area", "Year")) %>% 
  tidyr::drop_na() %>% 
  dplyr::mutate(g_day = g_cap_day*total_pop)

```


We need to map the model-groups used here with the groups used in the EAT-Lancet planetary health diet.
```{r}
EATlancet_model_group_map <- data.frame(
  model_group = c("alcohol", "aquaticmarine_product", "aves_dairy", "aves_meat", "beehive", "bovine_dairy", "bovine_meat", "caprine_meat", "cereal", "citrus", "fish_meat", "fish_other", "fruit", "oilcrop", "pulse", "rootstubers", "spices", "stimulants", "sugarcrop", "sus_meat", "treenut", "vegetable"), 
  EATlancet_group = c(NA, NA, "eggs", "chicken_poultry", NA, "dairy", "beef_lamb_pork", "beef_lamb_pork", "whole_grains", "fruits", "fish", "fish", "fruits", "all_oils", "legumes", "tubers_starchy_vegetables", NA, NA, "all_sugars", "beef_lamb_pork", "nuts", "vegetables")
)

```

Merge these data with Subregional areas.

```{r}

food_supply_modelgroup_regions <- food_supply_modelgroup %>% 
  dplyr::rename(fao_countrycode = Area.Code) %>% 
  dplyr::full_join(loc_map_reduced, 
                   by = "fao_countrycode") %>% 
  dplyr::group_by(subregionname, Year, model_group) %>% 
  dplyr::summarise(kcal_day = sum(kcal_day, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::left_join(EATlancet_model_group_map, 
                   by = "model_group") %>% 
  tidyr::drop_na()

protein_supply_modelgroup_regions <- protein_supply_modelgroup %>% 
  dplyr::rename(fao_countrycode = Area.Code) %>% 
  dplyr::full_join(loc_map_reduced, 
                   by = "fao_countrycode") %>% 
  dplyr::group_by(subregionname, Year, model_group) %>% 
  dplyr::summarise(g_day = sum(g_day, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::left_join(EATlancet_model_group_map, 
                   by = "model_group") %>% 
  tidyr::drop_na()

fat_supply_modelgroup_regions <- fat_supply_modelgroup %>% 
  dplyr::rename(fao_countrycode = Area.Code) %>% 
  dplyr::full_join(loc_map_reduced, 
                   by = "fao_countrycode") %>% 
  dplyr::group_by(subregionname, Year, model_group) %>% 
  dplyr::summarise(g_day = sum(g_day, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::left_join(EATlancet_model_group_map, 
                   by = "model_group") %>% 
  tidyr::drop_na()

```





```{r}

model_group_kcal <- food_balance_data_defs %>% 
  dplyr::filter(!is.na(model_group) & !is.na(Element) & Element.Code == 664) %>% 
  dplyr::group_by(Area.Code, Area, model_group, Year) %>% 
  dplyr::summarise(kcal_percap_perday = sum(Value, 
                                            na.rm = TRUE)) %>% 
  dplyr::ungroup()

model_group_prot <- food_balance_data_defs %>% 
  dplyr::filter(!is.na(model_group) & !is.na(Element) & Element.Code == 674) %>% 
  dplyr::group_by(Area.Code, Area, model_group, Year) %>% 
  dplyr::summarise(g_protein_percap_perday = sum(Value, 
                                                 na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::ungroup()

model_group_fats <- food_balance_data_defs %>% 
  dplyr::filter(!is.na(model_group) & !is.na(Element) & Element.Code == 684) %>% 
  dplyr::group_by(Area.Code, Area, model_group, Year) %>% 
  dplyr::summarise(g_fat_percap_perday = sum(Value, 
                                             na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::ungroup()

```

