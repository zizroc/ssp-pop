---
title: "Diet Transformation"
author: "Marcus J Thomson"
date: "10/7/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyr)
library(dplyr)
library(purrr)
library(ggplot2)
library(cowplot)
```

# Dietary Transformation Pathways

Here I calculate pathway trajectories from the present food/feed supply patterns to hypothetical future patterns based on demands from the projections calculated in `iep_healthy_food.Rmd`.

```{r}
data_path <- "/home/thomson/Projects/iep_food/data/"
```

## FAO Food Balance Data

Read in Food Balance data from FAOSTAT. Source: [FAOSTAT.](http://www.fao.org/faostat/en/#data/FBS)

```{r}
foodbalance_df <- readr::read_csv(
  file = paste0(data_path, "FoodBalanceSheets_E_All_Data_(Normalized).csv"),
  col_types = cols(
    `Area Code` = col_double(),
    Area = col_character(),
    `Item Code` = col_double(),
    Item = col_character(),
    `Element Code` = col_double(),
    Element = col_character(),
    `Year Code` = col_double(),
    Year = col_double(),
    Unit = col_character(),
    Value = col_double(),
    Flag = col_character()
  )) %>% 
  rename(
    "area_code" = "Area Code",
    "area" = "Area",
    "item_code" = "Item Code",
    "item" = "Item",
    "element_code" = "Element Code",
    "element" = "Element",
    "year_code" = "Year Code",
    "year" = "Year",
    "unit" = "Unit",
    "value" = "Value",
    "flag" = "Flag"
  )
  
```

I made a separate CSV file to map the FAO elements/element codes onto the model_groups I use for this analysis.
```{r}
foodbalance_map <- readr::read_csv(
  file = paste0(data_path, "Daily Energy Requirements for Humans - food_map.csv"),
  col_types = cols(
    item_code = col_double(),
    item = col_character(),
    model_group1 = col_character(),
    model_group = col_character()
  )
)


```

Select only those elements that have to do with food and food supply.
```{r}

food_elements <- data.frame(
  element <- c("Food", "Food supply"),
  units <- c("1000 t/yr", "kcal/cap/yr"),
  element_code <- c(5142, 664)
)

```

Merge the FAO df with the foodbalance mapper to create clean dfs `food_df` and `feed_df`.
```{r}
food_df <- foodbalance_df %>%
  dplyr::filter(element_code %in% c(5142)) %>%
  dplyr::left_join(foodbalance_map,
                   by = c("item_code", "item")) %>% 
  tidyr::drop_na()

feed_df <- foodbalance_df %>%
  dplyr::filter(element_code %in% c(5521)) %>%
  dplyr::left_join(foodbalance_map,
                   by = c("item_code", "item")) %>% 
  tidyr::drop_na()

```

Aggregate tonnes of food/feed by model_group.
```{r}

food_countries <- food_df %>% 
  dplyr::group_by(area_code, area, year, model_group) %>% 
  dplyr::summarise(tonnes_yr = 1e3*sum(value, na.rm = TRUE), 
                   .groups = "drop")

feed_countries <- feed_df %>% 
  dplyr::group_by(area_code, area, year, model_group) %>% 
  dplyr::summarise(tonnes_yr = 1e3*sum(value, na.rm = TRUE), 
                   .groups = "drop")

```

Let's have a look at world production of food and feed. 
```{r}

food_world <- food_countries %>% 
  dplyr::filter(area == "World") 
feed_world <- feed_countries %>% 
  dplyr::filter(area == "World") 

food_grouped_data <- food_world %>% 
  dplyr::mutate(source_group = ifelse(model_group %in% c("beef_lamb_pork", "meat_poultry", "chicken_poultry", "dairy", "eggs"), 
                                "animal_products", 
                                ifelse(model_group == "fish_seafood", 
                                   "fish_seafood", 
                                "plant_products")), 
                crop_class = "food")

feed_grouped_data <- feed_world %>% 
  dplyr::mutate(source_group = ifelse(model_group %in% c("beef_lamb_pork", "chicken_poultry", "dairy", "eggs"), 
                                "animal_products", 
                                ifelse(model_group == "fish_seafood", 
                                   "fish_seafood", 
                                "plant_products")), 
                crop_class = "feed")

```

```{r}
food_feed_grouped_data <- food_grouped_data %>% 
  dplyr::bind_rows(feed_grouped_data)
```

Visualise total annual global food and feed supply.
```{r}
p1 <- ggplot(food_feed_grouped_data, 
       aes(x = year, 
           y = tonnes_yr*1e-9)) + 
  geom_col(aes(fill = crop_class), position = "stack", alpha = 0.8) + 
  geom_hline(yintercept = 0, alpha = 0.9) + 
  theme_minimal() + 
  theme(
    legend.position = "top", 
    legend.title = element_blank(), 
    axis.title.x = element_blank()
  ) + 
  labs(
    title = "Global production of agricultural food and feed", 
    y = "Gt/year", 
    caption = "Data: FAOSTAT FBS (2018)"
  )

p1
```

How does this compare to demand in future?
```{r}
population <- foodbalance_df %>% 
  dplyr::filter(element_code %in% c(511)) %>% 
  dplyr::filter(area == "World") %>% 
  dplyr::select(area, year, value) %>% 
  dplyr::rename(thousand_persons = value)
foodsupply <- foodbalance_df %>% 
  dplyr::filter(element_code %in% c(664)) %>%
  dplyr::left_join(foodbalance_map,
                   by = c("item_code", "item")) %>% 
  tidyr::drop_na() %>% 
  dplyr::mutate(food_source = ifelse(model_group %in% c("beef_lamb_pork", "meat_poultry", "chicken_poultry", "dairy", "eggs"), 
                                "animal_products", 
                                ifelse(model_group == "fish_seafood", 
                                   "fish_seafood", 
                                "plant_products"))) %>% 
  dplyr::filter(area == "World") %>% 
  dplyr::group_by(area, year, unit, food_source) %>% 
  dplyr::summarise(kcal_cap_day = sum(value), 
                   .groups = "drop")

fao_kcal_df <- population %>% 
  dplyr::full_join(foodsupply) %>% 
  dplyr::mutate(M_kcal_per_day = kcal_cap_day*thousand_persons * 1e-3, 
         diet_plan = "FAO", 
         SCENARIO = "FAO") %>% 
  dplyr::select(SCENARIO, diet_plan, year, food_source, M_kcal_per_day)

fao_kcal_diff <- fao_kcal_df %>% 
  dplyr::full_join(all_plans_long %>% 
  dplyr::filter(year >= 2020)) %>% 
  dplyr::mutate(M_kcal_per_day_2018 = ifelse(year == 2018, M_kcal_per_day, NA)) %>% 
  dplyr::group_by(food_source) %>% 
  tidyr::fill(M_kcal_per_day_2018) %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(year >= 2018) %>% 
  dplyr::mutate(diff = M_kcal_per_day - M_kcal_per_day_2018, 
                pc_diff = diff/M_kcal_per_day_2018)

fao_kcal_diff <- fao_kcal_diff %>% 
  dplyr::mutate(diet_plan_f = diet_plan)
fao_kcal_diff$diet_plan_f <- factor(fao_kcal_diff$diet_plan_f, levels = c("ELA-PHD", "CNS-CFP", "FDA-SDP"))

fao_kcal_diff
```

```{r}
cols <-
  c(
    "animal_products" = "#F17EB8",
    # "dairy" = "#DED560",
    "fish_seafood" = "#489ED3",
    "plant_products" = "#EEAF35"
  )
xlabz <- c("ELA-PHD", "CNS-CFP", "FDA-SDP")
labz <-
  c("Animal Products", "Fish and Seafood", "Plant Products")

ymin <- min(fao_kcal_diff$pc_diff)
ymax <- max(fao_kcal_diff$pc_diff)


p2a <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP1_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "dodge") + 
   scale_fill_manual(
    values = cols,
    labels = labz
  ) +
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.title = element_blank(), 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP1", y = "Relative to 2018 supply") +
  facet_wrap( ~ year)

p2_legend_only <- cowplot::get_legend(p2a)

p2a <- p2a +
  theme(legend.position = "none")

p2b <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP2_v9_130115"),
   aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(
    values = cols,
    labels = labz
  ) +
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP2") +
  facet_wrap( ~ year)

p2c <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP3_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(
    values = cols,
    labels = labz
  ) +
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP3") +
  facet_wrap( ~ year)

p2d <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP4d_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(
    values = cols,
    labels = labz
  ) +
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP4", y = "Relative to 2018 supply") +
  facet_wrap( ~ year)

p2e <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP5_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(
    values = cols,
    labels = labz
  ) +
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP5") +
  facet_wrap( ~ year)
```


```{r}

p2 <- cowplot::plot_grid(p2a, p2b, p2c, p2d, p2e, p2_legend_only)
p2
```

```{r}

ymin <- -5
ymax <- 6

p3a <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP1_v9_130115"),
  aes(x = diet_plan_f,
      y = diff * 1e-6)
) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "stack") + 
   scale_fill_manual(
    values = cols,
    labels = labz
  ) +
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.title = element_blank(), 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP1", y = "Tkcal/day over 2018 supply") +
  facet_wrap( ~ year)

p3_legend_only <- cowplot::get_legend(p3a)

p3a <- p3a +
  theme(legend.position = "none")

p3b <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP2_v9_130115"),
   aes(x = diet_plan_f,
      y = diff * 1e-6)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "stack") + 
  scale_fill_manual(
    values = cols,
    labels = labz
  ) +
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP2") +
  facet_wrap( ~ year)

p3c <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP3_v9_130115"),
  aes(x = diet_plan_f,
      y = diff * 1e-6)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "stack") + 
  scale_fill_manual(
    values = cols,
    labels = labz
  ) +
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP3") +
  facet_wrap( ~ year)

p3d <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP4d_v9_130115"),
  aes(x = diet_plan_f,
      y = diff * 1e-6)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "stack") + 
  scale_fill_manual(
    values = cols,
    labels = labz
  ) +
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP4", y = "Tkcal/day over 2018 supply") +
  facet_wrap( ~ year)

p3e <- ggplot(
  fao_kcal_diff %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP5_v9_130115"),
  aes(x = diet_plan_f,
      y = diff * 1e-6)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = food_source), alpha = 0.8, position = "stack") + 
  scale_fill_manual(
    values = cols,
    labels = labz
  ) +
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP5") +
  facet_wrap( ~ year)
```


```{r}

p3 <- cowplot::plot_grid(p3a, p3b, p3c, p3d, p3e, p3_legend_only)
p3
```

```{r}
tmp1 <- food_feed_grouped_data %>% 
  dplyr::group_by(area, year, crop_class) %>% 
  dplyr::summarise(tonnes_yr = sum(tonnes_yr, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::mutate(SCENARIO = "FAO", 
                diet_plan_f = factor("FAO")) %>% 
  dplyr::select(SCENARIO, year, diet_plan_f, crop_class, tonnes_yr)
tmp2 <- global_crop_demand_food_feed_diff %>% 
  dplyr::select(SCENARIO, year, diet_plan_f, crop_class, tonnes_yr) %>% 
  dplyr::filter(year >= 2020)

tmp3 <- full_join(tmp1, tmp2)

ggplot(tmp1,  
      aes(x = year, y = tonnes_yr)) + 
  geom_col(aes(fill = crop_class), position = "stack") + 
  coord_cartesian(ylim = c(0, 1.2e10))

ggplot(tmp2 %>% 
        dplyr::filter(diet_plan_f == "ELA-PHD", SCENARIO == "SSP3_v9_130115"), 
      aes(x = year, y = tonnes_yr)) + 
  geom_col(aes(fill = crop_class), position = "stack") + 
  coord_cartesian(ylim = c(0, 1.2e10))

ggplot(tmp3 %>% 
         dplyr::filter(diet_plan_f %in% c("FAO", "FDA-SDP"), SCENARIO == "SSP3_v9_130115"), 
       aes(x = year, y = tonnes_yr)) + 
  geom_col(aes(fill = crop_class), position = "stack") + 
  coord_cartesian(xlim = c(2014, 2100))
```

```{r}
diet_diffs <- tmp3 %>% 
  dplyr::mutate(tonnes_yr_2018 = ifelse(year == 2018, tonnes_yr, NA)) %>% 
  dplyr::group_by(crop_class) %>% 
  tidyr::fill(tonnes_yr_2018) %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(year >= 2018) %>% 
  dplyr::mutate(diff = tonnes_yr - tonnes_yr_2018, 
                pc_diff = diff/tonnes_yr_2018)
```


```{r}
diet_diffs
```


```{r}
cols <- data.frame(
  food = "#EEAF35", 
  feed = "#F17EB8"
)
labz <- c("food", "feed")

# ymax <- (max(global_crop_demand_food_feed_diff$diff) + 0.05 * max(global_crop_demand_food_feed_diff$diff)) * 1e-9
# ymin <- 0

ymax <- 0.75
ymin <- -0.55 


p2a <- ggplot(
  diet_diffs %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP1_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  #  scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.title = element_blank(), 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP1", y = "Relative to 2018 demand") +
  facet_wrap( ~ year)

p2_legend_only <- cowplot::get_legend(p2a)

p2a <- p2a +
  theme(legend.position = "none")

p2b <- ggplot(
  diet_diffs %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP2_v9_130115"),
   aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  # scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP2") +
  facet_wrap( ~ year)

p2c <- ggplot(
  diet_diffs %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP3_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  # scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP3") +
  facet_wrap( ~ year)

p2d <- ggplot(
  diet_diffs %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP4d_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  # scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP4", y = "Relative to 2018 demand") +
  facet_wrap( ~ year)

p2e <- ggplot(
  diet_diffs %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP5_v9_130115"),
  aes(x = diet_plan_f,
      y = pc_diff)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8, position = "dodge") + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  # scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP5") +
  facet_wrap( ~ year)
```


```{r}

p2 <- cowplot::plot_grid(p2a, p2b, p2c, p2d, p2e, p2_legend_only)
p2
```

```{r}
cols <- data.frame(
  food = "#EEAF35", 
  feed = "#F17EB8"
)
labz <- c("food", "feed")

# ymax <- (max(global_crop_demand_food_feed_diff$diff) + 0.05 * max(global_crop_demand_food_feed_diff$diff)) * 1e-9
# ymin <- 0

ymax <- 3.5
ymin <- -3 


p3a <- ggplot(
  diet_diffs %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP1_v9_130115"),
  aes(x = diet_plan_f,
      y = diff * 1e-9)
) + 
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8, position = "stack") + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  #  scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.title = element_blank(), 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP1", y = "Gt over 2018 demand") +
  facet_wrap( ~ year)

p3_legend_only <- cowplot::get_legend(p3a)

p3a <- p3a +
  theme(legend.position = "none")

p3b <- ggplot(
  diet_diffs %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP2_v9_130115"),
   aes(x = diet_plan_f,
      y = diff * 1e-9)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8, position = "stack") + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  # scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP2") +
  facet_wrap( ~ year)

p3c <- ggplot(
  diet_diffs %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP3_v9_130115"),
  aes(x = diet_plan_f,
      y = diff * 1e-9)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8, position = "stack") + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  # scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP3") +
  facet_wrap( ~ year)

p3d <- ggplot(
  diet_diffs %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP4d_v9_130115"),
  aes(x = diet_plan_f,
      y = diff * 1e-9)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8, position = "stack") + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  # scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_text(size = 7)
  ) +
  labs(title = "SSP4", y = "Gt over 2018 demand") +
  facet_wrap( ~ year)

p3e <- ggplot(
  diet_diffs %>%
    dplyr::filter(year %in% c(2025, 2050, 2075) &
                    SCENARIO == "SSP5_v9_130115"),
  aes(x = diet_plan_f,
      y = diff * 1e-9)
) +
  geom_hline(yintercept = 0, alpha = 0.8) +
  geom_col(aes(fill = crop_class), alpha = 0.8, position = "stack") + 
  scale_fill_manual(labels = c("feed for animals", "food for humans"), values = c(muted("magenta"), muted("green"))) + 
  # scale_fill_manual(
  #   values = cols,
  #   labels = labz
  # ) + 
  coord_cartesian(ylim = c(ymin, ymax)) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5
    ),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none", 
    panel.grid.major.y = element_line(colour = "grey"), 
    panel.grid.minor.y = element_line(colour = "grey"), 
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  labs(title = "SSP5") +
  facet_wrap( ~ year)
```


```{r}

p3 <- cowplot::plot_grid(p3a, p3b, p3c, p3d, p3e, p3_legend_only)
p3
```

Return to the projections computed earlier. Recall: the projections were based on a bottom-up calculation of food and feed weight based on caloric demands for healthy diets, under the five SSPs and three diet plans.
```{r}
# save(food_feed_grouped_data, file = paste0(data_path, "food_feed_grouped_data.R"))
load(file = paste0(data_path, "food_feed_grouped_data.R")) #food_feed_grouped_data

```

Merge the data with the projections computed earlier.
```{r}
food_feed_data_scenario <- food_feed_grouped_data %>% 
  dplyr::mutate(SCENARIO = "FAOSTAT", 
                diet_plan = "FAO-FBdata") %>% 
  dplyr::group_by(SCENARIO, diet_plan, year, crop_class) %>% 
  dplyr::summarise(tonnes_yr = sum(tonnes_yr, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::bind_rows(
    global_crop_demand_food_feed %>%
  dplyr::select(-tonnes_day)
  )

```

To test the skill of the bottom-up calculation, compare to the food balance data. I run a short check of the data with a visualisation below.
```{r}
compare <- global_crop_demand_food_feed %>% 
  dplyr::select(-tonnes_day) %>% 
  dplyr::bind_rows(food_grouped_data %>% 
  group_by(year) %>% 
  dplyr::summarise(tonnes_yr = sum(tonnes_yr, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::mutate(diet_plan = "FAO-FB", 
                crop_class = "food", 
                SCENARIO = "FAO_FoodBalance_data") %>% 
  dplyr::select(SCENARIO, diet_plan, year, crop_class, tonnes_yr))


```

The plotted points appear roughly in line with the healthy "US-style" diet from the FDA.
```{r}

p2 <- ggplot(data = food_feed_data_scenario %>% 
         dplyr::filter(SCENARIO != "FAOSTAT", 
                       crop_class == "food"), 
       aes(x = year, 
           y = tonnes_yr)) + 
  geom_line(aes(colour = diet_plan)) + 
  geom_point(data = food_feed_data_scenario %>% 
         dplyr::filter(SCENARIO == "FAOSTAT", 
                       crop_class == "food") %>% 
           dplyr::select(-SCENARIO), 
         aes(x = year, 
             y = tonnes_yr), 
         size = 0.5, 
         shape = 3) + 
  facet_wrap(~SCENARIO)

p2

```

Transform diets by 2050 and by 2075, for each SSP.

Transform by 2050. Interpolate lowest acceleration pathway for each food/feed type to its target value.

1. Linearly extrapolate data values from 2014-18 to 2022.
2. Find the lowest-energy trajectory from 2022 to the target year, 2050 or 2075. The lowest energy should have the constraints: (i) lowest second derivative wrt time; (ii) first derivative that equals the slope of the line at 2022; (iii) passes through the appropriate values at 2022 and 2050. A spline should be appropriate.

Recode country names and merge with regions.
```{r}
Food_countries <- food_countries %>% 
  dplyr::rename(fao_countrycode = area_code) %>% 
  dplyr::select(-area) %>% 
  dplyr::left_join(loc_map_reduced, by = "fao_countrycode")

Feed_countries <- feed_countries %>% 
  dplyr::rename(fao_countrycode = area_code) %>% 
  dplyr::select(-area) %>% 
  dplyr::left_join(loc_map_reduced, by = "fao_countrycode")
```

Do some cleanup first because some ISOa3 codes are not included.
```{r}
food_2014_2018_data <- Food_countries %>%
  dplyr::select(year, model_group, tonnes_yr, iso_alpha3) %>%
  tidyr::drop_na()

feed_2014_2018_data <- Feed_countries %>%
  dplyr::select(year, model_group, tonnes_yr, iso_alpha3) %>%
  tidyr::drop_na()
```

Fit linear models to data and predict to extrapolate to 2022. NB: In some cases, the fitter projects negative production values. These are zeroed out.
```{r}
yrs <- data.frame(year = seq(2019, 2022, by = 1))

food_2019_2022_lm <- food_2014_2018_data %>%
  dplyr::group_by(iso_alpha3, model_group) %>%
  tidyr::nest() %>%
  dplyr::mutate(models = lapply(data, function(df)
    lm(tonnes_yr ~ year, data = df))) %>%
  dplyr::mutate(lm_pred = map(models, ~ predict(., yrs))) %>%
  # dplyr::mutate(lm_pred = map(models, ~predict(., yrs))) %>%
  dplyr::ungroup() %>%
  tidyr::unnest(cols = c(lm_pred)) %>%
  dplyr::select(iso_alpha3, model_group, lm_pred) %>%
  dplyr::mutate(year = rep(seq(2019, 2022, by = 1), 2212)) %>%
  dplyr::rename(tonnes_yr = lm_pred) %>%
  dplyr::mutate(tonnes_yr = ifelse(tonnes_yr < 0, 0, tonnes_yr))
 
```

Do something similar for feed: mean values are fine -- the fitter is throwing rank-deficient fit warnings from some instances.
```{r}
# feed_2019_2022_lm <- feed_2014_2018_data %>%
#   dplyr::group_by(iso_alpha3, model_group) %>%
#   tidyr::nest() %>%
#   dplyr::mutate(models = lapply(data, function(df) lm(tonnes_yr ~ year, data = df))) %>% 
#   dplyr::mutate(lm_pred = map(models, ~predict(., yrs))) %>% 
#   # dplyr::mutate(lm_pred = map(models, ~predict(., yrs))) %>%
#   dplyr::ungroup() %>% 
#   tidyr::unnest(cols = c(lm_pred)) %>% 
#   dplyr::select(iso_alpha3, model_group, lm_pred) %>% 
#   dplyr::mutate(year = rep(seq(2019, 2022, by = 1), 1343)) %>% 
#   dplyr::rename(tonnes_yr = lm_pred)

feed_2019_2022_lm <- feed_2014_2018_data %>% 
  dplyr::group_by(iso_alpha3, model_group) %>% 
  dplyr::summarise(tonnes_yr = mean(tonnes_yr, na.rm = TRUE), 
                   .groups = "drop")
```


```{r}
food_2014_2022_est <- food_2014_2018_data %>% 
  bind_rows(food_2019_2022_lm)

feed_2014_2022_est <- feed_2014_2018_data %>% 
  bind_rows(feed_2019_2022_lm)
```

Use crop weight of food and crop ingredient weight of feed from earlier. We will only use the data for years 2023 and after.
```{r}
# save(food_weight, file = paste0(data_path, "food_weight.R"))
load(file = paste0(data_path, "food_weight.R")) #food_weight

# save(feed_ingredient_demand_summary, file = paste0(data_path, "feed_ingredient_demand_summary.R"))
load(file = paste0(data_path, "feed_ingredient_demand_summary.R")) #feed_ingredient_demand_summary

```


```{r}
food_proj <- food_weight %>%
  dplyr::mutate(tonnes_yr = tonnes_day_food * 365) %>%
  dplyr::select(SCENARIO,
                iso_alpha3,
                subregionname,
                diet_plan,
                year,
                model_group,
                tonnes_yr) %>%
  dplyr::bind_rows(
    live_food_weight %>%
      dplyr::mutate(tonnes_yr = tonnes_day_food * 365) %>%
      dplyr::select(
        SCENARIO,
        iso_alpha3,
        subregionname,
        diet_plan,
        year,
        model_group,
        tonnes_yr
      )
  ) %>%
  dplyr::mutate(scenario = ifelse(
    SCENARIO == "SSP1_v9_130115",
    "SSP1",
    ifelse(
      SCENARIO == "SSP2_v9_130115",
      "SSP2",
      ifelse(
        SCENARIO == "SSP3_v9_130115",
        "SSP3",
        ifelse(SCENARIO == "SSP4d_v9_130115",
               "SSP4",
               "SSP5")
      )
    )
  )) %>% 
  dplyr::select(-SCENARIO) %>% 
  dplyr::filter(year > 2022)

feed_proj <- feed_ingredient_demand_summary %>% 
  dplyr::mutate(tonnes_yr = tonnes_day*365) %>% 
  dplyr::select(-tonnes_day) %>%
  dplyr::mutate(scenario = ifelse(
    SCENARIO == "SSP1_v9_130115",
    "SSP1",
    ifelse(
      SCENARIO == "SSP2_v9_130115",
      "SSP2",
      ifelse(
        SCENARIO == "SSP3_v9_130115",
        "SSP3",
        ifelse(SCENARIO == "SSP4d_v9_130115",
               "SSP4",
               "SSP5")
      )
    )
  )) %>% 
  dplyr::select(-SCENARIO) %>% 
  dplyr::filter(year > 2022)

# food_proj
# feed_proj
```

Set a target year
```{r}
netzero_target_year <- 2050
```


Confirm continuity between ISO codes so countries represented in 2022 are there in 2023, etc. Fill dummy values in for scenario and diet_plan for the FAO data. These are required for continuity in the spline fitter.

### For food pathways
```{r}
years_tmp <- food_2014_2022_est %>% distinct(year) %>% pull(year)
countries_tmp <- food_2014_2022_est %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
model_groups_tmp <- food_2014_2022_est %>% distinct(model_group) %>% pull(model_group)
diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")


empty_set <- expand.grid(years_tmp, countries_tmp, model_groups_tmp, diet_plans_tmp, scenarios_tmp)
names(empty_set) <- c("year", "iso_alpha3", "model_group", "diet_plan", "scenario")

```

```{r}
food_2014_2022_est_tmp <- food_2014_2022_est %>%
  full_join(empty_set, by = c("year", "model_group", "iso_alpha3")) %>%
  mutate(tonnes_yr = ifelse(is.na(tonnes_yr), 0, tonnes_yr))

```

Do the same for `pathways` data frame representing values between 2023 and the target year to be filled by the spline values.
```{r}
years_tmp <- seq(2023, netzero_target_year - 1, by = 1)
countries_tmp <- food_2014_2022_est %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
model_groups_tmp <- food_2014_2022_est %>% distinct(model_group) %>% pull(model_group)
diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")
tonnes_yr_tmp <- NA

pathways_tmp <- expand.grid(years_tmp, countries_tmp, model_groups_tmp, diet_plans_tmp, scenarios_tmp, tonnes_yr_tmp)
names(pathways_tmp) <- c("year", "iso_alpha3", "model_group", "diet_plan", "scenario", "tonnes_yr")
```

Merge the FAO-derived data with the empty pathways data frame.
```{r}
food_data_pathways <- food_2014_2022_est_tmp %>% 
  full_join(pathways_tmp, by = c("year", "model_group", "tonnes_yr", "iso_alpha3", "diet_plan", "scenario"))

head(food_data_pathways)
```

And the same for `food_targets`, the data frame for values at and above the target year.
```{r}
years_tmp <- seq(netzero_target_year, 2080, by = 5)
countries_tmp <- food_2014_2022_est %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
model_groups_tmp <- food_2014_2022_est %>% distinct(model_group) %>% pull(model_group)
diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")
tonnes_yr_tmp <- NA

targets_tmp <- expand.grid(years_tmp, countries_tmp, model_groups_tmp, diet_plans_tmp, scenarios_tmp, tonnes_yr_tmp)
names(targets_tmp) <- c("year", "iso_alpha3", "model_group", "diet_plan", "scenario", "tonnes_yr")
```

```{r}
food_targets <- food_proj %>% 
  dplyr::filter(year >= netzero_target_year, year <= 2080) %>% 
  dplyr::full_join(targets_tmp, by = c("iso_alpha3", "diet_plan", "year", "model_group", "tonnes_yr", "scenario")) %>% 
  dplyr::mutate(tonnes_yr = ifelse(is.na(tonnes_yr), 0, tonnes_yr)) %>% 
  dplyr::filter(!is.na(subregionname)) %>% 
  dplyr::select(-subregionname)
  
head(food_targets)
```

Confirm that all countries represented in `data_pathways` are represented in `targets`. For the spline interpolation to work, there must be tie points for all countries, diet_plans, and scenarios at 2022 and the `netzero_target_year`.
```{r}
data_countries <- food_data_pathways %>% dplyr::distinct(iso_alpha3) %>% dplyr::pull(iso_alpha3)
targ_countries <- food_targets %>% dplyr::distinct(iso_alpha3) %>% dplyr::pull(iso_alpha3)

shared_countries <- intersect(data_countries, targ_countries)

food_2014_2022_est_clean <- food_data_pathways %>% 
  dplyr::filter(iso_alpha3 %in% shared_countries)
food_targets_clean <- food_targets %>% 
  dplyr::filter(iso_alpha3 %in% shared_countries)

```

Merge the time series together into a `harmonized_food_data_targets` data frame to run the interpolation on.
```{r}

harmonized_food_data_targets <- food_2014_2022_est_clean %>%
  dplyr::full_join(food_targets_clean, by = c("year", "model_group", "tonnes_yr", "iso_alpha3", "diet_plan", "scenario")) %>% 
  dplyr::arrange(year)

```

Interpolate transformation pathways between the FAO food balance data (and linearly interpolated values to 2022 based on the FAO data) and target year values using a spline with all values as tie-points.
```{r}

food_pathways_tmp <- harmonized_food_data_targets %>%
  group_by(model_group, scenario, diet_plan, iso_alpha3) %>%
  mutate(tonnes_yr_interp = spline(
    x = year,
    y = tonnes_yr,
    xout = year,
    ties = "ordered"
  )$y,) %>%
  ungroup()

food_pathways <- food_pathways_tmp %>%
  dplyr::select(-tonnes_yr) %>%
  dplyr::rename(tonnes_yr = tonnes_yr_interp)

```

### For feed
```{r}
years_tmp <- feed_2014_2022_est %>% distinct(year) %>% pull(year)
countries_tmp <- feed_2014_2022_est %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
model_groups_tmp <- feed_2014_2022_est %>% distinct(model_group) %>% pull(model_group)
diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")


empty_set <- expand.grid(years_tmp, countries_tmp, model_groups_tmp, diet_plans_tmp, scenarios_tmp)
names(empty_set) <- c("year", "iso_alpha3", "model_group", "diet_plan", "scenario")

```

```{r}
feed_2014_2022_est_tmp <- feed_2014_2022_est %>%
  full_join(empty_set, by = c("year", "model_group", "iso_alpha3")) %>%
  mutate(tonnes_yr = ifelse(is.na(tonnes_yr), 0, tonnes_yr))

```

Do the same for `feed_pathways` data frame representing values between 2023 and the target year to be filled by the spline values.
```{r}
years_tmp <- seq(2023, netzero_target_year - 1, by = 1)
countries_tmp <- feed_2014_2022_est %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
model_groups_tmp <- feed_2014_2022_est %>% distinct(model_group) %>% pull(model_group)
diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")
tonnes_yr_tmp <- NA

pathways_tmp <- expand.grid(years_tmp, countries_tmp, model_groups_tmp, diet_plans_tmp, scenarios_tmp, tonnes_yr_tmp)
names(pathways_tmp) <- c("year", "iso_alpha3", "model_group", "diet_plan", "scenario", "tonnes_yr")
```

Merge the FAO-derived data with the empty pathways data frame.
```{r}
feed_data_pathways <- feed_2014_2022_est_tmp %>% 
  full_join(pathways_tmp, by = c("year", "model_group", "tonnes_yr", "iso_alpha3", "diet_plan", "scenario"))

head(feed_data_pathways)
```

And the same for `feed_targets`, the data frame for values at and above the target year.
```{r}
years_tmp <- seq(netzero_target_year, 2080, by = 5)
countries_tmp <- feed_2014_2022_est %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
model_groups_tmp <- feed_2014_2022_est %>% distinct(model_group) %>% pull(model_group)
diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")
tonnes_yr_tmp <- NA

targets_tmp <- expand.grid(years_tmp, countries_tmp, model_groups_tmp, diet_plans_tmp, scenarios_tmp, tonnes_yr_tmp)
names(targets_tmp) <- c("year", "iso_alpha3", "model_group", "diet_plan", "scenario", "tonnes_yr")
```

```{r}
feed_targets <- feed_proj %>% 
  dplyr::filter(year >= netzero_target_year, year <= 2080) %>% 
  dplyr::full_join(targets_tmp, by = c("iso_alpha3", "diet_plan", "year", "model_group", "tonnes_yr", "scenario")) %>% 
  dplyr::mutate(tonnes_yr = ifelse(is.na(tonnes_yr), 0, tonnes_yr)) %>% 
  dplyr::filter(!is.na(subregionname)) %>% 
  dplyr::select(-subregionname)
  
head(feed_targets)
```


Confirm that all countries represented in `data_pathways` are represented in `targets`. For the spline interpolation to work, there must be tie points for all countries, diet_plans, and scenarios at 2022 and 2050.
```{r}
data_countries <- feed_data_pathways %>% dplyr::distinct(iso_alpha3) %>% dplyr::pull(iso_alpha3)
targ_countries <- feed_targets %>% dplyr::distinct(iso_alpha3) %>% dplyr::pull(iso_alpha3)

shared_countries <- intersect(data_countries, targ_countries)

feed_2014_2022_est_clean <- feed_data_pathways %>% 
  dplyr::filter(iso_alpha3 %in% shared_countries)
feed_targets_clean <- feed_targets %>% 
  dplyr::filter(iso_alpha3 %in% shared_countries)

```

Merge into harmonized data frame.
```{r}

harmonized_feed_data_targets <- feed_2014_2022_est_clean %>%
  dplyr::full_join(feed_targets_clean, by = c("year", "model_group", "tonnes_yr", "iso_alpha3", "diet_plan", "scenario")) %>% 
  dplyr::arrange(year)

```

Interpolate transformation pathways between the FAO food balance data (and linearly interpolated values to 2022 based on the FAO data) and target year values using a spline with all values as tie-points.
```{r}

feed_pathways_tmp <- harmonized_feed_data_targets %>%
  group_by(model_group, scenario, diet_plan, iso_alpha3) %>%
  mutate(tonnes_yr_interp = spline(
    x = year,
    y = tonnes_yr,
    xout = year,
    ties = "ordered"
  )$y,) %>%
  ungroup()

feed_pathways <- feed_pathways_tmp %>%
  dplyr::select(-tonnes_yr) %>%
  dplyr::rename(tonnes_yr = tonnes_yr_interp)

```

## Visualization

```{r}
ggplot(feed_pathways %>% 
         dplyr::filter(iso_alpha3 == "CHN"), 
       aes(x = year, 
           y = 1e-6*tonnes_yr)) + 
  geom_line(aes(colour = model_group)) + 
  theme_minimal() + 
  labs(
    y = "Mt/yr"
  ) + 
  facet_wrap(~diet_plan) + 
  coord_cartesian(ylim = c(0, 10))
```


To visualise these data, I will aggregate food types into animal products, plant products and fish-seafood.
```{r}
food_pathways_agg <- food_pathways %>% 
  dplyr::mutate(food_group = ifelse(model_group %in% c("beef_lamb_pork", "chicken_poultry", "dairy", "eggs"), 
                                    "animal products", 
                                    ifelse(model_group %in% c("fish_seafood"), 
                                           "fish & seafood", 
                                           "plant products"))) %>% 
  dplyr::group_by(year, iso_alpha3, diet_plan, scenario, food_group) %>% 
  dplyr::summarise(tonnes_yr = sum(tonnes_yr, na.rm = "TRUE"), 
                   .groups = "drop")
```

```{r}

cols <-
  c(
    "animal products" = "#F17EB8",
    # "dairy" = "#DED560",
    "fish & seafood" = "#489ED3",
    "plant products" = "#EEAF35"
  )
xlabz <- c("CHN-CFP", "ELA-PHD", "USA-FDA")
labz <-
  c("Animal Products", "Fish and Seafood", "Plant Products")

p3 <- ggplot(food_pathways_agg %>% 
         filter(iso_alpha3 == "IND", 
                diet_plan == "ELA-PHD"), aes(x = year)) +
                      # diet_plan == "ELA-PHD"), aes(x = year)) + 
  geom_hline(yintercept = 0, alpha = 0.8) + 
  geom_area(aes(y = 1e-9*tonnes_yr, 
                fill = food_group), 
            alpha = 0.8) + 
  geom_vline(xintercept = netzero_target_year, alpha = 0.5, size = 1.5) + 
   scale_fill_manual(
    values = cols
    # ,
    # labels = labz
  ) +
  theme_minimal() + 
  theme(
    legend.position = "top", 
    legend.title = element_blank(), 
    axis.text.x = element_text(angle = 90, vjust = 0.55, hjust = 0.9)
  ) + 
  labs(
    x = "year", 
    y = "Gt"
  ) + 
  facet_grid(~scenario)


# p3_legend_only <- cowplot::get_legend(p3)
# 
# p3 <- p3 +
#   theme(legend.position = "none")
# 
# plot_grid(p3, p3_legend_only)
p3

```


