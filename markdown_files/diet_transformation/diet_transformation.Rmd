---
title: "Diet Transformation"
author: "Marcus J Thomson"
date: "10/7/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyr)
library(dplyr)
library(purrr)
library(ggplot2)
library(cowplot)
```

# Dietary Transformation Pathways

Here I calculate pathway trajectories from the present food/feed supply patterns to hypothetical future patterns based on demands from the projections calculated in `iep_healthy_food.Rmd`.

```{r}
data_path <- "/home/thomson/Projects/iep_food/data/"
```

## FAO Food Balance Data

Read in Food Balance data from FAOSTAT. Source: [FAOSTAT.](http://www.fao.org/faostat/en/#data/FBS)

```{r}
foodbalance_df <- readr::read_csv(
  file = paste0(data_path, "FoodBalanceSheets_E_All_Data_(Normalized).csv"),
  col_types = cols(
    `Area Code` = col_double(),
    Area = col_character(),
    `Item Code` = col_double(),
    Item = col_character(),
    `Element Code` = col_double(),
    Element = col_character(),
    `Year Code` = col_double(),
    Year = col_double(),
    Unit = col_character(),
    Value = col_double(),
    Flag = col_character()
  )) %>% 
  rename(
    "area_code" = "Area Code",
    "area" = "Area",
    "item_code" = "Item Code",
    "item" = "Item",
    "element_code" = "Element Code",
    "element" = "Element",
    "year_code" = "Year Code",
    "year" = "Year",
    "unit" = "Unit",
    "value" = "Value",
    "flag" = "Flag"
  )
  
```

I made a separate CSV file to map the FAO elements/element codes onto the model_groups I use for this analysis.
```{r}
foodbalance_map <- readr::read_csv(
  file = paste0(data_path, "Daily Energy Requirements for Humans - food_map.csv"),
  col_types = cols(
    item_code = col_double(),
    item = col_character(),
    model_group1 = col_character(),
    model_group = col_character()
  )
)
```

Select only those elements that have to do with food and food supply.
```{r}

food_elements <- data.frame(
  element <- c("Food", "Food supply"),
  units <- c("1000 t/yr", "kcal/cap/yr"),
  element_code <- c(5142, 664)
)

```


```{r}
food_df <- foodbalance_df %>%
  dplyr::filter(element_code %in% c(5142)) %>%
  dplyr::left_join(foodbalance_map,
                   by = c("item_code", "item")) %>% 
  tidyr::drop_na()

feed_df <- foodbalance_df %>%
  dplyr::filter(element_code %in% c(5521)) %>%
  dplyr::left_join(foodbalance_map,
                   by = c("item_code", "item")) %>% 
  tidyr::drop_na()

```

Aggregate tonnes of food/feed by model_group.
```{r}

food_countries <- food_df %>% 
  dplyr::group_by(area_code, area, year, model_group) %>% 
  dplyr::summarise(tonnes_yr = 1e3*sum(value, na.rm = TRUE), 
                   .groups = "drop")

feed_countries <- feed_df %>% 
  dplyr::group_by(area_code, area, year, model_group) %>% 
  dplyr::summarise(tonnes_yr = 1e3*sum(value, na.rm = TRUE), 
                   .groups = "drop")

```

Let's have a look at world production of food and feed. 
```{r}

food_world <- food_countries %>% 
  dplyr::filter(area == "World") 
feed_world <- feed_countries %>% 
  dplyr::filter(area == "World") 

food_grouped_data <- food_world %>% 
  dplyr::mutate(source_group = ifelse(model_group %in% c("beef_lamb_pork", "meat_poultry", "chicken_poultry", "dairy", "eggs"), 
                                "animal_products", 
                                ifelse(model_group == "fish_seafood", 
                                   "fish_seafood", 
                                "plant_products")), 
                crop_class = "food")

feed_grouped_data <- feed_world %>% 
  dplyr::mutate(source_group = ifelse(model_group %in% c("beef_lamb_pork", "chicken_poultry", "dairy", "eggs"), 
                                "animal_products", 
                                ifelse(model_group == "fish_seafood", 
                                   "fish_seafood", 
                                "plant_products")), 
                crop_class = "feed")

```

```{r}
food_feed_grouped_data <- food_grouped_data %>% 
  dplyr::bind_rows(feed_grouped_data)
```

Visualise total annual global food and feed supply.
```{r}
p1 <- ggplot(food_feed_grouped_data, 
       aes(x = year, 
           y = tonnes_yr*1e-9)) + 
  geom_col(aes(fill = crop_class), position = "stack", alpha = 0.8) + 
  geom_hline(yintercept = 0, alpha = 0.9) + 
  theme_minimal() + 
  theme(
    legend.position = "top", 
    legend.title = element_blank(), 
    axis.title.x = element_blank()
  ) + 
  labs(
    title = "Global production of agricultural food and feed", 
    y = "Gt/year", 
    caption = "Data: FAOSTAT FBS (2018)"
  )

p1
```

Return to the projections computed earlier. Recall: the projections were based on a bottom-up calculation of food and feed weight based on caloric demands for healthy diets, under the five SSPs and three diet plans.
```{r}
# save(food_feed_grouped_data, file = paste0(data_path, "food_feed_grouped_data.R"))
load(file = paste0(data_path, "food_feed_grouped_data.R")) #food_feed_grouped_data

```

Merge the data with the projections computed earlier.
```{r}
food_feed_data_scenario <- food_feed_grouped_data %>% 
  dplyr::mutate(SCENARIO = "FAOSTAT", 
                diet_plan = "FAO-FBdata") %>% 
  dplyr::group_by(SCENARIO, diet_plan, year, crop_class) %>% 
  dplyr::summarise(tonnes_yr = sum(tonnes_yr, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::bind_rows(
    global_crop_demand_food_feed %>%
  dplyr::select(-tonnes_day)
  )

```

To test the skill of the bottom-up calculation, compare to the food balance data. I run a short check of the data with a visualisation below.
```{r}
compare <- global_crop_demand_food_feed %>% 
  dplyr::select(-tonnes_day) %>% 
  dplyr::bind_rows(food_grouped_data %>% 
  group_by(year) %>% 
  dplyr::summarise(tonnes_yr = sum(tonnes_yr, na.rm = TRUE), 
                   .groups = "drop") %>% 
  dplyr::mutate(diet_plan = "FAO-FB", 
                crop_class = "food", 
                SCENARIO = "FAO_FoodBalance_data") %>% 
  dplyr::select(SCENARIO, diet_plan, year, crop_class, tonnes_yr))


```

The plotted points appear roughly in line with the healthy "US-style" diet from the FDA.
```{r}

p2 <- ggplot(data = food_feed_data_scenario %>% 
         dplyr::filter(SCENARIO != "FAOSTAT", 
                       crop_class == "food"), 
       aes(x = year, 
           y = tonnes_yr)) + 
  geom_line(aes(colour = diet_plan)) + 
  geom_point(data = food_feed_data_scenario %>% 
         dplyr::filter(SCENARIO == "FAOSTAT", 
                       crop_class == "food") %>% 
           dplyr::select(-SCENARIO), 
         aes(x = year, 
             y = tonnes_yr), 
         size = 0.5, 
         shape = 3) + 
  facet_wrap(~SCENARIO)

p2

```

Transform diets by 2050 and by 2075, for each SSP.

Transform by 2050. Interpolate lowest acceleration pathway for each food/feed type to its target value.

1. Linearly extrapolate data values from 2014-18 to 2022.
2. Find the lowest-energy trajectory from 2022 to the target year, 2050 or 2075. The lowest energy should have the constraints: (i) lowest second derivative wrt time; (ii) first derivative that equals the slope of the line at 2022; (iii) passes through the appropriate values at 2022 and 2050. A spline should be appropriate.

Recode country names and merge with regions.
```{r}
Food_countries <- food_countries %>% 
  dplyr::rename(fao_countrycode = area_code) %>% 
  dplyr::select(-area) %>% 
  dplyr::left_join(loc_map_reduced, by = "fao_countrycode")
```

Do some cleanup first because some ISOa3 codes are not included.
```{r}
food_2014_2018_data <- Food_countries %>%
  dplyr::select(year, model_group, tonnes_yr, iso_alpha3) %>%
  tidyr::drop_na()
```

Fit linear models to data and predict to extrapolate to 2022.
```{r}
yrs <- data.frame(year = seq(2019, 2022, by = 1))

food_2019_2022_lm <- food_2014_2018_data %>%
  dplyr::group_by(iso_alpha3, model_group) %>%
  tidyr::nest() %>%
  dplyr::mutate(models = lapply(data, function(df) lm(tonnes_yr ~ year, data = df))) %>% 
  dplyr::mutate(lm_pred = map(models, ~predict(., yrs))) %>% 
  # dplyr::mutate(lm_pred = map(models, ~predict(., yrs))) %>%
  dplyr::ungroup() %>% 
  tidyr::unnest(cols = c(lm_pred)) %>% 
  dplyr::select(iso_alpha3, model_group, lm_pred) %>% 
  dplyr::mutate(year = rep(seq(2019, 2022, by = 1), 2212)) %>% 
  dplyr::rename(tonnes_yr = lm_pred)
 
```

```{r}
food_2014_2022_est <- food_2014_2018_data %>% 
  bind_rows(food_2019_2022_lm)
```

Use crop weight of food and crop ingredient weight of feed from earlier. We will only use the data for years 2023 and after.
```{r}
# save(food_weight, file = paste0(data_path, "food_weight.R"))
load(file = paste0(data_path, "food_weight.R")) #food_weight

# save(feed_ingredient_demand_summary, file = paste0(data_path, "feed_ingredient_demand_summary.R"))
load(file = paste0(data_path, "feed_ingredient_demand_summary.R")) #feed_ingredient_demand_summary

```


```{r}
food_proj <- food_weight %>%
  dplyr::mutate(tonnes_yr = tonnes_day_food * 365) %>%
  dplyr::select(SCENARIO,
                iso_alpha3,
                subregionname,
                diet_plan,
                year,
                model_group,
                tonnes_yr) %>%
  dplyr::bind_rows(
    live_food_weight %>%
      dplyr::mutate(tonnes_yr = tonnes_day_food * 365) %>%
      dplyr::select(
        SCENARIO,
        iso_alpha3,
        subregionname,
        diet_plan,
        year,
        model_group,
        tonnes_yr
      )
  ) %>%
  dplyr::mutate(scenario = ifelse(
    SCENARIO == "SSP1_v9_130115",
    "SSP1",
    ifelse(
      SCENARIO == "SSP2_v9_130115",
      "SSP2",
      ifelse(
        SCENARIO == "SSP3_v9_130115",
        "SSP3",
        ifelse(SCENARIO == "SSP4d_v9_130115",
               "SSP4",
               "SSP5")
      )
    )
  )) %>% 
  dplyr::select(-SCENARIO) %>% 
  dplyr::filter(year > 2022)

feed_proj <- feed_ingredient_demand_summary %>% 
  dplyr::mutate(tonnes_yr = tonnes_day*365) %>% 
  dplyr::select(-tonnes_day) %>%
  dplyr::mutate(scenario = ifelse(
    SCENARIO == "SSP1_v9_130115",
    "SSP1",
    ifelse(
      SCENARIO == "SSP2_v9_130115",
      "SSP2",
      ifelse(
        SCENARIO == "SSP3_v9_130115",
        "SSP3",
        ifelse(SCENARIO == "SSP4d_v9_130115",
               "SSP4",
               "SSP5")
      )
    )
  )) %>% 
  dplyr::select(-SCENARIO) %>% 
  dplyr::filter(year > 2022)

# food_proj
# feed_proj
```

Confirm continuity between ISO codes so countries represented in 2022 are there in 2023, etc. Fill dummy values in for scenario and diet_plan for the FAO data. These are required for continuity in the spline fitter.
```{r}
years_tmp <- food_2014_2022_est %>% distinct(year) %>% pull(year)
countries_tmp <- food_2014_2022_est %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
model_groups_tmp <- food_2014_2022_est %>% distinct(model_group) %>% pull(model_group)
diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")


empty_set <- expand.grid(years_tmp, countries_tmp, model_groups_tmp, diet_plans_tmp, scenarios_tmp)
names(empty_set) <- c("year", "iso_alpha3", "model_group", "diet_plan", "scenario")

```

Fill NA values with a small value of 0.1 tonnes so the spline fitter has tie points
```{r}
food_2014_2022_est_tmp <- food_2014_2022_est %>%
  full_join(empty_set, by = c("year", "model_group", "iso_alpha3")) %>%
  mutate(tonnes_yr = ifelse(is.na(tonnes_yr), 1000, tonnes_yr))

```

Do the same for `pathways` data frame representing values between 2023 and the target year to be filled by the spline values.
```{r}
years_tmp <- seq(2023, 2049, by = 1)
countries_tmp <- food_2014_2022_est %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
model_groups_tmp <- food_2014_2022_est %>% distinct(model_group) %>% pull(model_group)
diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")
tonnes_yr_tmp <- NA

pathways_tmp <- expand.grid(years_tmp, countries_tmp, model_groups_tmp, diet_plans_tmp, scenarios_tmp, tonnes_yr_tmp)
names(pathways_tmp) <- c("year", "iso_alpha3", "model_group", "diet_plan", "scenario", "tonnes_yr")
```

Merge the FAO-derived data with the empty pathways data frame.
```{r}
data_pathways <- food_2014_2022_est_tmp %>% 
  full_join(pathways_tmp, by = c("year", "model_group", "tonnes_yr", "iso_alpha3", "diet_plan", "scenario"))

head(data_pathways)
```

And the same for `targets`, the data frame for values at and above the target year.
```{r}
years_tmp <- seq(2050, 2075, by = 5)
countries_tmp <- food_2014_2022_est %>% distinct(iso_alpha3) %>% pull(iso_alpha3)
model_groups_tmp <- food_2014_2022_est %>% distinct(model_group) %>% pull(model_group)
diet_plans_tmp <- c("CNS-CFP", "ELA-PHD",  "FDA-SDP")
scenarios_tmp <- c("SSP1", "SSP2", "SSP3", "SSP4", "SSP5")
tonnes_yr_tmp <- NA

targets_tmp <- expand.grid(years_tmp, countries_tmp, model_groups_tmp, diet_plans_tmp, scenarios_tmp, tonnes_yr_tmp)
names(targets_tmp) <- c("year", "iso_alpha3", "model_group", "diet_plan", "scenario", "tonnes_yr")
```

```{r}
targets <- food_proj %>% 
  dplyr::filter(year >= 2050, year <= 2075) %>% 
  dplyr::full_join(targets_tmp, by = c("iso_alpha3", "diet_plan", "year", "model_group", "tonnes_yr", "scenario")) %>% 
  dplyr::mutate(tonnes_yr = ifelse(is.na(tonnes_yr), 1000, tonnes_yr)) %>% 
  dplyr::filter(!is.na(subregionname)) %>% 
  dplyr::select(-subregionname)
  

head(targets)
```


Confirm that all countries represented in `data_pathways` are represented in `targets`. For the spline interpolation to work, there must be tie points for all countries, diet_plans, and scenarios at 2022 and 2050.
```{r}
data_countries <- data_pathways %>% dplyr::distinct(iso_alpha3) %>% dplyr::pull(iso_alpha3)
targ_countries <- targets %>% dplyr::distinct(iso_alpha3) %>% dplyr::pull(iso_alpha3)

shared_countries <- intersect(data_countries, targ_countries)

food_2014_2022_est_clean <- data_pathways %>% 
  dplyr::filter(iso_alpha3 %in% shared_countries)
targets_clean <- targets %>% 
  dplyr::filter(iso_alpha3 %in% shared_countries)

```


```{r}

harmonized_data_targets <- food_2014_2022_est_clean %>%
  dplyr::full_join(targets_clean, by = c("year", "model_group", "tonnes_yr", "iso_alpha3", "diet_plan", "scenario")) %>% 
  dplyr::arrange(year)
# %>% 
  # dplyr::full_join(data.frame(model_group = c(
  #     "beef_lamb_pork",
  #     "cereals",
  #     "chicken_poultry",
  #     "dairy",
  #     "eggs",
  #     "fish_seafood",
  #     "fruits",
  #     "legumes",
  #     "oils",
  #     "roots_tubers",
  #     "sugarcrops",
  #     "treenuts",
  #     "vegetables"
  #   )), by = "model_group")

# %>% 
#   dplyr::filter(!iso_alpha3 %in% c("ABW", "BDI", "BHR", "BRN", "BTN", "CIV", "COD", "COM", "ERI", "FSM", "GLP", "GNQ", "GUF", "GUM", "LBY", "MTQ", "MYT", "PRI", "PRK", "PSE", "QAT", "REU", "SGP", "SOM", "SYR", "TON", "VIR")) %>% 
#   dplyr::filter(!iso_alpha3 %in% c("AFG", "AGO", "ALB", "ARE", "ARG", "ARM", "AUS", "AUT", "AZE", "BEL", "BEN", "BFA", "BGD", "BGR", "BHS", "BIH", "BLR", "BLZ", "BOL", "BRA", "BRB", "BWA", "CAF"))

# harmonized_data_targets

```

Interpolate transformation pathways between the FAO food balance data (and linearly interpolated values to 2022 based on the FAO data) and target year values using a spline with all values as tie-points.
```{r}

food_pathways_tmp <- harmonized_data_targets %>%
  group_by(model_group, scenario, diet_plan, iso_alpha3) %>%
  mutate(tonnes_yr_interp = spline(
    x = year,
    y = tonnes_yr,
    xout = year,
    ties = "ordered"
  )$y,) %>%
  ungroup()

food_pathways <- food_pathways_tmp %>%
  dplyr::select(-tonnes_yr) %>%
  dplyr::rename(tonnes_yr = tonnes_yr_interp)

```

To visualise these data, I will aggregate food types into animal products, plant products and fish-seafood.
```{r}
food_pathways_agg <- food_pathways %>% 
  dplyr::mutate(food_group = ifelse(model_group %in% c("beef_lamb_pork", "chicken_poultry", "dairy", "eggs"), 
                                    "animal products", 
                                    ifelse(model_group %in% c("fish_seafood"), 
                                           "fish & seafood", 
                                           "plant products"))) %>% 
  dplyr::group_by(year, iso_alpha3, diet_plan, scenario, food_group) %>% 
  dplyr::summarise(tonnes_yr = sum(tonnes_yr, na.rm = "TRUE"), 
                   .groups = "drop")
```

```{r}
p3 <- ggplot(food_pathways_agg %>% 
         filter(iso_alpha3 == "CHN", 
                diet_plan == "ELA-PHD"), aes(x = year)) + 
  geom_area(aes(y = 1e-9*tonnes_yr, 
                fill = food_group)) + 
  geom_vline(xintercept = 2050, alpha = 0.5, size = 2) + 
  theme_minimal() + 
  theme(
    legend.position = "top", 
    legend.title = element_blank()
  ) + 
  labs(
    x = "year", 
    y = "Gt/yr"
  ) + 
  facet_wrap(~scenario)

p3
```



```{r}
library(magrittr)
ds <- readr::read_csv("trt,depth,root,carbon\nA,2,1,14\nA,4,2,18\nA,6,3,18\nA,8,3,17\nA,10,1,12\nB,2,3,16\nB,4,4,18\nB,6,4,17\nB,8,2,15\nB,10,1,12")

ds_depths_possible <- expand.grid(
  depth            = seq(from=min(ds$depth), max(ds$depth), by=.5), #Decide resolution here.
  trt              = c("A", "B"),
  stringsAsFactors = FALSE
  )
tmp <- ds %>% 
  dplyr::right_join(ds_depths_possible, by=c("trt", "depth")) 
tmp
```

```{r}
ds_intpolated <- ds %>% 
  dplyr::right_join(ds_depths_possible, by=c("trt", "depth")) %>% #Incorporate locations to interpolate
  dplyr::group_by(trt) %>% 
  dplyr::mutate(
    root_interpolated     = spline(x=depth, y=root  , xout=depth)$y,
    carbon_interpolated   = spline(x=depth, y=carbon, xout=depth)$y
  ) %>% 
  dplyr::ungroup()
ds_intpolated
```


Find where projections of modeled diet food values are in 2050.
```{r}
food_est <- global_crop_demand_food_feed %>%
  dplyr::mutate(scenario = ifelse(
    SCENARIO == "SSP1_v9_130115",
    "SSP1",
    ifelse(
      SCENARIO == "SSP2_v9_130115",
      "SSP2",
      ifelse(
        SCENARIO == "SSP3_v9_130115",
        "SSP3",
        ifelse(
          SCENARIO == "SSP4d_v9_130115",
          "SSP4",
          "SSP5"
        )
      )
    )
  )) %>%
  dplyr::filter(year == 2050, crop_class == "food")
```

```{r}
food_est %>% 
  dplyr::select(-SCENARIO, tonnes_day, -crop_class)
# %>% 
#   dplyr::bind_rows(food_2014_2022_est_tmp)

```

